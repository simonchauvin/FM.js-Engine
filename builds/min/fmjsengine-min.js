var FM=FM||{};FM.assetManager={assets:[],loadingProgress:0,addAsset:function(a,c,f){var d=FM.assetManager,g=FM.parameters,b=d.getAssetByName(a),e;if(c===g.IMAGE){if(!b){d.assets.push(FM.imageAsset(a,f))}}else{if(c===g.AUDIO){if(!b){e=FM.audioAsset(a,f);if(e.isSupported()){d.assets.push(e)}else{if(FM.parameters.debug){console.log("ERROR: The "+f.substring(f.lastIndexOf(".")+1)+" audio format is not supported by this browser.");return false}}}}else{if(c===g.FILE){if(!b){d.assets.push(FM.fileAsset(a,f))}}}}return true},loadAssets:function(){var a,b=FM.assetManager;for(a=0;a<b.assets.length;a=a+1){b.assets[a].load()}},assetLoaded:function(){var a=FM.assetManager;a.loadingProgress+=100/a.assets.length},areAllAssetsLoaded:function(){return Math.round(FM.assetManager.loadingProgress)>=100},getAssetByName:function(a){var c=null,b=0,d=FM.assetManager;for(b=0;b<d.assets.length;b=b+1){if(d.assets[b].getName()===a){c=d.assets[b]}}return c}};FM.parameters={FPS:60,libFolder:"lib",debug:false,COLLIDER_MINIMUM_SIZE:16,STATIC:"static",KINEMATIC:"kinematic",DYNAMIC:"dynamic",PIXELS_TO_METERS:30,IMAGE:"image",AUDIO:"audio",FILE:"file",LEFT:"left",RIGHT:"right",UP:"up",DOWN:"down",backgroundColor:"rgb(0,0,0)"};FM.componentTypes={SPATIAL:"spatial",PATHFINDING:"pathfinding",RENDERER:"renderer",PHYSIC:"physic",SOUND:"sound",FX:"fx"};FM.circle=function(b,a,d){var c={};c.x=b;c.y=a;c.radius=d;c.destroy=function(){c=null};return c};FM.game=(function(){var n={},H="",z=0,D=0,G=null,e="",d=null,j=null,a=null,F=0,v=0,m=1/FM.parameters.FPS,B=FM.parameters.FPS,b=FM.parameters.FPS,C=(new Date()).getTime()/1000,h=0,q=[],c=[],t=false,l=false,y=false,p=0,o=0,k=false,A=false,r=function(){d.clearRect(0,0,z,D);d.fillStyle=FM.parameters.backgroundColor;d.fillRect(0,0,z,D);var J=(new Date()).getTime()/1000,I=J-C,K=0;if(I>0.25){I=0.25}C=J;h+=I;if(!k){while(h>=m){h-=m;G.updatePhysics(m)}K=h/m;G.update(I)}v+=I;F=F+1;if(v>=1){b=F/v;F=0;v=0}B=Math.round(b);G.draw(a,K);if(k){a.fillStyle="rgba(99,99,99,0.5)";a.fillRect(0,0,z,D);a.fillStyle="rgba(255,255,255,1)";a.beginPath();a.moveTo(z/2+60,D/2);a.lineTo(z/2-60,D/2-60);a.lineTo(z/2-60,D/2+60);a.lineTo(z/2+60,D/2);a.fill();a.closePath()}if(FM.parameters.debug){if(n.isKeyReleased(FM.keyboard.HOME)){if(!A){A=true}else{A=false}}if(A){a.fillStyle="#fcd116";a.font="30px sans-serif";a.textBaseline="middle";a.fillText(B,10,20)}}d.drawImage(j,0,0);t=false;c=[];requestAnimationFrame(r)},s=function(I){q[I.keyCode]=1},w=function(J){var I=J.keyCode;c[I]=1;delete q[I]},u=function(I){p=I.clientX-I.target.offsetLeft;o=I.clientY-I.target.offsetTop},i=function(I){t=true},x=function(I){l=true;y=false},g=function(I){y=true;l=false},f=function(I){k=false},E=function(I){k=true};n.run=function(J,L,I,N,K,M){H=L;z=I;D=N;e=document.getElementById(J);if(M){G=M(K)}else{G=FM.preloader(K)}if(e&&e.getContext){d=e.getContext("2d");if(d){e.width=z;e.height=D;j=document.createElement("canvas");j.width=z;j.height=D;a=j.getContext("2d");a.xOffset=0;a.yOffset=0}}if(d&&a){e.onkeydown=function(O){s(O)};e.onkeyup=function(O){w(O)};e.onclick=function(O){i(O)};e.onmousedown=function(O){x(O)};e.onmouseup=function(O){g(O)};e.onmousemove=function(O){u(O)};e.onfocus=function(O){f(O)};e.onblur=function(O){E(O)};e.focus();G.init(n);requestAnimationFrame(r)}};(function(){var I,J=0,K=["ms","moz","webkit","o"];for(I=0;I<K.length&&!window.requestAnimationFrame;++I){window.requestAnimationFrame=window[K[I]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[K[I]+"CancelAnimationFrame"]||window[K[I]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(P,M){var L=new Date().getTime(),N=Math.max(0,16-(L-J)),O=window.setTimeout(function(){P(L+N)},N);J=L+N;return O}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(L){clearTimeout(L)}}}());n.switchState=function(I){G.destroy();G=I;G.init(n)};n.isKeyPressed=function(I){if(q[I]){return true}else{return false}};n.isKeyReleased=function(I){if(c[I]){return true}else{return false}};n.isMouseClicked=function(){return t};n.isMousePressed=function(){return l};n.isMouseReleased=function(){return y};n.isDebugActivated=function(){return A};n.getName=function(){return H};n.getMouseX=function(){return p+G.camera.x};n.getMouseY=function(){return o+G.camera.y};n.getMouseScreenX=function(){return p};n.getMouseScreenY=function(){return o};n.getScreenWidth=function(){return z};n.getScreenHeight=function(){return D};n.getCurrentState=function(){return G};return n}());FM.gameObject=function(e){var d={},g=0,a="",c=true,f=true,b=[];d.scrollFactor=FM.vector(1,1);d.components={};d.zIndex=e;d.addType=function(h){b.push(h)};d.removeType=function(h){b.splice(b.indexOf(h),1)};d.hasType=function(h){return b.indexOf(h)!==-1};d.addComponent=function(i){var h=i.name;if(!d.components[h]){d.components[h]=i}};d.getComponent=function(h){return d.components[h]};d.destroy=function(){a=null;d.scrollFactor=null;var h;for(h=0;h<d.components.length;h=h+1){d.components[h].destroy()}d.components=null;d=null};d.kill=function(){c=false};d.hide=function(){f=false};d.revive=function(){c=true};d.show=function(){f=true};d.getTypes=function(){return b};d.getName=function(){return a};d.setName=function(h){a=h};d.getId=function(){return g};d.setId=function(h){g=h};d.isAlive=function(){return c};d.isVisible=function(){return f};return d};FM.keyboard={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS:20,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DEL:46,ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,lLEFT_SPECIAL:91,RIGHT_SPECIAL:92,SELECT:93,NUM_ZERO:96,NUM_ONE:97,NUM_TWO:98,NUM_THREE:99,NUM_FOUR:100,NUM_FIVE:101,NUM_SIX:102,NUM_SEVEN:103,NUM_EIGHT:104,NUM_NINE:105,MULTIPLY:106,ADD:107,SUBSTRACT:109,DECIMAL_POINT:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,SEMICOLON:186,EQUAL_SIGN:187,COMMA:188,DASH:189,PERIOD:190,FORWARD_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,SINGLE_QUOTE:222};FM.math={addVectors:function(b,a){return FM.vector(b.x+a.x,b.y+a.y)},substractVectors:function(b,a){return FM.vector(b.x-a.x,b.y-a.y)},multiplyVectors:function(b,a){return FM.vector(b.x*a.x,b.y*a.y)},clamp:function(c,b,a){return Math.min(a,Math.max(b,c))},};FM.objectType=function(a){var e={},b=a,d=true,g=true,h=1,f=FM.vector(1,1),c=[];e.overlapsWithType=function(n){var l=FM.game.getCurrentState(),w=l.getQuad(),s=l.members,q,p,o,m,t,k,v,x,r,u=null;for(p=0;p<s.length;p=p+1){k=s[p];x=k.components[FM.componentTypes.PHYSIC];m=k.hasType(e);t=k.hasType(n);if(x&&(m||t)){q=w.retrieve(k);for(o=0;o<q.length;o=o+1){v=q[o];r=v.components[FM.componentTypes.PHYSIC];if(r&&k.getId()!==v.getId()&&((m&&v.hasType(n))||(t&&v.hasType(e)))){u=x.overlapsWithObject(r)}}}}return u};e.overlapsWithObject=function(m){var n=FM.game.getCurrentState().getQuad().retrieve(m),l,j,p=m.components[FM.componentTypes.PHYSIC],k,o=null;if(p){for(l=0;l<n.length;l=l+1){j=n[l];k=j.components[FM.componentTypes.PHYSIC];if(k&&m.getId()!==j.getId()&&j.hasType(e)){o=p.overlapsWithObject(k)}}}else{if(FM.parameters.debug){console.log("WARNING: you need to specify a game object with a physic component for checking overlaps.")}}return o};e.addTypeToCollideWith=function(k){c.push(k);var m=FM.game.getCurrentState().members,l,j,n;for(l=0;l<m.length;l=l+1){j=m[l];n=j.components[FM.componentTypes.PHYSIC];if(n&&j.hasType(e)){n.addTypeToCollideWith(k)}}};e.removeTypeToCollideWith=function(k){c.splice(c.indexOf(k),1);var m=FM.game.getCurrentState().members,l,j,n;for(l=0;l<m.length;l=l+1){j=m[l];n=j.components[FM.componentTypes.PHYSIC];if(n&&j.hasType(e)){n.removeTypeToCollideWith(k)}}};e.setZIndex=function(m){h=m;var l=FM.game.getCurrentState().members,k,j;for(k=0;k<l.length;k=k+1){j=l[k];if(j.hasType(e)){j.zIndex=h}}};e.setScrollFactor=function(l){f=l;var m=FM.game.getCurrentState().members,k,j;for(k=0;k<m.length;k=k+1){j=m[k];if(j.hasType(e)){j.scrollFactor=f}}};e.kill=function(){d=false};e.hide=function(){g=false};e.revive=function(){d=true};e.show=function(){g=true};e.isAlive=function(){return d};e.isVisible=function(){return g};e.destroy=function(){b=null;f=null;c=null;e=null};e.getName=function(){return b};return e};FM.rectangle=function(c,b,a,e){var d={};d.x=c;d.y=b;d.width=a;d.height=e;d.destroy=function(){d=null};return d};FM.state=function(){var d={},f=0,h=0,a=null,g=null,b=null,e=null,c=function(j,i){return(j.zIndex-i.zIndex)};d.members=[];FM.state.lastId=0;d.camera=FM.rectangle(0,0,0,0);d.init=function(j,i){f=FM.game.getScreenWidth();h=FM.game.getScreenHeight();e=FM.world(j||f,i||h);b=FM.quadTree(0,FM.rectangle(0,0,j||f,i||h));d.camera.width=f;d.camera.height=h;if(FM.parameters.debug){console.log("INIT: The state has been created.")}};d.add=function(i){if(i.components){d.members.push(i);i.setId(FM.state.lastId);FM.state.lastId+=1;if(i.components[FM.componentTypes.PHYSIC]){b.insert(i)}}else{if(FM.parameters.debug){console.log("ERROR: you're trying to add something elsethan a game object to the state. This is not allowed.")}}};d.remove=function(i){d.members.splice(d.members.indexOf(i),1);i.destroy()};d.sortByZIndex=function(){d.members.sort(c)};d.updatePhysics=function(k){var l,j,n,m,o;b.clear();for(l=0;l<d.members.length;l=l+1){j=d.members[l];if(j.isAlive()){n=j.components;o=j.components[FM.componentTypes.PHYSIC];if(o){b.insert(j)}}}for(l=0;l<d.members.length;l=l+1){j=d.members[l];if(j.isAlive()){n=j.components;m=n[FM.componentTypes.SPATIAL];o=n[FM.componentTypes.PHYSIC];if(o){o.update(k)}}}};d.update=function(n){var p,l,s,t,w,x,k,r,v,o,m,q,u,j;for(p=0;p<d.members.length;p=p+1){l=d.members[p];if(l.isAlive()){s=l.components;t=s[FM.componentTypes.SPATIAL];w=s[FM.componentTypes.PHYSIC];x=s[FM.componentTypes.PATHFINDING];k=s[FM.componentTypes.FX];if(x){x.update(n)}if(k){k.update(n)}if(w){if(a===l){v=g.width;o=g.height;m=t.position.x+w.offset.x;q=t.position.y+w.offset.y;u=m+w.width;j=q+w.height;if(m<=g.x){r=d.camera.x-(g.x-m);if(r>=0){d.camera.x=r;g.x=m}}if(q<=g.y){r=d.camera.y-(g.y-q);if(r>=0){d.camera.y=r;g.y=q}}if(u>=g.x+v){r=d.camera.x+(u-(g.x+v));if(r+d.camera.width<=e.width){d.camera.x=r;g.x=u-v}}if(j>=g.y+o){r=d.camera.y+(j-(g.y+o));if(r+d.camera.height<=e.height){d.camera.y=r;g.y=j-o}}}}else{if(FM.parameters.debug&&a===l){console.log("ERROR: The scrolling object must have a physic component.")}}if(l.update){l.update(n)}}}};d.draw=function(k,n){k.clearRect(0,0,f,h);k.xOffset=d.camera.x;k.yOffset=d.camera.y;var r,l,o,t,w,v;for(r=0;r<d.members.length;r=r+1){l=d.members[r];if(l.isVisible()||(FM.parameters.debug&&FM.game.isDebugActivated()&&l.isAlive())){t=l.components[FM.componentTypes.SPATIAL];if(t){v=l.components[FM.componentTypes.RENDERER];t.previous.copy(t.position);o=FM.vector(t.position.x*n+t.previous.x*(1-n),t.position.y*n+t.previous.y*(1-n));if(v&&l.isVisible()){var m=o.x,s=o.y,u=m+v.getWidth(),j=s+v.getHeight(),q=0,p=0;q=(d.camera.x+(f-d.camera.width)/2)*l.scrollFactor.x;p=(d.camera.y+(h-d.camera.height)/2)*l.scrollFactor.y;if(u>=q&&j>=p&&m<=q+d.camera.width&&s<=p+d.camera.height){v.draw(k,o)}}if(FM.parameters.debug&&l.isAlive()){if(FM.game.isDebugActivated()){w=l.components[FM.componentTypes.PHYSIC];if(w){w.drawDebug(k,o)}}}}}}if(FM.parameters.debug){if(FM.game.isDebugActivated()){k.strokeStyle="#f0f";k.strokeRect(0-d.camera.x,0-d.camera.y,e.width,e.height);k.strokeStyle="#8fc";k.strokeRect((f-d.camera.width)/2,(h-d.camera.height)/2,d.camera.width,d.camera.height);if(g){k.strokeStyle="#f4f";k.strokeRect(g.x-d.camera.x,g.y-d.camera.y,g.width,g.height)}}}};d.centerCameraOn=function(i){var k=i.components[FM.componentTypes.SPATIAL],j=k.position.x-d.camera.width/2;if(j>e.x&&j<e.width){d.camera.x=j}j=k.position.y-d.camera.height/2;if(j>e.y&&j<e.height){d.camera.y=j}};d.centerCameraAt=function(k,j){var i=k-d.camera.width/2;if(i>e.x&&i<e.width){d.camera.x=i}i=j-d.camera.height/2;if(i>e.y&&i<e.height){d.camera.y=i}};d.follow=function(j,k,i){a=j;g=FM.rectangle((f-k)/2+d.camera.x,(h-i)/2+d.camera.y,k,i)};d.unFollow=function(){g=null;a=null};d.destroy=function(){var j;for(j=0;j<d.members.length;j=j+1){d.members[j].destroy()}d.members=null;a=null;if(g){g.destroy()}g=null;d.camera.destroy();d.camera=null;e.destroy();e=null;b.clear();b=null;d=null};d.getGameObjectById=function(l){var j,k;for(k=0;k<d.members.length;k=k+1){j=d.members[k];if(j.getId()===l){return j}}return null};d.getScroller=function(){return a};d.getWorld=function(){return e};d.getQuad=function(){return b};return d};FM.tileMap=function(o,m,b,q,d,i,c,g){var e={},r=[],p=o,n=m,k=b,a=q,f=d,j=i,l=c,h=g;e.load=function(s){var G=s.split("\n"),F=null,E=null,w=null,z=null,C=null,t=FM.game.getCurrentState(),A,D,B,v,y,x,u;for(y=0;y<G.length;y=y+1){F=G[y];if(F){E=[];w=F.split(",",n);for(x=0;x<w.length;x=x+1){z=parseInt(w[x]);if(z>0){C=FM.gameObject(l);for(u=0;u<i.length;u=u+1){C.addType(i[u])}A=FM.spatialComponent(x*a,y*f,C);D=FM.spriteRendererComponent(p,a,f,C);B=z*a;v=Math.floor(B/p.width)*f;if(B>=p.width){v=Math.floor(B/p.width)*f;B=(B%p.width)}D.setOffset(B,v);t.add(C);E.push(C.getId())}else{E.push(-1)}}r.push(E)}}};e.allowCollisions=function(){h=true};e.preventCollisions=function(){h=false};e.destroy=function(){r=null;p=null;e=null};e.canCollide=function(){return h};e.hasType=function(s){return j.indexOf(s)!==-1};e.getData=function(){return r};e.getTileSet=function(){return p};e.getTileId=function(s,t){return r[Math.floor(t/f)][Math.floor(s/a)]};e.getWidth=function(){return n};e.getHeight=function(){return k};e.getTileWidth=function(){return a};e.getTileHeight=function(){return f};e.getZIndex=function(){return l};return e};FM.vector=function(b,a){var c={};c.x=b==="undefined"?0:b;c.y=a==="undefined"?0:a;c.add=function(d){c.x+=d.x;c.y+=d.y;return c};c.substract=function(d){c.x-=d.x;c.y-=d.y;return c};c.multiply=function(d){c.x*=d.x;c.y*=d.y;return c};c.dotProduct=function(d){return(c.x*d.x+c.y*d.y)};c.crossProd=function(d){return c.x*d.y-c.y*d.x};c.reset=function(e,d){c.x=typeof e==="undefined"?0:e;c.y=typeof d==="undefined"?0:d;return c};c.getLength=function(){return Math.sqrt((c.x*c.x)+(c.y*c.y))};c.getLengthSquared=function(){return(c.x*c.x)+(c.y*c.y)};c.normalize=function(){var d=c.getLength();c.x=c.x/d;c.y=c.y/d};c.copy=function(d){c.x=d.x;c.y=d.y;return c};c.clone=function(){return new FM.vector(c.x,c.y)};c.isEquals=function(d){return(c.x===d.x&&c.y===d.y)};c.destroy=function(){c=null};return c};FM.world=function(a,d){var c=FM.rectangle(0,0,a,d),b=[];c.loadTileMap=function(e,h,f,g){e.load(h.getLayer(f).toCsv(h.getTileSet(g)));b.push(e)};c.getTileMapFromType=function(f){var g,e;for(g=0;g<b.length;g=g+1){e=b[g];if(e.hasType(f)){return e}}return null};c.hasTileCollisions=function(){var e;for(e=0;e<b.length;e=e+1){if(b[e].canCollide()){return true}}return false};c.destroy=function(){c=null};return c};FM.collision=function(a,c){var b={};b.a=a==="undefined"?null:a;b.b=c==="undefined"?null:c;b.penetration=0;b.normal=null;b.destroy=function(){b.normal=null;b=null};return b};FM.component=function(c,a){var b={};if(a){if(a.components!==undefined){b.name=c;b.owner=a}else{if(FM.parameters.debug){console.log("ERROR: the owner of the "+c+" component must be a gameObject.")}}}else{if(FM.parameters.debug){console.log("ERROR: a owner game object must be specified.")}}b.destroy=function(){b.name=null;b.owner=null;b=null};return b};FM.audioAsset=function(a,f){var e=new Audio(),d=a,g=f,h=g.substring(g.lastIndexOf(".")+1),c=false,b=function(){c=true;FM.assetManager.assetLoaded()};e.load=function(){e.src=g;e.addEventListener("loadeddata",b,false)};e.isLoaded=function(){return c};e.destroy=function(){d=null;g=null;e=null};e.getName=function(){return d};e.getPath=function(){return g};e.isSupported=function(){var i=false;if(h==="wav"){i=!!e.canPlayType&&e.canPlayType('audio/wav; codecs="1"')!==""}else{if(h==="ogg"){i=!!e.canPlayType&&e.canPlayType('audio/ogg; codecs="vorbis"')!==""}else{if(h==="mp3"){i=!!e.canPlayType&&e.canPlayType("audio/mpeg;")!==""}else{if(h==="aac"){i=!!e.canPlayType&&e.canPlayType('audio/mp4; codecs="mp4a.40.2"')!==""}}}}return i};return e};FM.fileAsset=function(a,g){var f=new XMLHttpRequest(),d=a,h=g,e=null,c=false,b=function(){c=true;e=f.responseText;FM.assetManager.assetLoaded()};f.load=function(){f.addEventListener("load",b,false);f.open("GET",h,false);f.send()};f.isLoaded=function(){return c};f.destroy=function(){d=null;h=null;e=null;f=null};f.getName=function(){return d};f.getPath=function(){return h};f.getContent=function(){return e};return f};FM.imageAsset=function(a,f){var e=new Image(),d=a,g=f,c=false,b=function(){c=true;FM.assetManager.assetLoaded()};e.load=function(){e.src=g;e.addEventListener("load",b,false)};e.isLoaded=function(){return c};e.destroy=function(){d=null;g=null;e=null};e.getName=function(){return d};e.getPath=function(){return g};return e};FM.preloader=function(a){var b=Object.create(FM.state()),c,d;b.init=function(){Object.getPrototypeOf(b).init();c=FM.game.getScreenWidth();d=FM.game.getScreenHeight()};b.update=function(f){Object.getPrototypeOf(b).update(f);var e=FM.assetManager;if(e.assets.length===0||e.areAllAssetsLoaded()){FM.game.switchState(a())}};b.draw=function(e,f){Object.getPrototypeOf(b).draw(e,f);e.fillStyle="#fff";e.font="30px sans-serif";e.textBaseline="middle";e.fillText(Math.ceil(FM.assetManager.loadingProgress)+"%",c/2,d/2)};return b};FM.quadTree=function(f,k){var g={},j=10,e=5,c=f,i=[],a=k,b=[],d=function(l){var m=-1,p=l.components[FM.componentTypes.SPATIAL],s=l.components[FM.componentTypes.PHYSIC],o=a.x+(a.width/2),q=a.y+(a.height/2),n=(p.position.y<q&&p.position.y+s.height<q),r=(p.position.y>q);if(p.position.x<o&&p.position.x+s.width<o){if(n){m=1}else{if(r){m=2}}}else{if(p.position.x>o){if(n){m=0}else{if(r){m=3}}}}return m},h=function(){var m=a.width/2,n=a.height/2,l=a.x,o=a.y;b.push(FM.quadTree(c+1,FM.rectangle(l+m,o,m,n)));b.push(FM.quadTree(c+1,FM.rectangle(l,o,m,n)));b.push(FM.quadTree(c+1,FM.rectangle(l,o+n,m,n)));b.push(FM.quadTree(c+1,FM.rectangle(l+m,o+n,m,n)))};g.insert=function(l){if(b.length>0){var m=d(l);if(m!==-1){b[m].insert(l);return}}i.push(l);if(i.length>j&&c<e){if(b.length===0){h()}var n=0,m;while(n<i.length){m=d(i[n]);if(m!==-1){b[m].insert(i.splice(n,1)[0])}else{n=n+1}}}};g.retrieve=function(l){var o=[];var m=d(l);if(m!==-1&&b.length>0){o=b[m].retrieve(l)}var n;for(n=0;n<i.length;n=n+1){o.push(i[n])}return o};g.clear=function(){i=[];var l;for(l=0;l<b.length;l=l+1){if(b[l]){b[l].clear();b[l]=null}}b=[]};return g};if(typeof Object.create!=="function"){Object.create=function(b){function a(){}a.prototype=b;return new a()}}if(typeof Object.getPrototypeOf!=="function"){if(typeof"test".__proto__==="object"){Object.getPrototypeOf=function(a){return a.__proto__}}else{Object.getPrototypeOf=function(a){return a.constructor.prototype}}}FM.includeJsFile=function(b){var c=document.getElementsByTagName("head")[0],a=document.createElement("script");a=document.createElement("script");a.src=b;a.type="text/javascript";c.appendChild(a)};FM.tmxLayer=function(){var a={};a.map;a.name;a.x;a.y;a.width;a.height;a.opacity;a.visible;a.tileGids=[];a.properties=null;a.load=function(j,l){a.map=l;a.name=j.getAttribute("name");a.x=parseInt(j.getAttribute("x"));a.y=parseInt(j.getAttribute("y"));a.width=parseInt(j.getAttribute("width"));a.height=parseInt(j.getAttribute("height"));a.visible=!j.getAttribute("visible")||(j.getAttribute("visible")!==0);a.opacity=parseInt(j.getAttribute("opacity"));var h=j.getElementsByTagName("properties")[0],c=j.getElementsByTagName("data")[0],n=c.getElementsByTagName("tile"),m,g,d;if(h){for(d=0;d<h.childNodes.length;d++){if(h.hasChildNodes()===true){m=h.childNodes[d];if(m.nodeType===1){if(a.properties){a.properties.add(m)}else{a.properties=FM.tmxPropertySet();a.properties.add(m)}}}}}if(c){var k="",f=a.width,b=-1,e;if(!c.getAttribute("encoding")||(c.getAttribute("encoding")&&c.getAttribute("encoding").length===0)){for(d=0;d<n.length;d=d+1){g=n[d];if(++f>=a.width){a.tileGids[++b]=[];f=0}e=g.getAttribute("gid");a.tileGids[b].push(e)}}else{if(c.getAttribute("encoding")==="csv"){k=c.childNodes[0].nodeValue;a.tileGids=a.csvToArray(k,a.width)}else{if(c.getAttribute("encoding")==="base64"){console.log("ERROR: TmxLoader, use XML or CSV export.")}}}}};a.toCsv=function(c){var g=16777215,e=0,l="",k=null,h="",b=0,f,d;if(c){e=c.firstGID;g=c.numTiles-1}for(f=0;f<a.tileGids.length;f=f+1){k=a.tileGids[f];h="";b=0;for(d=0;d<k.length;d=d+1){b=k[d];b-=e;if(b<0||b>g){b=0}l+=h;h=b+","}l+=b+"\n"}return l};a.csvToArray=function(f,e){var l=[],k=f.split("\n"),h=null,g=null,d=null,c,b;for(c=0;c<k.length;c=c+1){h=k[c];if(h){g=[];d=h.split(",",e);for(b=0;b<d.length;b=b+1){g.push(d[b])}l.push(g)}}return l};return a};FM.tmxMap=function(){var a={},b=null;a.version="unknown";a.orientation="orthogonal";a.width=0;a.height=0;a.tileWidth=0;a.tileHeight=0;a.properties=null;a.layers=[];a.tileSets=[];a.objectGroups=[];a.load=function(c){var o,d;if(window.DOMParser){d=new DOMParser();o=d.parseFromString(c,"text/xml")}else{o=new ActiveXObject("Microsoft.XMLDOM");o.async=false;o.loadXML(c)}b=o.getElementsByTagName("map")[0];a.version=b.getAttribute("version")||"unknown";a.orientation=b.getAttribute("orientation")||"orthogonal";a.width=parseInt(b.getAttribute("width"));a.height=parseInt(b.getAttribute("height"));a.tileWidth=parseInt(b.getAttribute("tilewidth"));a.tileHeight=parseInt(b.getAttribute("tileheight"));var l=b.getElementsByTagName("properties")[0],k=b.getElementsByTagName("tileset"),g=b.getElementsByTagName("layer"),h=b.getElementsByTagName("objectgroup"),m,e,j,n,f;if(l){for(f=0;f<l.childNodes.length;f++){if(l.hasChildNodes()===true){m=l.childNodes[f];if(m.nodeType===1){if(a.properties){a.properties.add(m)}else{a.properties=FM.tmxPropertySet();a.properties.add(m)}}}}}if(k){for(f=0;f<k.length;f++){e=k[f];a.tileSets[e.getAttribute("name")]=FM.tmxTileSet();a.tileSets[e.getAttribute("name")].load(e,a)}}if(g){for(f=0;f<g.length;f++){j=g[f];a.layers[j.getAttribute("name")]=FM.tmxLayer();a.layers[j.getAttribute("name")].load(j,a)}}if(h){for(f=0;f<h.length;f++){n=h[f];a.objectGroups[n.getAttribute("name")]=FM.tmxObjectGroup();a.objectGroups[n.getAttribute("name")].load(n,a)}}};a.getTileSet=function(c){return a.tileSets[c]};a.getLayer=function(c){return a.layers[c]};a.getObjectGroup=function(c){return a.objectGroups[c]};a.getGidOwner=function(d){var e=null;for(var c in a.tileSets){if(c.hasGid(d)){return c}}return null};return a};FM.tmxObject=function(a,e){var f={};f.group=e;f.name=a.getAttribute("name");f.type=a.getAttribute("type");f.x=parseInt(a.getAttribute("x"));f.y=parseInt(a.getAttribute("y"));f.width=parseInt(a.getAttribute("width"));f.height=parseInt(a.getAttribute("height"));f.shared=null;f.gid=-1;if(a.getAttribute("gid")&&a.getAttribute("gid").length!==0){f.gid=parseInt(a.getAttribute("gid"));var h=f.group.map.tileSets,d,c;if(h){for(c=0;c<h.length;c=c+1){d=h[c];f.shared=d.getPropertiesByGid(f.gid);if(f.shared){break}}}}var b=a.getElementsByTagName("properties")[0],g,c;if(b){for(c=0;c<b.childNodes.length;c=c+1){if(b.hasChildNodes()===true){g=b.childNodes[c];if(g.nodeType===1){if(f.custom){f.custom.add(g)}else{f.custom=FM.tmxPropertySet();f.custom.add(g)}}}}}return f};FM.tmxObjectGroup=function(){var a={};a.map;a.name;a.x;a.y;a.width;a.height;a.opacity;a.visible;a.properties=null;a.objects=[];a.load=function(h,e){a.map=e;a.name=h.getAttribute("name");a.x=parseInt(h.getAttribute("x"));a.y=parseInt(h.getAttribute("y"));a.width=parseInt(h.getAttribute("width"));a.height=parseInt(h.getAttribute("height"));a.visible=!h.getAttribute("visible")||(h.getAttribute("visible")!==0);a.opacity=parseInt(h.getAttribute("opacity"));var d=h.getElementsByTagName("properties")[0],g=h.getElementsByTagName("object"),f,b,c;if(d){for(c=0;c<d.childNodes.length;c=c+1){if(d.hasChildNodes()===true){f=d.childNodes[c];if(f.nodeType===1){if(a.properties){a.properties.add(f)}else{a.properties=FM.tmxPropertySet();a.properties.add(f)}}}}}if(g){for(c=0;c<g.length;c=c+1){b=g[c];a.objects.push(FM.tmxObject(b,a))}}};return a};FM.tmxPropertySet=function(){var a=[];a.add=function(c){var b=c.getAttribute("name"),d=c.getAttribute("value");a[b]=d};return a};FM.tmxTileSet=function(){var b={},a=[],c=null;b.firstGID=0;b.map;b.name;b.tileWidth;b.tileHeight;b.spacing;b.margin;b.imageSource;b.numTiles=16777215;b.numRows=1;b.numCols=1;b.load=function(m,h){b.map=h;b.firstGID=parseInt(m.getAttribute("firstgid"));b.imageSource=m.getElementsByTagName("image")[0].getAttribute("source");b.name=m.getAttribute("name");b.tileWidth=parseInt(m.getAttribute("tilewidth"));b.tileHeight=parseInt(m.getAttribute("tileheight"));b.spacing=parseInt(m.getAttribute("spacing"));b.margin=parseInt(m.getAttribute("margin"));var d=m.getElementsByTagName("tile"),k,g,l,f,e;if(d){for(f=0;f<d.length;f++){k=d[f];g=k.getElementsByTagName("properties")[0];if(g){for(e=0;e<g.childNodes.length;e++){if(g.hasChildNodes()===true){l=g.childNodes[e];if(l.nodeType===1){a[k.getAttribute("id")]=FM.tmxPropertySet();a[k.getAttribute("id")].add(l)}}}}}}};b.getImage=function(){return c};b.setImage=function(d){c=d;b.numCols=Math.floor(c.width/b.tileWidth);b.numRows=Math.floor(c.height/b.tileHeight);b.numTiles=b.numRows*b.numCols};b.hasGid=function(d){return(d>=b.firstGID)&&(d<b.firstGID+b.numTiles)};b.fromGid=function(d){return d-b.firstGID};b.toGid=function(d){return b.firstGID+d};b.getPropertiesByGid=function(d){return a[d-b.firstGID]};b.getProperties=function(d){return a[d]};b.getRect=function(d){return new FM.rectangle(0,0,(d%b.numCols)*b.tileWidth,(d/b.numCols)*b.tileHeight)};return b};FM.emitterComponent=function(h,d){var l=FM.component(FM.componentTypes.FX,d),q=[],i=h,m=[FM.parameters.LEFT,FM.parameters.RIGHT,FM.parameters.UP,FM.parameters.DOWN],j=0,n=0.1,g=0,f=1,o=FM.vector(-100,-100),b=FM.vector(100,100),p=-100,a=100,e=false,c=0,k=d.components[FM.componentTypes.SPATIAL];if(!k&&FM.parameters.debug){console.log("ERROR: No spatial component was added and you need one for rendering.")}d.addComponent(l);l.add=function(r){q.push(r);return r};l.createParticles=function(u,t,s,C,w,A){var v,y,x,z,B,r=FM.game.getCurrentState();f=w;for(v=0;v<u;v=v+1){y=FM.gameObject(A);x=FM.spatialComponent(x.position.x+i.x,x.position.y+i.y,y);z=FM.spriteRendererComponent(t,s,C,y);z.setAlpha(f);B=FM.aabbComponent(s,C,y);y.age=0;y.lifeSpan=0;y.hide();y.kill();r.add(y);q.push(y)}};l.emit=function(t,r,u){e=true;c=0;n=r;g=u;var s;for(s=0;s<q.length;s=s+1){q[s].lifeSpan=t}};l.update=function(s){if(e){var v,u,x,w,r,z,y,t;for(v=0;v<q.length;v=v+1){w=q[v];if(w.isAlive()){if(w.age>=w.lifeSpan){w.hide();w.kill()}else{y=w.getComponent(FM.componentTypes.RENDERER);if(y.getAlpha()>=1-(w.age/w.lifeSpan)){y.setAlpha(1-(w.age/w.lifeSpan))}w.age+=s}}}c+=s;if(n===0||c>=n){c=0;x=0;u=0;while(x<g&&u<q.length){w=q[u];if(w&&!w.isAlive()){r=w.getComponent(FM.componentTypes.SPATIAL);z=w.components[FM.componentTypes.PHYSIC];w.components[FM.componentTypes.RENDERER].setAlpha(f);r.position.x=k.position.x+i.x;r.position.y=k.position.y+i.y;w.age=0;t=Math.random()*(b.x-o.x)+o.x;if(m.indexOf(FM.parameters.LEFT)!==-1){if(Math.random()>0.5){t=-t}}z.velocity.x=t;t=Math.random()*(b.y-o.y)+o.y;if(m.indexOf(FM.parameters.UP)!==-1){if(Math.random()>0.5){t=-t}}z.velocity.y=t;t=Math.random()*(a-p)+p;z.angularVelocity=t;w.show();w.revive();x=x+1}u=u+1}}}};l.setDirections=function(r){m=r};l.setAlpha=function(r){f=r;var s;for(s=0;s<q.length;s=s+1){q[s].components[FM.componentTypes.RENDERER].setAlpha(f)}};l.setXVelocity=function(s,r){o.x=s;b.x=r};l.setYVelocity=function(s,r){o.y=s;b.y=r};l.setAngularVelocity=function(s,r){p=s;a=r};l.getAlpha=function(){return f};l.destroy=function(){q=null;l=null};return l};FM.simplePathComponent=function(b){var e=FM.component(FM.componentTypes.PATHFINDING,b),j=[],g=0,l=FM.vector(0,0),a=FM.vector(0,0),c=false,k=false,f=false,i=FM.vector(0,0),h=1,d=b.components[FM.componentTypes.SPATIAL],m=b.components[FM.componentTypes.PHYSIC];if(FM.parameters.debug){if(!d){console.log("ERROR: No spatial component was added and you need one for using the path component.")}if(!m){console.log("ERROR: No physic component was added and you need one for using the path component.")}}b.addComponent(e);e.startFollowingPath=function(p,n){if(j.length>0){c=true;g=n||0;k=false;f=false;l=p;var r=Math.abs((d.position.x+m.offset.x+m.width/2)-j[g].x),q=Math.abs((d.position.y+m.offset.y+m.height/2)-j[g].y),o;if(r<q){o=r/q;a.x=l*o;a.y=l}else{if(r>q){o=q/r;a.x=l;a.y=l*o}else{a.x=l;a.y=l}}}else{if(FM.parameters.debug){console.log("WARNING: path with no waypoints defined.")}}if(!m){console.log("WARNING: path added to a game object with no physic component.")}};e.resumeFollowingPath=function(){if(j.length>0){c=true;if(i.x!==d.position.x||i.y!==d.position.y){k=false;f=false;var p=Math.abs((d.position.x+m.offset.x+m.width/2)-j[g].x),o=Math.abs((d.position.y+m.offset.y+m.height/2)-j[g].y),n;if(p<o){n=p/o;a.x=l*n;a.y=l}else{if(p>o){n=o/p;a.x=l;a.y=l*n}else{a.x=l;a.y=l}}}}else{if(FM.parameters.debug){console.log("WARNING: path with no waypoints defined.")}}if(!m){console.log("WARNING: path added to a game object with no physic component.")}};e.stopFollowingPath=function(){c=false;m.velocity.x=0;m.velocity.y=0;i=FM.vector(d.position.x,d.position.y)};e.clearPath=function(){j=[]};e.update=function(q){if(c&&m){var r=d.position.x+m.offset.x+m.width/2,p=d.position.y+m.offset.y+m.height/2,s,o,n;if(r<j[g].x){if(j[g].x-r<a.x*q){m.velocity.x=j[g].x-r;k=true}else{m.velocity.x=a.x}}else{if(r>j[g].x){if(r-j[g].x<a.x*q){m.velocity.x=r-j[g].x;k=true}else{m.velocity.x=-a.x}}else{k=true;m.velocity.x=0}}if(p<j[g].y){if(j[g].y-p<a.y*q){m.velocity.y=j[g].y-p;f=true}else{m.velocity.y=a.y}}else{if(p>j[g].y){if(p-j[g].y<a.y*q){m.velocity.y=p-j[g].y;f=true}else{m.velocity.y=-a.y}}else{f=true;m.velocity.y=0}}if(k&&f){if(j.length>g+1){k=false;f=false;g=g+1;s=Math.abs(r-j[g].x);o=Math.abs(p-j[g].y);if(s<o){n=s/o;a.x=l*n;a.y=l}else{if(s>o){n=o/s;a.x=l;a.y=l*n}else{a.x=l;a.y=l}}}else{c=false;a=FM.vector(0,0);l=0;m.velocity=FM.vector(0,0)}}}};e.add=function(p,n,o){if(o===undefined){j.push({x:p,y:n})}else{j[o]={x:p,y:n}}};e.remove=function(n){j.splice(n,1)};e.getWaypoints=function(){return j};e.getCurrentIndex=function(){return g};e.getCurrentWaypoint=function(){return j[g]};e.getLength=function(){return j.length};e.isLastWaypointReached=function(){return g===j.length-1&&!c};e.isActive=function(){return c};e.destroy=function(){j=null;d=null;m=null;e.destroy();e=null};return e};FM.aabbComponent=function(a,e,d){var c=FM.physicComponent(a,e,d),b=d.components[FM.componentTypes.SPATIAL];if(FM.parameters.debug){if(!b){console.log("ERROR: No spatial component was added and you need one for physics.")}}d.addComponent(c);c.overlapsWithType=function(f){return null};c.overlapsWithObject=function(f){var g=f.overlapsWithAabb(c);if(g){return g}return null};c.overlapsWithAabb=function(j){var s=j.owner.components[FM.componentTypes.SPATIAL],i=FM.vector(b.position.x+c.offset.x,b.position.y+c.offset.y),q=FM.vector(s.position.x+j.offset.x,s.position.y+j.offset.y),n=FM.vector(i.x+c.width,i.y+c.height),g=FM.vector(q.x+j.width,q.y+j.height),f=FM.vector(i.x+c.width/2,i.y+c.height/2),h=FM.vector(q.x+j.width/2,q.y+j.height/2),l=FM.math.substractVectors(h,f),r=(n.x-i.x)/2,k=(g.x-q.x)/2,p=r+k-Math.abs(l.x),m,o=null;if(n.x<q.x||i.x>g.x){return null}if(n.y<q.y||i.y>g.y){return null}if(p>0){r=(n.y-i.y)/2;k=(g.y-q.y)/2;m=r+k-Math.abs(l.y);if(m>0){o=FM.collision(c,j);if(p<m){if(l.x<0){o.normal=l.reset(-1,0)}else{o.normal=l.reset(1,0)}o.penetration=p}else{if(l.y<0){o.normal=l.reset(0,-1)}else{o.normal=l.reset(0,1)}o.penetration=m}return o}}return null};c.overlapsWithCircle=function(h){var t=h.owner.components[FM.componentTypes.SPATIAL],m=FM.vector(b.position.x+c.offset.x,b.position.y+c.offset.y),s=FM.vector(t.position.x+h.offset.x,t.position.y+h.offset.y),q=FM.vector(m.x+c.width,m.y+c.height),f=FM.vector(m.x+c.width/2,m.y+c.height/2),l=FM.vector(s.x+h.radius,s.y+h.radius),p=FM.math.substractVectors(l,f),g,n,i=p.clone(),j=(q.x-m.x)/2,o=(q.y-m.y)/2,k=false,r=null;i.x=FM.math.clamp(i.x,-j,j);i.y=FM.math.clamp(i.y,-o,o);if(p.isEquals(i)){k=true;if(Math.abs(p.x)>Math.abs(p.y)){if(i.x>0){i.x=j}else{i.x=-j}}else{if(i.y>0){i.y=o}else{i.y=-o}}}r=FM.collision();r.a=c;r.b=h;r.normal=FM.math.substractVectors(p,i);g=r.normal.getLengthSquared();n=h.radius;if(g>n*n&&!k){return null}g=Math.sqrt(g);r.penetration=n-g;if(k){r.normal.reset(-r.normal.x,-r.normal.y)}r.normal.normalize();return r};c.drawDebug=function(f,g){f.strokeStyle="#f4f";f.strokeRect(g.x+c.offset.x-f.xOffset,g.y+c.offset.y-f.yOffset,c.width,c.height)};c.destroy=function(){b=null;Object.getPrototypeOf(c).destroy();c=null};return c};FM.circleComponent=function(d,c){var b=FM.physicComponent(d*2,d*2,c),a=c.components[FM.componentTypes.SPATIAL];if(FM.parameters.debug){if(!a){console.log("ERROR: No spatial component was added and you need one for physics.")}}c.addComponent(b);b.radius=d;b.overlapsWithType=function(e){return null};b.overlapsWithObject=function(e){var f=e.overlapsWithCircle(b);if(f){return f}return null};b.overlapsWithAabb=function(m){var s=m.owner.components[FM.componentTypes.SPATIAL],l=FM.vector(a.position.x+b.offset.x,a.position.y+b.offset.y),r=FM.vector(s.position.x+m.offset.x,s.position.y+m.offset.y),i=FM.vector(r.x+m.width,r.y+m.height),e=FM.vector(l.x+b.radius,l.y+b.radius),k=FM.vector(r.x+m.width/2,r.y+m.height/2),p=FM.math.substractVectors(k,e),f,n,g=p.clone(),h=(i.x-r.x)/2,o=(i.y-r.y)/2,j=false,q=null;g.x=FM.math.clamp(g.x,-h,h);g.y=FM.math.clamp(g.y,-o,o);if(p.isEquals(g)){j=true;if(Math.abs(p.x)>Math.abs(p.y)){if(g.x>0){g.x=h}else{g.x=-h}}else{if(g.y>0){g.y=o}else{g.y=-o}}}q=FM.collision();q.a=b;q.b=m;q.normal=FM.math.substractVectors(p,g);f=q.normal.getLengthSquared();n=b.radius;if(f>(n*n)&&!j){return null}f=Math.sqrt(f);q.penetration=n-f;if(j){q.normal.reset(-q.normal.x,-q.normal.y)}q.normal.normalize();return q};b.overlapsWithCircle=function(g){var n=g.owner.components[FM.componentTypes.SPATIAL],i=FM.vector(a.position.x+b.offset.x,a.position.y+b.offset.y),m=FM.vector(n.position.x+g.offset.x,n.position.y+g.offset.y),e=FM.vector(i.x+b.width/2,i.y+b.height/2),h=FM.vector(m.x+g.width/2,m.y+g.height/2),j=b.radius+g.radius,j=j*j,k=FM.math.substractVectors(h,e),f=k.getLength(),l=null;if(k.getLengthSquared()>j){return null}else{l=FM.collision();l.a=b;l.b=g;if(f!==0){l.penetration=j-f;l.normal=k.reset(k.x/f,k.y/f)}else{l.penetration=b.radius;l.normal=k.reset(1,0)}return l}return null};b.drawDebug=function(f,g){var e=FM.vector(g.x+b.radius,g.y+b.radius);f.beginPath();f.strokeStyle="#f4f";f.arc((e.x+b.offset.x)-f.xOffset,(e.y+b.offset.y)-f.yOffset,b.radius,0,2*Math.PI,false);f.stroke()};b.destroy=function(){a=null;Object.getPrototypeOf(b).destroy();b=null};return b};FM.physicComponent=function(d,n,c){var k=FM.component(FM.componentTypes.PHYSIC,c),j=FM.game.getCurrentState().getWorld(),o=FM.game.getCurrentState().getQuad(),m=0,g=[],l=[],i=[],h=c.components[FM.componentTypes.SPATIAL],f=function(w){var t=FM.vector(w.penetration*w.normal.x,w.penetration*w.normal.y),u=w.a.owner.components[FM.componentTypes.SPATIAL],r=w.b.owner.components[FM.componentTypes.SPATIAL],v=w.a.owner.components[FM.componentTypes.PHYSIC],p=w.b.owner.components[FM.componentTypes.PHYSIC],s=0,q=0,x=0;if(w.a.mass===0){q=0}else{q=1/w.a.mass}if(w.b.mass===0){x=0}else{x=1/w.b.mass}s=q+x;u.position.x-=t.x*(q/s);u.position.y-=t.y*(q/s);r.position.x+=t.x*(x/s);r.position.y+=t.y*(x/s)},e=function(x,w,v,u,p){var r=Math.floor(p/v),z=Math.floor(u/w),q=Math.floor((p+k.height)/v),y=Math.floor((u+k.width)/w),t,s;for(t=r;t<=q;t=t+1){for(s=z;s<=y;s=s+1){if(x[t]!==0&&x[t][s]!==-1){if(s===z||s===y||t===r||t===q){return true}}}}return false},a=function(r,v,q,u,p){var t=h.position.x+u,s=h.position.y+p;if(!e(r,v,q,t+k.offset.x,s+k.offset.y)){h.position.x=t;h.position.y=s;return true}return false},b=function(t,s,q){var y=t.getData(),w=t.getTileWidth(),u=t.getTileHeight();if(Math.abs(s)>=w||Math.abs(q)>=u){b(t,s/2,q/2);b(t,s-s/2,q-q/2);return}var p=a(y,w,u,s,0),v=a(y,w,u,0,q),r,z,x;if(p&&v){return}if(!p){k.velocity.x=0;z=Math.abs(s);for(r=0;r<z;r=r+1){if(s===0){x=0}else{if(s>0){x=1}else{x=-1}}if(!a(y,w,u,x,0)){break}else{k.velocity.x+=x}}}if(!v){k.velocity.y=0;z=Math.abs(q);for(r=0;r<z;r=r+1){if(q===0){x=0}else{if(q>0){x=1}else{x=-1}}if(!a(y,w,u,0,x)){break}else{k.velocity.y+=x}}}};k.offset=FM.vector(0,0);k.width=d;k.height=n;k.velocity=FM.vector(0,0);k.acceleration=FM.vector(0,0);k.drag=FM.vector(0,0);k.angularVelocity=0;k.angularDrag=FM.vector(0,0);k.mass=1;k.maxVelocity=FM.vector(1000,1000);k.maxAngularVelocity=10000;k.elasticity=0;if(!h&&FM.parameters.debug){console.log("ERROR: No spatial component was added and you need one for physics.")}k.update=function(p){l=[];i=[];var q=1/k.mass,t,r;if(k.mass===0){q=0}t=k.velocity.x+(q*k.acceleration.x)*p;r=k.maxVelocity.x+(q*k.acceleration.x)*p;if(Math.abs(t)<=r){k.velocity.x=t}else{if(t<0){k.velocity.x=-r}else{if(t>0){k.velocity.x=r}}}t=k.velocity.y+(q*k.acceleration.y)*p;r=k.maxVelocity.y+(q*k.acceleration.y)*p;if(Math.abs(t)<=r){k.velocity.y=t}else{if(t<0){k.velocity.y=-r}else{if(t>0){k.velocity.y=r}}}if(k.acceleration.x===0){if(k.velocity.x>0){k.velocity.x-=k.drag.x}else{if(k.velocity.x<0){k.velocity.x+=k.drag.x}}}if(k.acceleration.y===0){if(k.velocity.y>0){k.velocity.y-=k.drag.y}else{if(k.velocity.y<0){k.velocity.y+=k.drag.y}}}var x=true,B,y,w,u,s,A,v,z=null;if(g.length>0){if(j.hasTileCollisions()){for(u=0;u<g.length;u=u+1){y=j.getTileMapFromType(g[u]);if(y&&y.canCollide()){b(y,k.velocity.x*p,k.velocity.y*p);x=false;i.push({a:k.owner,b:y})}}}}if(x){h.position.x+=k.velocity.x*p;h.position.y+=k.velocity.y*p}if(g.length>0){B=FM.game.getCurrentState().getQuad();w=B.retrieve(c);for(u=0;u<w.length;u=u+1){A=w[u];v=A.components[FM.componentTypes.PHYSIC];if(A.isAlive()&&c.getId()!==A.getId()&&!v.isCollidingWith(c)&&!k.isCollidingWith(A)){for(s=0;s<g.length;s=s+1){if(A.hasType(g[s])){z=c.components[FM.componentTypes.PHYSIC].overlapsWithObject(v);if(z!==null){k.addCollision(z);v.addCollision(z);k.resolveCollision(v,z);v.resolveCollision(k,z);f(z)}}}}}}};k.checkTileCollisions=function(x,u,p){var w,v,r,z,q,y,t,s;if(x.length>0){w=x.getTileWidth();v=x.getTileHeight();r=Math.floor(p/v);z=Math.floor(u/w);q=Math.floor((p+k.height)/v);y=Math.floor((u+k.width)/w);for(t=r;t<=q;t=t+1){for(s=z;s<=y;s=s+1){if(x[t]&&x[t][s]===1){if(s===z||s===y||t===r||t===q){return true}}}}}return false};k.resolveCollision=function(t,w){var q=FM.math.substractVectors(t.velocity,k.velocity),v=q.dotProduct(w.normal),u=Math.min(k.elasticity,t.elasticity),s=0,r=0,x=0,p=FM.vector(0,0);if(v>0){return}if(k.mass===0){r=0}else{r=1/k.mass}if(t.mass===0){x=0}else{x=1/t.mass}s=-(1+u)*v;s/=r+x;p.reset(s*w.normal.x,s*w.normal.y);k.velocity.x-=r*p.x;k.velocity.y-=r*p.y;t.velocity.x+=x*p.x;t.velocity.y+=x*p.y};k.addTypeToCollideWith=function(p){g.push(p)};k.removeTypeToCollideWith=function(p){g.splice(g.indexOf(p),1)};k.addCollision=function(p){l.push(p)};k.getLinearVelocity=function(){return k.velocity};k.isCollidingWithType=function(q){var p,r;for(p=0;p<l.length;p=p+1){r=l[p];if((r.b&&r.b.owner.hasType(q))||(r.a&&r.a.owner.hasType(q))){return true}}for(p=0;p<i.length;p=p+1){r=i[p];if((r.b&&r.b.hasType(q))||(r.a&&r.a.hasType(q))){return true}}return false};k.isCollidingWith=function(q){var p,r;for(p=0;p<l.length;p=p+1){r=l[p];if((r.b&&r.b.owner.getId()===q.getId())||(r.a&&r.a.owner.getId()===q.getId())){return true}}return false};return k};FM.animatedSpriteRendererComponent=function(o,q,h,a){var j=FM.component(FM.componentTypes.RENDERER,a),p=o,m=p.width,v=p.height,s=q,l=h,b=q,c=h,f=1,d="",i=false,x=0,k=0,n=[],g=0,t=0,w=0.1,r=0.1,u=[],e=a.components[FM.componentTypes.SPATIAL];if(!e&&FM.parameters.debug){console.log("ERROR: No spatial component was added and you need one for rendering.")}a.addComponent(j);j.finished=false;j.addAnimation=function(z,A,y,B){g=0;d=z;n[z]=A;w=1/y;r=w;u[z]=B};j.play=function(y){d=y;j.finished=false;g=0;x=n[d][g]*s;k=Math.floor(x/m)*l;if(x>=m){k=Math.floor(x/m)*l;x=(x%m)}};j.stop=function(){j.finished=true};j.draw=function(y,z){var C=z.x,B=z.y,A=(new Date()).getTime()/1000;C-=y.xOffset*a.scrollFactor.x;B-=y.yOffset*a.scrollFactor.y;y.globalAlpha=f;if(e.angle!==0){y.save();y.translate(C,B);y.translate(s/2,l/2);y.rotate(e.angle);y.drawImage(p,x,k,s,l,-b/2,-c/2,b,c);y.restore()}else{y.drawImage(p,x,k,s,l,C,B,b,c)}y.globalAlpha=1;if(!j.finished){if(r<=0){r=w;if(n[d]){if(n[d].length>1){g=g+1;if(n[d]&&(g===n[d].length-1)){if(u[d]){g=0}else{j.finished=true}}}else{j.finished=true}x=n[d][g]*s;k=Math.floor(x/m)*l;if(x>=m){k=Math.floor(x/m)*l;x=(x%m)}}}else{r-=A-t}}t=A};j.destroy=function(){p.destroy();p=null;d=null;n=null;u=null;e=null;j.destroy();j=null};j.getCurrentAnim=function(){return d};j.changeSize=function(y){b=y*s;c=y*l};j.setAlpha=function(y){f=y};j.getWidth=function(){return b};j.getHeight=function(){return c};j.getOriginalWidth=function(){return s};j.getOriginalHeight=function(){return l};j.getAlpha=function(){return f};return j};FM.boxRendererComponent=function(c,i,f,b){var h=FM.component(FM.componentTypes.RENDERER,b),a=c,j=i,e=f,d=1,g=b.components[FM.componentTypes.SPATIAL];if(!g&&FM.parameters.debug){console.log("ERROR: No spatial component was added and you need one for rendering.")}b.addComponent(h);h.draw=function(k,l){var n=l.x,m=l.y;n-=k.xOffset*b.scrollFactor.x;m-=k.yOffset*b.scrollFactor.y;k.globalAlpha=d;if(g.angle!==0){k.save();k.translate(n,m);k.translate(a/2,j/2);k.rotate(g.angle);k.beginPath();k.rect(n,m,a,j);k.restore()}else{k.beginPath();k.rect(n,m,a,j)}k.fillStyle=e;k.fill();k.globalAlpha=1};h.destroy=function(){g=null;h.destroy();h=null};h.setWidth=function(k){a=k};h.setHeight=function(k){j=k};h.setColor=function(k){e=k};h.setAlpha=function(k){d=k};h.getWidth=function(){return a};h.getHeight=function(){return j};h.getColor=function(){return e};h.getAlpha=function(){return d};return h};FM.circleRendererComponent=function(f,e,b){var h=FM.component(FM.componentTypes.RENDERER,b),a=f*2,i=f*2,d=e,c=1,g=b.components[FM.componentTypes.SPATIAL];if(!g&&FM.parameters.debug){console.log("ERROR: No spatial component was added and you need one for rendering.")}b.addComponent(h);h.draw=function(k,l){var n=l.x-k.xOffset*b.scrollFactor.x,m=l.y-k.yOffset*b.scrollFactor.y,j=FM.vector(n+a/2,m+i/2);k.globalAlpha=c;if(g.angle!==0){k.save();k.translate(n,m);k.translate(a/2,i/2);k.rotate(g.angle);k.beginPath();k.arc(j.x,j.y,a/2,0,2*Math.PI);k.restore()}else{k.beginPath();k.arc(j.x,j.y,a/2,0,2*Math.PI)}k.fillStyle=d;k.fill();k.globalAlpha=1};h.destroy=function(){g=null;h.destroy();h=null};h.setWidth=function(j){a=j;i=j};h.setHeight=function(j){i=j;a=j};h.setRadius=function(j){a=j*2;i=j*2};h.setColor=function(j){d=j};h.setAlpha=function(j){c=j};h.getWidth=function(){return a};h.getHeight=function(){return i};h.getRadius=function(){return a/2};h.getColor=function(){return d};h.getAlpha=function(){return c};return h};FM.lineRendererComponent=function(f,e,b){var i=FM.component(FM.componentTypes.RENDERER,b),j=[],a=0,k=0,g=f,d=e,c=1,h=b.components[FM.componentTypes.SPATIAL];if(!h&&FM.parameters.debug){console.log("ERROR: No spatial component was added and you need one for rendering.")}b.addComponent(i);i.draw=function(l,n){var p=n.x,o=n.y,m;p-=l.xOffset*b.scrollFactor.x;o-=l.yOffset*b.scrollFactor.y;l.globalAlpha=c;if(h.angle!==0){l.save();l.translate(p,o);l.translate(a/2,k/2);l.rotate(h.angle);if(j.length>0){l.beginPath();l.moveTo(j[0].x,j[0].y);for(m=1;m<j.length;m=m+1){l.lineTo(j[m].x,j[m].y)}}l.restore()}else{if(j.length>0){l.beginPath();l.moveTo(j[0].x,j[0].y);for(m=1;m<j.length;m=m+1){l.lineTo(j[m].x,j[m].y)}}}l.strokeStyle=d;l.lineWidth=g;l.stroke();l.globalAlpha=1;l.lineWidth=1};i.destroy=function(){h=null;i.destroy();var l;for(l=0;l<j.length;l=l+1){j[l].destroy()}j=null;i=null};i.addPoint=function(o){j.push(o);var p,l,n=0,r=0,m=0,q=0;for(p=0;p<j.length;p=p+1){l=j[p];if(l.x>n){n=l.x}if(l.x<r){r=l.x}if(l.y<m){m=l.y}if(l.y>q){q=l.y}}a=Math.abs(n-r);k=Math.abs(q-m)};i.setLineWidth=function(l){g=l};i.setLineStyle=function(l){d=l};i.setAlpha=function(l){c=l};i.getWidth=function(){return a};i.getHeight=function(){return k};i.getLineWidth=function(){return g};i.getLineStyle=function(){return d};i.getAlpha=function(){return c};return i};FM.spriteRendererComponent=function(h,d,k,c){var j=FM.component(FM.componentTypes.RENDERER,c),e=h,a=null,b=d,l=k,f=1,g=FM.vector(0,0),i=c.components[FM.componentTypes.SPATIAL];if(!i&&FM.parameters.debug){console.log("ERROR: No spatial component was added and you need one for rendering.")}c.addComponent(j);j.draw=function(m,n){var p=n.x,o=n.y;p-=m.xOffset*c.scrollFactor.x;o-=m.yOffset*c.scrollFactor.y;m.globalAlpha=f;if(i.angle!==0){m.save();m.translate(p,o);m.translate(b/2,l/2);m.rotate(i.angle);if(a){m.putImageData(a,-b/2,-l/2)}else{m.drawImage(e,-b/2,-l/2,b,l)}m.restore()}else{if(a){m.putImageData(a,p,o)}else{m.drawImage(e,p,o,b,l)}}m.globalAlpha=1};j.setOffset=function(p,o){g.reset(p,o);var m=document.createElement("canvas"),n=m.getContext("2d");m.width=e.width;m.height=e.height;n.drawImage(e,0,0,e.width,e.height);a=n.getImageData(g.x,g.y,b,l);delete this.tmpContext;delete this.tmpCanvas};j.destroy=function(){a=null;g.destroy();g=null;e.destroy();e=null;i=null;j.destroy();j=null};j.setImage=function(n,m,o){e=n;b=m;l=o};j.setWidth=function(m){b=m};j.setHeight=function(m){l=m};j.setAlpha=function(m){f=m};j.getWidth=function(){return b};j.getHeight=function(){return l};j.getAlpha=function(){return f};return j};FM.textRendererComponent=function(f,e){var d=FM.component(FM.componentTypes.RENDERER,e),c=e.components[FM.componentTypes.SPATIAL],b=50,a=50;if(!c&&FM.parameters.debug){console.log("ERROR: No spatial component was added and you need one for rendering.")}e.addComponent(d);d.text=f;d.fillStyle="#fff";d.font="30px sans-serif";d.textBaseline="middle";d.setFormat=function(h,g,i){d.fillStyle=h;d.font=g;d.textBaseline=i};d.draw=function(g,h){var j=h.x,i=h.y;j-=g.xOffset*e.scrollFactor.x;i-=g.yOffset*e.scrollFactor.y;g.fillStyle=d.fillStyle;g.font=d.font;g.textBaseline=d.textBaseline;g.fillText(d.text,j,i)};d.destroy=function(){c=null;d.text=null;d.fillStyle=null;d.font=null;d.textBaseline=null;d.destroy();d=null};d.getWidth=function(){return b};d.getHeight=function(){return a};return d};FM.audioComponent=function(c){var b=FM.component(FM.componentTypes.SOUND,c),a=[];c.addComponent(b);b.play=function(f,h,e){var g,j,d=false;for(g=0;g<a.length;g=g+1){j=a[g];if(j.getName()===f){d=true;j.volume=h;if(e){j.addEventListener("ended",function(){if(window.chrome){this.load()}this.currentTime=0;this.play()},false)}if(window.chrome){j.load()}j.play()}}if(!d){if(FM.parameters.debug){console.log("WARNING: you're trying to play a sound that does not exist.")}}};b.pause=function(d){var e,f;for(e=0;e<a.length;e=e+1){f=a[e];if(f.getName()===d){f.pause()}}};b.addSound=function(d){a.push(d)};b.destroy=function(){var d;for(d=0;d<a.length;d=d+1){a[d].destroy()}a=null;b.destroy();b=null};b.getSoundByName=function(d){var e,f;for(e=0;e<a.length;e=e+1){f=a[e];if(f.getName()===d){return f}}return null};return b};FM.spatialComponent=function(b,a,d){var c=FM.component(FM.componentTypes.SPATIAL,d);c.position=FM.vector(b,a);c.previous=FM.vector(b,a);c.angle=0;d.addComponent(c);c.destroy=function(){c.position=null;c.previous=null;c.destroy();c=null};return c};