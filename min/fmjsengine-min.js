var FMENGINE=FMENGINE||{};FMENGINE.fmAssetManager={assets:[],loadingProgress:0,addAsset:function(a,c,f){var d=FMENGINE.fmAssetManager,g=FMENGINE.fmParameters,b=d.getAssetByName(a);if(c===g.IMAGE){if(!b){d.assets.push(FMENGINE.fmImageAsset(a,f))}}else{if(c===g.AUDIO){if(!b){var e=FMENGINE.fmAudioAsset(a,f);if(e.isSupported()){d.assets.push(e)}else{if(FMENGINE.fmParameters.debug){console.log("WARNING: The "+f.substring(f.lastIndexOf(".")+1)+" audio format is not supported by this browser.")}}}}else{if(c===g.FILE){if(!b){d.assets.push(FMENGINE.fmFileAsset(a,f))}}}}},loadAssets:function(){var a,b=FMENGINE.fmAssetManager;for(a=0;a<b.assets.length;a=a+1){b.assets[a].load()}},assetLoaded:function(){var a=FMENGINE.fmAssetManager;a.loadingProgress+=100/a.assets.length},areAllAssetsLoaded:function(){return Math.round(FMENGINE.fmAssetManager.loadingProgress)>=100},getAssetByName:function(a){var c=null,b=0,d=FMENGINE.fmAssetManager;for(b=0;b<d.assets.length;b=b+1){if(d.assets[b].getName()===a){c=d.assets[b]}}return c}};FMENGINE.fmAudioAsset=function(a,f){var e=new Audio(),d=a,g=f,h=g.substring(g.lastIndexOf(".")+1),c=false,b=function(){c=true;FMENGINE.fmAssetManager.assetLoaded()};e.load=function(){e.src=g;e.addEventListener("loadeddata",b,false)};e.isLoaded=function(){return c};e.destroy=function(){d=null;g=null;e=null};e.getName=function(){return d};e.getPath=function(){return g};e.isSupported=function(){var i=false;if(h==="wav"){i=!!e.canPlayType&&e.canPlayType('audio/wav; codecs="1"')!==""}else{if(h==="ogg"){i=!!e.canPlayType&&e.canPlayType('audio/ogg; codecs="vorbis"')!==""}else{if(h==="mp3"){i=!!e.canPlayType&&e.canPlayType("audio/mpeg;")!==""}else{if(h==="aac"){i=!!e.canPlayType&&e.canPlayType('audio/mp4; codecs="mp4a.40.2"')!==""}}}}return i};return e};FMENGINE.fmParameters={FPS:60,libFolder:"lib",debug:false,COLLIDER_MINIMUM_SIZE:16,STATIC:"static",KINEMATIC:"kinematic",DYNAMIC:"dynamic",PIXELS_TO_METERS:30,IMAGE:"image",AUDIO:"audio",FILE:"file",LEFT:"left",RIGHT:"right",UP:"up",DOWN:"down",backgroundColor:"rgb(0,0,0)"};FMENGINE.fmCircle=function(b,a,d){var c={};c.x=b;c.y=a;c.radius=d;c.destroy=function(){c=null};return c};FMENGINE.fmComponent=function(c,a){var b={};if(a.components!==undefined){b.name=c;b.owner=a}else{if(FMENGINE.fmParameters.debug){console.log("ERROR: the owner of the "+c+" component must be a fmGameObject.")}}b.destroy=function(){b.name=null;b.owner=null;b=null};return b};FMENGINE.fmFileAsset=function(a,g){var f=new XMLHttpRequest(),d=a,h=g,e=null,c=false,b=function(){c=true;e=f.responseText;FMENGINE.fmAssetManager.assetLoaded()};f.load=function(){f.addEventListener("load",b,false);f.open("GET",h,false);f.send()};f.isLoaded=function(){return c};f.destroy=function(){d=null;h=null;e=null;f=null};f.getName=function(){return d};f.getPath=function(){return h};f.getContent=function(){return e};return f};var FMENGINE=FMENGINE||{};FMENGINE.fmGame=(function(){var m={},F="",y=0,C=0,E=null,d="",c=null,i=null,a=null,A=0,l=0,u=1/FMENGINE.fmParameters.FPS,z=0,B=(new Date()).getTime()/1000,g=0,p=[],b=[],s=false,k=false,x=false,o=0,n=0,j=false,q=function(){c.clearRect(0,0,y,C);c.fillStyle=FMENGINE.fmParameters.backgroundColor;c.fillRect(0,0,y,C);var H=(new Date()).getTime()/1000,G=H-B,I=0;if(G>0.25){G=0.25}B=H;g+=G;if(!j){while(g>=u){g-=u;l+=u;E.updatePhysics(u)}I=g/u;E.update(I);A=A+1;z=Math.round(A/l)}E.draw(a,I);if(j){a.fillStyle="rgba(99,99,99,0.5)";a.fillRect(0,0,y,C);a.fillStyle="rgba(255,255,255,1)";a.beginPath();a.moveTo(y/2+60,C/2);a.lineTo(y/2-60,C/2-60);a.lineTo(y/2-60,C/2+60);a.lineTo(y/2+60,C/2);a.fill();a.closePath()}if(FMENGINE.fmParameters.debug){a.fillStyle="#fcd116";a.font="30px sans-serif";a.textBaseline="middle";a.fillText(z,10,20)}c.drawImage(i,0,0);s=false;b=[];requestAnimationFrame(q)},r=function(G){p[G.keyCode]=1},v=function(H){var G=H.keyCode;b[G]=1;delete p[G]},t=function(G){o=G.clientX-G.target.offsetLeft;n=G.clientY-G.target.offsetTop},h=function(G){s=true},w=function(G){k=true;x=false},f=function(G){x=true;k=false},e=function(G){j=false},D=function(G){j=true};m.run=function(H,J,G,L,I,K){F=J;y=G;C=L;d=document.getElementById(H);if(K){E=K(I)}else{E=FMENGINE.fmPreloader(I)}if(d&&d.getContext){c=d.getContext("2d");if(c){d.width=y;d.height=C;i=document.createElement("canvas");i.width=y;i.height=C;a=i.getContext("2d");a.xOffset=0;a.yOffset=0}}if(c&&a){d.onkeydown=function(M){r(M)};d.onkeyup=function(M){v(M)};d.onclick=function(M){h(M)};d.onmousedown=function(M){w(M)};d.onmouseup=function(M){f(M)};d.onmousemove=function(M){t(M)};d.onfocus=function(M){e(M)};d.onblur=function(M){D(M)};d.focus();E.init(m);requestAnimationFrame(q)}};(function(){var G,H=0,I=["ms","moz","webkit","o"];for(G=0;G<I.length&&!window.requestAnimationFrame;++G){window.requestAnimationFrame=window[I[G]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[I[G]+"CancelAnimationFrame"]||window[I[G]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(N,K){var J=new Date().getTime(),L=Math.max(0,16-(J-H)),M=window.setTimeout(function(){N(J+L)},L);H=J+L;return M}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(J){clearTimeout(J)}}}());m.switchState=function(G){E.destroy();E=G;E.init(m)};m.isKeyPressed=function(G){if(p[G]){return true}else{return false}};m.isKeyReleased=function(G){if(b[G]){return true}else{return false}};m.isMouseClicked=function(){return s};m.isMousePressed=function(){return k};m.isMouseReleased=function(){return x};m.getName=function(){return F};m.getMouseX=function(){return o+E.camera.x};m.getMouseY=function(){return n+E.camera.y};m.getMouseScreenX=function(){return o};m.getMouseScreenY=function(){return n};m.getScreenWidth=function(){return y};m.getScreenHeight=function(){return C};m.getCurrentState=function(){return E};return m}());FMENGINE.fmGameObject=function(e){var d={},g=0,a="",c=true,f=true,b=[];d.scrollFactor=FMENGINE.fmVector(1,1);d.components={};d.zIndex=e;d.addType=function(h){b.push(h)};d.removeType=function(h){b.splice(b.indexOf(h),1)};d.hasType=function(h){return b.indexOf(h)!==-1};d.addComponent=function(i){var h=i.name;if(!d.components[h]){d.components[h]=i}};d.getComponent=function(h){return d.components[h]};d.destroy=function(){a=null;d.scrollFactor=null;var h;for(h=0;h<d.components.length;h=h+1){d.components[h].destroy()}d.components=null;d=null};d.kill=function(){c=false};d.hide=function(){f=false};d.revive=function(){c=true};d.show=function(){f=true};d.getName=function(){return a};d.setName=function(h){a=h};d.getId=function(){return g};d.setId=function(h){g=h};d.isAlive=function(){return c};d.isVisible=function(){return f};return d};FMENGINE.fmImageAsset=function(a,f){var e=new Image(),d=a,g=f,c=false,b=function(){c=true;FMENGINE.fmAssetManager.assetLoaded()};e.load=function(){e.src=g;e.addEventListener("load",b,false)};e.isLoaded=function(){return c};e.destroy=function(){d=null;g=null;e=null};e.getName=function(){return d};e.getPath=function(){return g};return e};FMENGINE.fmKeyboard={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS:20,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DEL:46,ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,lLEFT_SPECIAL:91,RIGHT_SPECIAL:92,SELECT:93,NUM_ZERO:96,NUM_ONE:97,NUM_TWO:98,NUM_THREE:99,NUM_FOUR:100,NUM_FIVE:101,NUM_SIX:102,NUM_SEVEN:103,NUM_EIGHT:104,NUM_NINE:105,MULTIPLY:106,ADD:107,SUBSTRACT:109,DECIMAL_POINT:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,SEMICOLON:186,EQUAL_SIGN:187,COMMA:188,DASH:189,PERIOD:190,FORWARD_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,SINGLE_QUOTE:222};FMENGINE.fmMathUtils={addVectors:function(b,a){return FMENGINE.fmVector(b.x+a.x,b.y+a.y)},substractVectors:function(b,a){return FMENGINE.fmVector(b.x-a.x,b.y-a.y)},multiplyVectors:function(b,a){return FMENGINE.fmVector(b.x*a.x,b.y*a.y)},clamp:function(c,b,a){return Math.min(a,Math.max(b,c))},};FMENGINE.fmRectangle=function(c,b,a,e){var d={};d.x=c;d.y=b;d.width=a;d.height=e;d.destroy=function(){d=null};return d};FMENGINE.fmState=function(){var f={},a=0,b=0,d=null,h=null,i=null,e=null,g=function(k,j){return(k.zIndex-j.zIndex)};f.members=[];FMENGINE.fmState.lastId=0;f.camera=FMENGINE.fmRectangle(0,0,0,0);f.init=function(k,j){a=FMENGINE.fmGame.getScreenWidth();b=FMENGINE.fmGame.getScreenHeight();e=FMENGINE.fmWorld(k||a,j||b);i=FMENGINE.fmQuadTree(0,FMENGINE.fmRectangle(0,0,k||a,j||b));f.camera.width=a;f.camera.height=b;if(FMENGINE.fmParameters.debug){console.log("INIT: The state has been created.")}};f.add=function(j){if(j.components){f.members.push(j);j.setId(FMENGINE.fmState.lastId);FMENGINE.fmState.lastId+=1;if(j.components[FMENGINE.fmComponentTypes.PHYSIC]){i.insert(j)}}else{if(FMENGINE.fmParameters.debug){console.log("ERROR: you're trying to add something elsethan a game object to the state. This is not allowed.")}}};f.remove=function(j){f.members.splice(f.members.indexOf(j),1);j.destroy()};f.sortByZIndex=function(){f.members.sort(g)};f.updatePhysics=function(l){var k=e.box2DWorld,m,j,o,n,p;if(k){k.Step(1/FMENGINE.fmParameters.FPS,10,10);k.ClearForces()}for(m=0;m<f.members.length;m=m+1){j=f.members[m];if(j.isAlive()){o=j.components;n=o[FMENGINE.fmComponentTypes.SPATIAL];p=o[FMENGINE.fmComponentTypes.PHYSIC];if(p){n.previous=n.position;p.update(l)}}}};var c=function(n){var p,l,s,t,w,x,k;for(p=0;p<f.members.length;p=p+1){l=f.members[p];if(l.isAlive()){s=l.components;t=s[FMENGINE.fmComponentTypes.SPATIAL];w=s[FMENGINE.fmComponentTypes.PHYSIC];x=s[FMENGINE.fmComponentTypes.PATHFINDING];k=s[FMENGINE.fmComponentTypes.FX];if(x){x.update(n)}if(k){k.update(n)}if(l.update){l.update(n)}if(w){if(d===l){var r,v=h.width,o=h.height,m=t.position.x+w.offset.x,q=t.position.y+w.offset.y,u=m+w.width,j=q+w.height;if(m<=h.x){r=f.camera.x-(h.x-m);if(r>=0){f.camera.x=r;h.x=m}}if(q<=h.y){r=f.camera.y-(h.y-q);if(r>=0){f.camera.y=r;h.y=q}}if(u>=h.x+v){r=f.camera.x+(u-(h.x+v));if(r+f.camera.width<=e.width){f.camera.x=r;h.x=u-v}}if(j>=h.y+o){r=f.camera.y+(j-(h.y+o));if(r+f.camera.height<=e.height){f.camera.y=r;h.y=j-o}}}}else{if(FMENGINE.fmParameters.debug&&d===l){console.log("ERROR: The scrolling object must have a physic component.")}}}}};f.preUpdate=function(){};f.update=function(j){c(j)};f.postUpdate=function(j){};f.draw=function(k,n){k.clearRect(0,0,a,b);k.xOffset=f.camera.x;k.yOffset=f.camera.y;var r,l,o,t,w,v;for(r=0;r<f.members.length;r=r+1){l=f.members[r];if(l.isVisible()||(FMENGINE.fmParameters.debug&&l.isAlive())){t=l.components[FMENGINE.fmComponentTypes.SPATIAL];if(t){v=l.components[FMENGINE.fmComponentTypes.RENDERER];o=FMENGINE.fmVector(t.position.x*n+t.previous.x*(1-n),t.position.y*n+t.previous.y*(1-n));if(v&&l.isVisible()){var m=o.x,s=o.y,u=m+v.getWidth(),j=s+v.getHeight(),q=0,p=0;q=(f.camera.x+(a-f.camera.width)/2)*l.scrollFactor.x;p=(f.camera.y+(b-f.camera.height)/2)*l.scrollFactor.y;if(u>=q&&j>=p&&m<=q+f.camera.width&&s<=p+f.camera.height){v.draw(k,o)}}if(FMENGINE.fmParameters.debug&&l.isAlive()){w=l.components[FMENGINE.fmComponentTypes.PHYSIC];if(w){w.drawDebug(k,o)}}}}}if(FMENGINE.fmParameters.debug){k.strokeStyle="#f0f";k.strokeRect(0-f.camera.x,0-f.camera.y,e.width,e.height);k.strokeStyle="#8fc";k.strokeRect((a-f.camera.width)/2,(b-f.camera.height)/2,f.camera.width,f.camera.height);if(h){k.strokeStyle="#f4f";k.strokeRect(h.x-f.camera.x,h.y-f.camera.y,h.width,h.height)}}};f.centerCameraOn=function(j){var l=j.components[FMENGINE.fmComponentTypes.SPATIAL],k=l.position.x-f.camera.width/2;if(k>e.x&&k<e.width){f.camera.x=k}k=l.position.y-f.camera.height/2;if(k>e.y&&k<e.height){f.camera.y=k}};f.centerCameraAt=function(l,k){var j=l-f.camera.width/2;if(j>e.x&&j<e.width){f.camera.x=j}j=k-f.camera.height/2;if(j>e.y&&j<e.height){f.camera.y=j}};f.follow=function(k,l,j){d=k;h=FMENGINE.fmRectangle((a-l)/2+f.camera.x,(b-j)/2+f.camera.y,l,j)};f.unFollow=function(){h=null;d=null};f.destroy=function(){var j;for(j=0;j<f.members.length;j=j+1){f.members[j].destroy()}f.members=null;d=null;if(h){h.destroy()}h=null;f.camera.destroy();f.camera=null;e.destroy();e=null;i.clear();i=null;f=null};f.getGameObjectById=function(l){var j,k;for(k=0;k<f.members.length;k=k+1){j=f.members[k];if(j.getId()===l){return j}}return null};f.getScroller=function(){return d};f.getWorld=function(){return e};f.getQuad=function(){return i};return f};FMENGINE.fmTilemap=function(p,d,n,b,a,j,i,k){var h={},f=[],e=p,c=d,o=n,m=b,g=a,l=k;h.load=function(q){var F=q.split("\n"),E=null,D=null,u=null,x=null,A=null,r=FMENGINE.fmGame.getCurrentState(),y,B,C,z,t,w,v,s;for(w=0;w<F.length;w=w+1){E=F[w];if(E){D=[];u=E.split(",",c);for(v=0;v<u.length;v=v+1){x=u[v];if(x>0){A=FMENGINE.fmGameObject(l);for(s=0;s<j.length;s=s+1){A.addType(j[s])}y=FMENGINE.fmSpatialComponent(v*m,w*g,A);A.addComponent(y);B=FMENGINE.fmSpriteRendererComponent(e,m,g,A);z=x*m;t=Math.floor(z/e.width)*g;if(z>=e.width){t=Math.floor(z/e.width)*g;z=(z%e.width)}B.setXOffset(z);B.setYOffset(t);A.addComponent(B);C=FMENGINE.fmAabbComponent(m,g,A);for(s=0;s<i.length;s=s+1){Object.getPrototypeOf(C).mass=0;C.addTypeToCollideWith(i[s])}A.addComponent(C);r.add(A)}D.push(x)}f.push(D)}}};h.destroy=function(){f=null;e=null;h=null};h.getData=function(){return f};h.getTileSet=function(){return e};h.getTileId=function(q,r){return f[Math.floor(r/g)][Math.floor(q/m)]};h.getWidth=function(){return c};h.getHeight=function(){return o};h.getTileWidth=function(){return m};h.getTileHeight=function(){return g};h.getZIndex=function(){return l};return h};FMENGINE.fmVector=function(b,a){var c={};c.x=typeof b==="undefined"?0:b;c.y=typeof a==="undefined"?0:a;c.add=function(d){c.x+=d.x;c.y+=d.y;return c};c.substract=function(d){c.x-=d.x;c.y-=d.y;return c};c.multiply=function(d){c.x*=d.x;c.y*=d.y;return c};c.dotProduct=function(d){return(c.x*d.x+c.y*d.y)};c.crossProd=function(d){return c.x*d.y-c.y*d.x};c.reset=function(e,d){c.x=typeof e==="undefined"?0:e;c.y=typeof d==="undefined"?0:d;return c};c.getLength=function(){return Math.sqrt((c.x*c.x)+(c.y*c.y))};c.getLengthSquared=function(){return(c.x*c.x)+(c.y*c.y)};c.normalize=function(){var d=c.getLength();c.x=c.x/d;c.y=c.y/d};c.copy=function(d){c.x=d.x;c.y=d.y;return c};c.clone=function(){return new FMENGINE.fmVector(c.x,c.y)};c.isEquals=function(d){return(c.x===d.x&&c.y===d.y)};c.destroy=function(){c=null};return c};FMENGINE.fmWorld=function(a,d){var b=FMENGINE.fmRectangle(0,0,a,d),c=FMENGINE.fmGame.getCurrentState();b.destroy=function(){c=null;b=null};return b};FMENGINE.fmCollision=function(){var a={};a.a=null;a.b=null;a.penetration=0;a.normal=null;a.destroy=function(){a.normal=null;a=null};return a};FMENGINE.fmComponentTypes={SPATIAL:"spatial",PATHFINDING:"pathfinding",RENDERER:"renderer",PHYSIC:"physic",SOUND:"sound",FX:"fx"};FMENGINE.fmPreloader=function(a){var b=Object.create(FMENGINE.fmState()),c,d;b.init=function(){Object.getPrototypeOf(b).init();c=FMENGINE.fmGame.getScreenWidth();d=FMENGINE.fmGame.getScreenHeight()};b.update=function(f){Object.getPrototypeOf(b).update(f);var e=FMENGINE.fmAssetManager;if(e.assets.length===0||e.areAllAssetsLoaded()){FMENGINE.fmGame.switchState(a())}};b.draw=function(e,f){Object.getPrototypeOf(b).draw(e,f);e.fillStyle="#fff";e.font="30px sans-serif";e.textBaseline="middle";e.fillText(Math.ceil(FMENGINE.fmAssetManager.loadingProgress)+"%",c/2,d/2)};return b};FMENGINE.fmQuadTree=function(f,k){var g={},j=10,e=5,c=f,i=[],a=k,b=[],d=function(l){var m=-1,p=l.components[FMENGINE.fmComponentTypes.SPATIAL],s=l.components[FMENGINE.fmComponentTypes.PHYSIC],o=a.x+(a.width/2),q=a.x+(a.height/2),n=(p.position.y<q&&p.position.y+s.height<q),r=(p.position.y>q);if(p.position.x<o&&p.position.x+s.width<o){if(n){m=1}else{if(r){m=2}}}else{if(p.position.x>o){if(n){m=0}else{if(r){m=3}}}}return m},h=function(){var m=a.width/2,n=a.height/2,l=a.x,o=a.y;b.push(FMENGINE.fmQuadTree(c+1,FMENGINE.fmRectangle(l+m,o,m,n)));b.push(FMENGINE.fmQuadTree(c+1,FMENGINE.fmRectangle(l,o,m,n)));b.push(FMENGINE.fmQuadTree(c+1,FMENGINE.fmRectangle(l,o+n,m,n)));b.push(FMENGINE.fmQuadTree(c+1,FMENGINE.fmRectangle(l+m,o+n,m,n)))};g.insert=function(l){if(b[0]){var m=d(l);if(m!==-1){b[m].insert(l);return}}i.push(l);if(i.length>j&&c<e){if(!b[0]){h()}var n=0,m;while(n<i.length){m=d(i[n]);if(m!==-1){b[m].insert(i.splice(n,1)[0])}else{n=n+1}}}};g.retrieve=function(o,l){var m=d(l);if(m!==-1&&b[0]){b[m].retrieve(o,l)}var n;for(n=0;n<i.length;n=n+1){o.push(i[n])}return o};g.clear=function(){i=[];var l;for(l=0;l<b.length;l=l+1){if(b[l]){b[l].clear();b.splice(l,1)}}b=[]};return g};if(typeof Object.create!=="function"){Object.create=function(b){function a(){}a.prototype=b;return new a()}}if(typeof Object.getPrototypeOf!=="function"){if(typeof"test".__proto__==="object"){Object.getPrototypeOf=function(a){return a.__proto__}}else{Object.getPrototypeOf=function(a){return a.constructor.prototype}}}function include(a){var b=document.getElementsByTagName("head")[0];script=document.createElement("script");script.src=a;script.type="text/javascript";b.appendChild(script)}function parseXml(a){var b=new DOMParser();b=b.parseFromString(a,"text/xml");return b}var tmxLayer=function(){var a={};a.map;a.name;a.x;a.y;a.width;a.height;a.opacity;a.visible;a.tileGids=[];a.properties=null;a.load=function(j,l){a.map=l;a.name=j.getAttribute("name");a.x=parseInt(j.getAttribute("x"));a.y=parseInt(j.getAttribute("y"));a.width=parseInt(j.getAttribute("width"));a.height=parseInt(j.getAttribute("height"));a.visible=!j.getAttribute("visible")||(j.getAttribute("visible")!==0);a.opacity=parseInt(j.getAttribute("opacity"));var h=j.getElementsByTagName("properties")[0],c=j.getElementsByTagName("data")[0],n=c.getElementsByTagName("tile"),m,g,d;if(h){for(d=0;d<h.childNodes.length;d++){if(h.hasChildNodes()===true){m=h.childNodes[d];if(m.nodeType===1){if(a.properties){a.properties.add(m)}else{a.properties=tmxPropertySet();a.properties.add(m)}}}}}if(c){var k="",f=a.width,b=-1,e;if(!c.getAttribute("encoding")||(c.getAttribute("encoding")&&c.getAttribute("encoding").length===0)){for(d=0;d<n.length;d=d+1){g=n[d];if(++f>=a.width){a.tileGids[++b]=[];f=0}e=g.getAttribute("gid");a.tileGids[b].push(e)}}else{if(c.getAttribute("encoding")==="csv"){k=c.childNodes[0].nodeValue;a.tileGids=a.csvToArray(k,a.width)}else{if(c.getAttribute("encoding")==="base64"){console.log("ERROR: TmxLoader, use XML or CSV export.")}}}}};a.toCsv=function(c){var g=16777215,e=0,l="",k=null,h="",b=0,f,d;if(c){e=c.firstGID;g=c.numTiles-1}for(f=0;f<a.tileGids.length;f=f+1){k=a.tileGids[f];h="";b=0;for(d=0;d<k.length;d=d+1){b=k[d];b-=e;if(b<0||b>g){b=0}l+=h;h=b+","}l+=b+"\n"}return l};a.csvToArray=function(f,e){var l=[],k=f.split("\n"),h=null,g=null,d=null,c,b;for(c=0;c<k.length;c=c+1){h=k[c];if(h){g=[];d=h.split(",",e);for(b=0;b<d.length;b=b+1){g.push(d[b])}l.push(g)}}return l};return a};var tmxMap=function(){var a={},b=null;a.version="unknown";a.orientation="orthogonal";a.width=0;a.height=0;a.tileWidth=0;a.tileHeight=0;a.properties=null;a.layers=[];a.tileSets=[];a.objectGroups=[];a.load=function(c){var o,d;if(window.DOMParser){d=new DOMParser();o=d.parseFromString(c,"text/xml")}else{o=new ActiveXObject("Microsoft.XMLDOM");o.async=false;o.loadXML(c)}b=o.getElementsByTagName("map")[0];a.version=b.getAttribute("version")||"unknown";a.orientation=b.getAttribute("orientation")||"orthogonal";a.width=parseInt(b.getAttribute("width"));a.height=parseInt(b.getAttribute("height"));a.tileWidth=parseInt(b.getAttribute("tilewidth"));a.tileHeight=parseInt(b.getAttribute("tileheight"));var l=b.getElementsByTagName("properties")[0],k=b.getElementsByTagName("tileset"),g=b.getElementsByTagName("layer"),h=b.getElementsByTagName("objectgroup"),m,e,j,n,f;if(l){for(f=0;f<l.childNodes.length;f++){if(l.hasChildNodes()===true){m=l.childNodes[f];if(m.nodeType===1){if(a.properties){a.properties.add(m)}else{a.properties=tmxPropertySet();a.properties.add(m)}}}}}if(k){for(f=0;f<k.length;f++){e=k[f];a.tileSets[e.getAttribute("name")]=tmxTileSet();a.tileSets[e.getAttribute("name")].load(e,a)}}if(g){for(f=0;f<g.length;f++){j=g[f];a.layers[j.getAttribute("name")]=tmxLayer();a.layers[j.getAttribute("name")].load(j,a)}}if(h){for(f=0;f<h.length;f++){n=h[f];a.objectGroups[n.getAttribute("name")]=tmxObjectGroup();a.objectGroups[n.getAttribute("name")].load(n,a)}}};a.getTileSet=function(c){return a.tileSets[c]};a.getLayer=function(c){return a.layers[c]};a.getObjectGroup=function(c){return a.objectGroups[c]};a.getGidOwner=function(d){var e=null;for(var c in a.tileSets){if(c.hasGid(d)){return c}}return null};return a};var tmxObject=function(a,e){var f={};f.group=e;f.name=a.getAttribute("name");f.type=a.getAttribute("type");f.x=parseInt(a.getAttribute("x"));f.y=parseInt(a.getAttribute("y"));f.width=parseInt(a.getAttribute("width"));f.height=parseInt(a.getAttribute("height"));f.shared=null;f.gid=-1;if(a.getAttribute("gid")&&a.getAttribute("gid").length!==0){f.gid=parseInt(a.getAttribute("gid"));var h=f.group.map.tileSets,d,c;if(h){for(c=0;c<h.length;c=c+1){d=h[c];f.shared=d.getPropertiesByGid(f.gid);if(f.shared){break}}}}var b=a.getElementsByTagName("properties")[0],g,c;if(b){for(c=0;c<b.childNodes.length;c=c+1){if(b.hasChildNodes()===true){g=b.childNodes[c];if(g.nodeType===1){if(f.custom){f.custom.add(g)}else{f.custom=tmxPropertySet();f.custom.add(g)}}}}}return f};var tmxObjectGroup=function(){var a={};a.map;a.name;a.x;a.y;a.width;a.height;a.opacity;a.visible;a.properties=null;a.objects=[];a.load=function(h,e){a.map=e;a.name=h.getAttribute("name");a.x=parseInt(h.getAttribute("x"));a.y=parseInt(h.getAttribute("y"));a.width=parseInt(h.getAttribute("width"));a.height=parseInt(h.getAttribute("height"));a.visible=!h.getAttribute("visible")||(h.getAttribute("visible")!==0);a.opacity=parseInt(h.getAttribute("opacity"));var d=h.getElementsByTagName("properties")[0],g=h.getElementsByTagName("object"),f,b,c;if(d){for(c=0;c<d.childNodes.length;c=c+1){if(d.hasChildNodes()===true){f=d.childNodes[c];if(f.nodeType===1){if(a.properties){a.properties.add(f)}else{a.properties=tmxPropertySet();a.properties.add(f)}}}}}if(g){for(c=0;c<g.length;c=c+1){b=g[c];a.objects.push(tmxObject(b,a))}}};return a};var tmxPropertySet=function(){var a=[];a.add=function(c){var b=c.getAttribute("name"),d=c.getAttribute("value");a[b]=d};return a};var tmxTileSet=function(){var b={},a=[],c=null;b.firstGID=0;b.map;b.name;b.tileWidth;b.tileHeight;b.spacing;b.margin;b.imageSource;b.numTiles=16777215;b.numRows=1;b.numCols=1;b.load=function(m,h){b.map=h;b.firstGID=parseInt(m.getAttribute("firstgid"));b.imageSource=m.getElementsByTagName("image")[0].getAttribute("source");b.name=m.getAttribute("name");b.tileWidth=parseInt(m.getAttribute("tilewidth"));b.tileHeight=parseInt(m.getAttribute("tileheight"));b.spacing=parseInt(m.getAttribute("spacing"));b.margin=parseInt(m.getAttribute("margin"));var d=m.getElementsByTagName("tile"),k,g,l,f,e;if(d){for(f=0;f<d.length;f++){k=d[f];g=k.getElementsByTagName("properties")[0];if(g){for(e=0;e<g.childNodes.length;e++){if(g.hasChildNodes()===true){l=g.childNodes[e];if(l.nodeType===1){a[k.getAttribute("id")]=tmxPropertySet();a[k.getAttribute("id")].add(l)}}}}}}};b.getImage=function(){return c};b.setImage=function(d){c=d;b.numCols=Math.floor(c.width/b.tileWidth);b.numRows=Math.floor(c.height/b.tileHeight);b.numTiles=b.numRows*b.numCols};b.hasGid=function(d){return(d>=b.firstGID)&&(d<b.firstGID+b.numTiles)};b.fromGid=function(d){return d-b.firstGID};b.toGid=function(d){return b.firstGID+d};b.getPropertiesByGid=function(d){return a[d-b.firstGID]};b.getProperties=function(d){return a[d]};b.getRect=function(d){return new FMENGINE.fmRectangle(0,0,(d%b.numCols)*b.tileWidth,(d/b.numCols)*b.tileHeight)};return b};FMENGINE.fmEmitterComponent=function(h,d){var l=FMENGINE.fmComponent(FMENGINE.fmComponentTypes.FX,d),q=[],i=h,m=[FMENGINE.fmParameters.LEFT,FMENGINE.fmParameters.RIGHT,FMENGINE.fmParameters.UP,FMENGINE.fmParameters.DOWN],j=0,n=0.1,g=0,f=1,o=FMENGINE.fmVector(-100,-100),b=FMENGINE.fmVector(100,100),p=-100,a=100,e=false,c=0,k=d.components[FMENGINE.fmComponentTypes.SPATIAL];l.add=function(r){q.push(r);return r};l.createParticles=function(u,t,s,C,w,A){var v,y,x,z,B,r=FMENGINE.fmGame.getCurrentState();f=w;for(v=0;v<u;v=v+1){y=FMENGINE.fmGameObject(A);x=FMENGINE.fmSpatialComponent(x.position.x+i.x,x.position.y+i.y,y);y.addComponent(x);z=FMENGINE.fmSpriteRendererComponent(t,s,C,y);z.setAlpha(f);y.addComponent(z);B=FMENGINE.fmAabbComponent(s,C,y);y.addComponent(B);y.age=0;y.lifeSpan=0;y.hide();y.kill();r.add(y);q.push(y)}};l.emit=function(t,r,u){e=true;c=0;n=r;g=u;var s;for(s=0;s<q.length;s=s+1){q[s].lifeSpan=t}};l.update=function(s){if(e){var v,u,x,w,r,z,y,t;for(v=0;v<q.length;v=v+1){w=q[v];if(w.isAlive()){if(w.age>=w.lifeSpan){w.hide();w.kill()}else{y=w.getComponent(FMENGINE.fmComponentTypes.RENDERER);if(y.getAlpha()>=1-(w.age/w.lifeSpan)){y.setAlpha(1-(w.age/w.lifeSpan))}w.age+=s}}}c+=s;if(n===0||c>=n){c=0;x=0;u=0;while(x<g&&u<q.length){w=q[u];if(w&&!w.isAlive()){r=w.getComponent(FMENGINE.fmComponentTypes.SPATIAL);z=w.components[FMENGINE.fmComponentTypes.PHYSIC];w.components[FMENGINE.fmComponentTypes.RENDERER].setAlpha(f);r.position.x=k.position.x+i.x;r.position.y=k.position.y+i.y;w.age=0;t=Math.random()*(b.x-o.x)+o.x;if(m.indexOf(FMENGINE.fmParameters.LEFT)!==-1){if(Math.random()>0.5){t=-t}}z.velocity.x=t;t=Math.random()*(b.y-o.y)+o.y;if(m.indexOf(FMENGINE.fmParameters.UP)!==-1){if(Math.random()>0.5){t=-t}}z.velocity.y=t;t=Math.random()*(a-p)+p;z.angularVelocity=t;w.show();w.revive();x=x+1}u=u+1}}}};l.setDirections=function(r){m=r};l.setAlpha=function(r){f=r;var s;for(s=0;s<q.length;s=s+1){q[s].components[FMENGINE.fmComponentTypes.RENDERER].setAlpha(f)}};l.setXVelocity=function(s,r){o.x=s;b.x=r};l.setYVelocity=function(s,r){o.y=s;b.y=r};l.setAngularVelocity=function(s,r){p=s;a=r};l.getAlpha=function(){return f};l.destroy=function(){q=null;l=null};return l};FMENGINE.fmSimplePathComponent=function(b){var e=FMENGINE.fmComponent(FMENGINE.fmComponentTypes.PATHFINDING,b),k=[],g=0,m=FMENGINE.fmVector(0,0),a=FMENGINE.fmVector(0,0),c=false,l=false,f=false,j=FMENGINE.fmVector(0,0),i=1,d=b.components[FMENGINE.fmComponentTypes.SPATIAL],h=b.components[FMENGINE.fmComponentTypes.RENDERER],n=b.components[FMENGINE.fmComponentTypes.PHYSIC];e.startFollowingPath=function(q,o){if(k.length>0){c=true;g=o||0;l=false;f=false;m=q;var s=Math.abs((d.position.x+n.offset.x+n.width/2)-k[g].x),r=Math.abs((d.position.y+n.offset.y+n.height/2)-k[g].y),p;if(s<r){p=s/r;a.x=m*p;a.y=m}else{if(s>r){p=r/s;a.x=m;a.y=m*p}else{a.x=m;a.y=m}}}else{if(FMENGINE.fmParameters.debug){console.log("WARNING: path with no waypoints defined.")}}if(!n){console.log("WARNING: path added to a game object with no physic component.")}};e.resumeFollowingPath=function(){if(k.length>0){c=true;if(j.x!==d.position.x||j.y!==d.position.y){l=false;f=false;var q=Math.abs((d.position.x+n.offset.x+n.width/2)-k[g].x),p=Math.abs((d.position.y+n.offset.y+n.height/2)-k[g].y),o;if(q<p){o=q/p;a.x=m*o;a.y=m}else{if(q>p){o=p/q;a.x=m;a.y=m*o}else{a.x=m;a.y=m}}}}else{if(FMENGINE.fmParameters.debug){console.log("WARNING: path with no waypoints defined.")}}if(!n){console.log("WARNING: path added to a game object with no physic component.")}};e.stopFollowingPath=function(){c=false;n.velocity.x=0;n.velocity.y=0;j=FMENGINE.fmVector(d.position.x,d.position.y)};e.clearPath=function(){k=[]};e.update=function(r){if(c&&n){var s=d.position.x+n.offset.x+n.width/2,q=d.position.y+n.offset.y+n.height/2,t,p,o;if(s<k[g].x){if(k[g].x-s<a.x*r){n.velocity.x=k[g].x-s;l=true}else{n.velocity.x=a.x}}else{if(s>k[g].x){if(s-k[g].x<a.x*r){n.velocity.x=s-k[g].x;l=true}else{n.velocity.x=-a.x}}else{l=true;n.velocity.x=0}}if(q<k[g].y){if(k[g].y-q<a.y*r){n.velocity.y=k[g].y-q;f=true}else{n.velocity.y=a.y}}else{if(q>k[g].y){if(q-k[g].y<a.y*r){n.velocity.y=q-k[g].y;f=true}else{n.velocity.y=-a.y}}else{f=true;n.velocity.y=0}}if(l&&f){if(k.length>g+1){l=false;f=false;g=g+1;t=Math.abs(s-k[g].x);p=Math.abs(q-k[g].y);if(t<p){o=t/p;a.x=m*o;a.y=m}else{if(t>p){o=p/t;a.x=m;a.y=m*o}else{a.x=m;a.y=m}}}else{c=false;a=FMENGINE.fmVector(0,0);if(n){n.velocity=FMENGINE.fmVector(0,0)}}}}};e.add=function(q,o,p){if(p===undefined){k.push({x:q,y:o})}else{k[p]={x:q,y:o}}};e.remove=function(o){k.splice(o,1)};e.getWaypoints=function(){return k};e.getCurrentIndex=function(){return g};e.getCurrentWaypoint=function(){return k[g]};e.getLength=function(){return k.length};e.isLastWaypointReached=function(){return g===k.length-1&&!c};e.isActive=function(){return c};e.destroy=function(){k=null;d=null;h=null;n=null;e.destroy();e=null};return e};FMENGINE.fmAabbComponent=function(a,e,d){var c=Object.create(FMENGINE.fmPhysicComponent(a,e,d)),b=d.components[FMENGINE.fmComponentTypes.SPATIAL];c.update=function(f){Object.getPrototypeOf(c).update(f)};c.checkWorldCollisions=function(o,q){var m=b.position.x+c.offset.x,f=b.position.y+c.offset.y,p,n,h,s,g,r,l,k;if(q.length>0){if((q.length>0&&m<=q[0])||(q.length>1&&m+c.width>=q[1])||(q.length>2&&f<=q[2])||(q.length>3&&f+c.height>=q[3])){return true}}if(o.length>0){p=o.getTileWidth();n=o.getTileHeight();h=Math.floor(f/n);s=Math.floor(m/p);g=Math.floor((f+c.height)/n);r=Math.floor((m+c.width)/p);for(l=h;l<=g;l=l+1){for(k=s;k<=r;k=k+1){if(o[l]&&o[l][k]===1){if(k===s||k===r||l===h||l===g){return true}}}}}return false};c.collides=function(f){var g=f.collidesWithAabb(c);if(g){return g}return null};c.collidesWithAabb=function(j){var s=j.owner.components[FMENGINE.fmComponentTypes.SPATIAL],i=FMENGINE.fmVector(b.position.x+c.offset.x,b.position.y+c.offset.y),q=FMENGINE.fmVector(s.position.x+j.offset.x,s.position.y+j.offset.y),n=FMENGINE.fmVector(i.x+c.width,i.y+c.height),g=FMENGINE.fmVector(q.x+j.width,q.y+j.height),f=FMENGINE.fmVector(i.x+c.width/2,i.y+c.height/2),h=FMENGINE.fmVector(q.x+j.width/2,q.y+j.height/2),l=FMENGINE.fmMathUtils.substractVectors(h,f),r=(n.x-i.x)/2,k=(g.x-q.x)/2,p=r+k-Math.abs(l.x),m,o=null;if(n.x<q.x||i.x>g.x){return null}if(n.y<q.y||i.y>g.y){return null}if(p>0){r=(n.y-i.y)/2;k=(g.y-q.y)/2;m=r+k-Math.abs(l.y);if(m>0){o=FMENGINE.fmCollision();o.a=c;o.b=j;if(p<m){if(l.x<0){o.normal=l.reset(-1,0)}else{o.normal=l.reset(1,0)}o.penetration=p}else{if(l.y<0){o.normal=l.reset(0,-1)}else{o.normal=l.reset(0,1)}o.penetration=m}return o}}return null};c.collidesWithCircle=function(l){var r=l.owner.components[FMENGINE.fmComponentTypes.SPATIAL],s=FMENGINE.fmVector(b.position.x+c.offset.x,b.position.y+c.offset.y),o=FMENGINE.fmVector(r.position.x+l.offset.x,r.position.y+l.offset.y),t=FMENGINE.fmVector(s.x+c.width,s.y+c.height),q=FMENGINE.fmVector(o.x+l.width,o.y+l.height),v=FMENGINE.fmVector(s.x+c.width/2,s.y+c.height/2),k=FMENGINE.fmVector(o.x+l.radius,o.y+l.radius),n=0,w=FMENGINE.fmMathUtils.substractVectors(k,v),f,h,i,p=w.clone(),j=(t.x-s.x)/2,g=(t.y-s.y)/2,u=false,m=null;p.x=FMENGINE.fmMathUtils.clamp(p.x,-j,j);p.y=FMENGINE.fmMathUtils.clamp(p.y,-g,g);if(w.isEquals(p)){u=true;if(Math.abs(w.x)>Math.abs(w.y)){if(p.x>0){p.x=j}else{p.x=-j}}else{if(p.y>0){p.y=g}else{p.y=-g}}}m=FMENGINE.fmCollision();m.a=c;m.b=l;m.normal=FMENGINE.fmMathUtils.substractVectors(w,p);h=m.normal.getLengthSquared();i=l.radius;if(h>i*i&&!u){return null}h=Math.sqrt(h);m.penetration=i-h;if(u){m.normal.reset(-m.normal.x,-m.normal.y)}m.normal.normalize();return m};c.sqDistPointAABB=function(h){var l=0,g,f=b.position.x+c.offset.x,j=f+c.width,k=b.position.y+c.offset.y,i=k+c.height;g=h.x;if(g<f){l+=(f-g)*(f-g)}if(g>j){l+=(g-j)*(g-j)}g=h.y;if(g<k){l+=(k-g)*(k-g)}if(g>i){l+=(g-i)*(g-i)}return l};c.drawDebug=function(f,g){Object.getPrototypeOf(c).drawDebug(f);f.strokeStyle="#f4f";f.strokeRect(g.x+c.offset.x-f.xOffset,g.y+c.offset.y-f.yOffset,c.width,c.height)};c.destroy=function(){b=null;c=null};return c};FMENGINE.fmCircleComponent=function(d,c){var b=Object.create(FMENGINE.fmPhysicComponent(d*2,d*2,c)),a=c.components[FMENGINE.fmComponentTypes.SPATIAL];b.radius=d;b.update=function(e){Object.getPrototypeOf(b).update(e)};b.checkWorldCollisions=function(n,p){var l=a.position.x+b.offset.x,e=a.position.y+b.offset.y,o,m,g,r,f,q,k,h;if(p.length>0){if((p.length>0&&l<=p[0])||(p.length>1&&l+b.radius*2>=p[1])||(p.length>2&&e<=p[2])||(p.length>3&&e+b.radius*2>=p[3])){return true}}if(n.length>0){o=n.getTileWidth();m=n.getTileHeight();g=Math.floor(e/m);r=Math.floor(l/o);f=Math.floor((e+b.radius*2)/m);q=Math.floor((l+b.radius*2)/o);for(k=g;k<=f;k=k+1){for(h=r;h<=q;h=h+1){if(n[k]&&n[k][h]===1){if(h===r||h===q||k===g||k===f){return true}}}}}return false};b.collides=function(e){var f=e.collidesWithCircle(b);if(f){return f}return null};b.collidesWithAabb=function(m){var q=m.owner.components[FMENGINE.fmComponentTypes.SPATIAL],r=FMENGINE.fmVector(a.position.x+b.offset.x,a.position.y+b.offset.y),n=FMENGINE.fmVector(q.position.x+m.offset.x,q.position.y+m.offset.y),s=FMENGINE.fmVector(r.x+b.width,r.y+b.height),p=FMENGINE.fmVector(n.x+m.width,n.y+m.height),u=FMENGINE.fmVector(r.x+b.radius,r.y+b.radius),j=FMENGINE.fmVector(n.x+m.width/2,n.y+m.height/2),l=0,v=FMENGINE.fmMathUtils.substractVectors(j,u),e,g,h,o=v.clone(),i=(p.x-n.x)/2,f=(p.y-n.y)/2,t=false,k=null;o.x=FMENGINE.fmMathUtils.clamp(o.x,-i,i);o.y=FMENGINE.fmMathUtils.clamp(o.y,-f,f);if(v.isEquals(o)){t=true;if(Math.abs(v.x)>Math.abs(v.y)){if(o.x>0){o.x=i}else{o.x=-i}}else{if(o.y>0){o.y=f}else{o.y=-f}}}k=FMENGINE.fmCollision();k.a=b;k.b=m;k.normal=FMENGINE.fmMathUtils.substractVectors(v,o);g=k.normal.getLengthSquared();h=b.radius;if(g>(h*h)&&!t){return null}g=Math.sqrt(g);k.penetration=h-g;if(t){k.normal.reset(-k.normal.x,-k.normal.y)}k.normal.normalize();return k};b.sqDistPointAABB=function(k){var l=0,m,n=k.owner.components[FMENGINE.fmComponentTypes.SPATIAL],j=FMENGINE.fmVector(a.position.x+b.offset.x,a.position.y+b.offset.y),i=FMENGINE.fmVector(j.x+b.radius,j.y+b.radius),h=n.position.x+k.offset.x,f=h+k.width,g=n.position.y+k.offset.y,e=g+k.height;m=i.x;if(m<h){l+=(h-m)*(h-m)}if(m>f){l+=(m-f)*(m-f)}m=i.y;if(m<g){l+=(g-m)*(g-m)}if(m>e){l+=(m-e)*(m-e)}return l};b.collidesWithCircle=function(g){var n=g.owner.components[FMENGINE.fmComponentTypes.SPATIAL],i=FMENGINE.fmVector(a.position.x+b.offset.x,a.position.y+b.offset.y),m=FMENGINE.fmVector(n.position.x+g.offset.x,n.position.y+g.offset.y),e=FMENGINE.fmVector(i.x+b.width/2,i.y+b.height/2),h=FMENGINE.fmVector(m.x+g.width/2,m.y+g.height/2),j=b.radius+g.radius,j=j*j,k=FMENGINE.fmMathUtils.substractVectors(h,e),f=k.getLength(),l=null;if(k.getLengthSquared()>j){return null}else{l=FMENGINE.fmCollision();l.a=b;l.b=g;if(f!==0){l.penetration=j-f;l.normal=k.reset(k.x/f,k.y/f)}else{l.penetration=b.radius;l.normal=k.reset(1,0)}return l}return null};b.drawDebug=function(f,g){Object.getPrototypeOf(b).drawDebug(f);var e=FMENGINE.fmVector(g.x+b.radius,g.y+b.radius);f.beginPath();f.strokeStyle="#f4f";f.arc((e.x+b.offset.x)-f.xOffset,(e.y+b.offset.y)-f.yOffset,b.radius,0,2*Math.PI,false);f.stroke()};b.destroy=function(){a=null;allowCollisions=null;b=null};return b};FMENGINE.fmPhysicComponent=function(c,j,b){var g=FMENGINE.fmComponent(FMENGINE.fmComponentTypes.PHYSIC,b),f=FMENGINE.fmGame.getCurrentState().getWorld(),k=FMENGINE.fmGame.getCurrentState().getQuad(),a=FMENGINE.fmVector(0,0),i=0,h=[],e=b.components[FMENGINE.fmComponentTypes.SPATIAL],d=function(r){var l=FMENGINE.fmVector(r.penetration*r.normal.x,r.penetration*r.normal.y),q=r.a.owner.components[FMENGINE.fmComponentTypes.SPATIAL],p=r.b.owner.components[FMENGINE.fmComponentTypes.SPATIAL],o=0,m=0,n=0;if(r.a.mass===0){m=0}else{m=1/r.a.mass}if(r.b.mass===0){n=0}else{n=1/r.b.mass}o=m+n;q.position.x-=l.x*(m/o);q.position.y-=l.y*(m/o);p.position.x+=l.x*(n/o);p.position.y+=l.y*(n/o)};g.offset=FMENGINE.fmVector(0,0);g.width=c;g.height=j;g.collidesWith=[];g.velocity=FMENGINE.fmVector(0,0);g.angularVelocity=0;g.mass=1;g.maxVelocity=FMENGINE.fmVector(10000,10000);g.maxAngularVelocity=10000;g.friction=0;g.elasticity=0;g.applyForce=function(l,m){a.x+=l;a.y+=m};g.update=function(l){h=[];var m=1/g.mass,o,n;if(g.mass===0){m=0}o=g.velocity.x+(m*a.x)*l;n=g.maxVelocity.x+(m*a.x)*l;if(Math.abs(o)<=n){g.velocity.x=o}else{if(o<0){g.velocity.x=-n}else{if(o>0){g.velocity.x=n}}}o=g.velocity.y+(m*a.y)*l;n=g.maxVelocity.y+(m*a.y)*l;if(Math.abs(o)<=n){g.velocity.y=o}else{if(o<0){g.velocity.y=-n}else{if(o>0){g.velocity.y=n}}}e.position.x+=g.velocity.x*l;e.position.y+=g.velocity.y*l;a.x=0;a.y=0;var v,s,q,p,u,r,t=null;if(g.collidesWith.length>0){v=FMENGINE.fmGame.getCurrentState().getQuad();s=[];v.retrieve(s,b);for(q=0;q<s.length;q=q+1){u=s[q];r=u.components[FMENGINE.fmComponentTypes.PHYSIC];if(u.isAlive()&&r&&b.getId()!==u.getId()&&!r.isCollidingWith(b)&&!g.isCollidingWith(u)){for(p=0;p<g.collidesWith.length;p=p+1){if(u.hasType(g.collidesWith[p])){t=b.components[FMENGINE.fmComponentTypes.PHYSIC].collides(r);if(t!==null){g.addCollision(t);r.addCollision(t);g.resolveCollision(r,t);r.resolveCollision(g,t);d(t)}}}}}}};g.resolveCollision=function(p,s){var m=FMENGINE.fmMathUtils.substractVectors(p.velocity,g.velocity),r=m.dotProduct(s.normal),q=Math.min(g.elasticity,p.elasticity),o=0,n=0,t=0,l=FMENGINE.fmVector(0,0);if(r>0){return}if(g.mass===0){n=0}else{n=1/g.mass}if(p.mass===0){t=0}else{t=1/p.mass}o=-(1+q)*r;o/=n+t;l.reset(o*s.normal.x,o*s.normal.y);g.velocity.x-=n*l.x;g.velocity.y-=n*l.y;p.velocity.x+=t*l.x;p.velocity.y+=t*l.y};g.addTypeToCollideWith=function(l){g.collidesWith.push(l)};g.removeTypeToCollideWith=function(l){g.collidesWith.splice(g.collidesWith.indexOf(l),1)};g.addCollision=function(l){h.push(l)};g.drawDebug=function(l,m){};g.getLinearVelocity=function(){return g.velocity};g.isCollidingWithType=function(m){var l,n;for(l=0;l<h.length;l=l+1){n=h[l];if((n.b&&n.b.owner.hasType(m))||(n.a&&n.a.owner.hasType(m))){return true}}return false};g.isCollidingWith=function(n){var m,o,l=b;for(m=0;m<h.length;m=m+1){o=h[m];if((o.b&&o.b.owner.getId()===n.getId())||(o.a&&o.a.owner.getId()===n.getId())){return true}}return false};return g};FMENGINE.fmAnimatedSpriteRendererComponent=function(m,o,f,a){var h=FMENGINE.fmComponent(FMENGINE.fmComponentTypes.RENDERER,a),n=m,k=n.width,t=n.height,q=o,j=f,d=1,b="",g=false,v=0,i=0,l=[],e=0,r=0,u=0.1,p=0.1,s=[],c=a.components[FMENGINE.fmComponentTypes.SPATIAL];h.finished=false;h.addAnimation=function(x,y,w,z,A){e=0;b=x;l[x]=y;u=1/w;g=z;p=u;s[x]=A};h.play=function(w){k=n.width;t=n.height;b=w;h.finished=false;e=0;v=l[b][e]*q;i=Math.floor(v/k)*j;if(v>=k){i=Math.floor(v/k)*j;v=(v%k)}};h.stop=function(){h.finished=true};h.draw=function(w,x){var A=x.x,z=x.y,y=(new Date()).getTime()/1000;A-=w.xOffset*a.scrollFactor.x;z-=w.yOffset*a.scrollFactor.y;w.globalAlpha=d;if(c.angle!==0){w.save();w.translate(A,z);w.translate(q/2,j/2);w.rotate(c.angle);w.drawImage(n,v,i,q,j,-q/2,-j/2,q,j);w.restore()}else{w.drawImage(n,v,i,q,j,A,z,q,j)}w.globalAlpha=1;if(!h.finished){if(p<=0){p=u;if(l[b]){if(l[b].length>1){e=e+1;if(l[b]&&(e===l[b].length-1)){if(s[b]){e=0}else{h.finished=true}}}else{h.finished=true}v=l[b][e]*q;i=Math.floor(v/k)*j;if(v>=k){i=Math.floor(v/k)*j;v=(v%k)}}}else{p-=y-r}}r=y};h.destroy=function(){n.destroy();n=null;b=null;l=null;s=null;c=null;h.destroy();h=null};h.getCurrentAnim=function(){return b};h.setWidth=function(w){q=w};h.setHeight=function(w){j=w};h.setAlpha=function(w){d=w};h.getWidth=function(){return q};h.getHeight=function(){return j};h.getAlpha=function(){return d};return h};FMENGINE.fmBoxRendererComponent=function(c,i,f,b){var h=FMENGINE.fmComponent(FMENGINE.fmComponentTypes.RENDERER,b),a=c,j=i,e=f,d=1,g=b.components[FMENGINE.fmComponentTypes.SPATIAL];h.draw=function(k,l){var n=l.x,m=l.y;n-=k.xOffset*b.scrollFactor.x;m-=k.yOffset*b.scrollFactor.y;k.globalAlpha=d;if(g.angle!==0){k.save();k.translate(n,m);k.translate(a/2,j/2);k.rotate(g.angle);k.beginPath();k.rect(n,m,a,j);k.restore()}else{k.beginPath();k.rect(n,m,a,j)}k.fillStyle=e;k.fill();k.globalAlpha=1};h.destroy=function(){g=null;h.destroy();h=null};h.setWidth=function(k){a=k};h.setHeight=function(k){j=k};h.setColor=function(k){e=k};h.setAlpha=function(k){d=k};h.getWidth=function(){return a};h.getHeight=function(){return j};h.getColor=function(){return e};h.getAlpha=function(){return d};return h};FMENGINE.fmCircleRendererComponent=function(f,e,b){var h=FMENGINE.fmComponent(FMENGINE.fmComponentTypes.RENDERER,b),a=f*2,i=f*2,d=e,c=1,g=b.components[FMENGINE.fmComponentTypes.SPATIAL];h.draw=function(k,l){var n=l.x-k.xOffset*b.scrollFactor.x,m=l.y-k.yOffset*b.scrollFactor.y,j=FMENGINE.fmVector(n+a/2,m+i/2);k.globalAlpha=c;if(g.angle!==0){k.save();k.translate(n,m);k.translate(a/2,i/2);k.rotate(g.angle);k.beginPath();k.arc(j.x,j.y,a/2,0,2*Math.PI);k.restore()}else{k.beginPath();k.arc(j.x,j.y,a/2,0,2*Math.PI)}k.fillStyle=d;k.fill();k.globalAlpha=1};h.destroy=function(){g=null;h.destroy();h=null};h.setWidth=function(j){a=j;i=j};h.setHeight=function(j){i=j;a=j};h.setRadius=function(j){a=j*2;i=j*2};h.setColor=function(j){d=j};h.setAlpha=function(j){c=j};h.getWidth=function(){return a};h.getHeight=function(){return i};h.getRadius=function(){return a/2};h.getColor=function(){return d};h.getAlpha=function(){return c};return h};FMENGINE.fmLineRendererComponent=function(f,e,b){var i=FMENGINE.fmComponent(FMENGINE.fmComponentTypes.RENDERER,b),j=[],a=0,k=0,g=f,d=e,c=1,h=b.components[FMENGINE.fmComponentTypes.SPATIAL];i.draw=function(l,n){var p=n.x,o=n.y,m;p-=l.xOffset*b.scrollFactor.x;o-=l.yOffset*b.scrollFactor.y;l.globalAlpha=c;if(h.angle!==0){l.save();l.translate(p,o);l.translate(a/2,k/2);l.rotate(h.angle);if(j.length>0){l.beginPath();l.moveTo(j[0].x,j[0].y);for(m=1;m<j.length;m=m+1){l.lineTo(j[m].x,j[m].y)}}l.restore()}else{if(j.length>0){l.beginPath();l.moveTo(j[0].x,j[0].y);for(m=1;m<j.length;m=m+1){l.lineTo(j[m].x,j[m].y)}}}l.strokeStyle=d;l.lineWidth=g;l.stroke();l.globalAlpha=1;l.lineWidth=1};i.destroy=function(){h=null;i.destroy();var l;for(l=0;l<j.length;l=l+1){j[l].destroy()}j=null;i=null};i.addPoint=function(o){j.push(o);var p,l,n=0,r=0,m=0,q=0;for(p=0;p<j.length;p=p+1){l=j[p];if(l.x>n){n=l.x}if(l.x<r){r=l.x}if(l.y<m){m=l.y}if(l.y>q){q=l.y}}a=Math.abs(n-r);k=Math.abs(q-m)};i.setLineWidth=function(l){g=l};i.setLineStyle=function(l){d=l};i.setAlpha=function(l){c=l};i.getWidth=function(){return a};i.getHeight=function(){return k};i.getLineWidth=function(){return g};i.getLineStyle=function(){return d};i.getAlpha=function(){return c};return i};FMENGINE.fmSpriteRendererComponent=function(g,c,k,b){var i=FMENGINE.fmComponent(FMENGINE.fmComponentTypes.RENDERER,b),e=g,a=c,l=k,f=1,j=0,d=0,h=b.components[FMENGINE.fmComponentTypes.SPATIAL];i.draw=function(m,n){var p=n.x,o=n.y;p-=m.xOffset*b.scrollFactor.x;o-=m.yOffset*b.scrollFactor.y;m.globalAlpha=f;if(h.angle!==0){m.save();m.translate(p,o);m.translate(a/2,l/2);m.rotate(h.angle);m.drawImage(e,j,d,a,l,-a/2,-l/2,a,l);m.restore()}else{m.drawImage(e,j,d,a,l,p,o,a,l)}m.globalAlpha=1};i.destroy=function(){e.destroy();e=null;h=null;i.destroy();i=null};i.setImage=function(n,m,o){e=n;a=m;l=o};i.setXOffset=function(m){j=m};i.setYOffset=function(m){d=m};i.setWidth=function(m){a=m};i.setHeight=function(m){l=m};i.setAlpha=function(m){f=m};i.getWidth=function(){return a};i.getHeight=function(){return l};i.getAlpha=function(){return f};return i};FMENGINE.fmTextRendererComponent=function(f,e){var d=FMENGINE.fmComponent(FMENGINE.fmComponentTypes.RENDERER,e),c=e.components[FMENGINE.fmComponentTypes.SPATIAL],b=50,a=50;d.text=f;d.fillStyle="#fff";d.font="30px sans-serif";d.textBaseline="middle";d.setFormat=function(h,g,i){d.fillStyle=h;d.font=g;d.textBaseline=i};d.draw=function(g,h){var j=h.x,i=h.y;j-=g.xOffset*e.scrollFactor.x;i-=g.yOffset*e.scrollFactor.y;g.fillStyle=d.fillStyle;g.font=d.font;g.textBaseline=d.textBaseline;g.fillText(d.text,j,i)};d.destroy=function(){c=null;d.text=null;d.fillStyle=null;d.font=null;d.textBaseline=null;d.destroy();d=null};d.getWidth=function(){return b};d.getHeight=function(){return a};return d};FMENGINE.fmSoundComponent=function(c){var b=FMENGINE.fmComponent(FMENGINE.fmComponentTypes.SOUND,c),a=[];b.play=function(e,g,d){var f,h;for(f=0;f<a.length;f=f+1){h=a[f];if(h.getName()===e){h.volume=g;if(d){h.addEventListener("ended",function(){this.currentTime=0;this.play()},false)}h.play()}}};b.pause=function(d){var e,f;for(e=0;e<a.length;e=e+1){f=a[e];if(f.getName()===d){f.pause()}}};b.addSound=function(d){a.push(d)};b.destroy=function(){var d;for(d=0;d<a.length;d=d+1){a[d].destroy()}a=null;b.destroy();b=null};b.getSoundByName=function(d){var e,f;for(e=0;e<a.length;e=e+1){f=a[e];if(f.getName()===d){return f}}return null};return b};FMENGINE.fmSpatialComponent=function(b,a,d){var c=FMENGINE.fmComponent(FMENGINE.fmComponentTypes.SPATIAL,d);c.position=FMENGINE.fmVector(b,a);c.previous=FMENGINE.fmVector(b,a);c.angle=0;c.destroy=function(){c.position=null;c.previous=null;c.destroy();c=null};return c};