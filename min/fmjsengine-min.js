var FM=FM||{};FM.assetManager={assets:[],loadingProgress:0,addAsset:function(a,c,f){var d=FM.assetManager,g=FM.parameters,b=d.getAssetByName(a);if(c===g.IMAGE){if(!b){d.assets.push(FM.imageAsset(a,f))}}else{if(c===g.AUDIO){if(!b){var e=FM.audioAsset(a,f);if(e.isSupported()){d.assets.push(e)}else{if(FM.parameters.debug){console.log("WARNING: The "+f.substring(f.lastIndexOf(".")+1)+" audio format is not supported by this browser.")}}}}else{if(c===g.FILE){if(!b){d.assets.push(FM.fileAsset(a,f))}}}}},loadAssets:function(){var a,b=FM.assetManager;for(a=0;a<b.assets.length;a=a+1){b.assets[a].load()}},assetLoaded:function(){var a=FM.assetManager;a.loadingProgress+=100/a.assets.length},areAllAssetsLoaded:function(){return Math.round(FM.assetManager.loadingProgress)>=100},getAssetByName:function(a){var c=null,b=0,d=FM.assetManager;for(b=0;b<d.assets.length;b=b+1){if(d.assets[b].getName()===a){c=d.assets[b]}}return c}};FM.audioAsset=function(a,f){var e=new Audio(),d=a,g=f,h=g.substring(g.lastIndexOf(".")+1),c=false,b=function(){c=true;FM.assetManager.assetLoaded()};e.load=function(){e.src=g;e.addEventListener("loadeddata",b,false)};e.isLoaded=function(){return c};e.destroy=function(){d=null;g=null;e=null};e.getName=function(){return d};e.getPath=function(){return g};e.isSupported=function(){var i=false;if(h==="wav"){i=!!e.canPlayType&&e.canPlayType('audio/wav; codecs="1"')!==""}else{if(h==="ogg"){i=!!e.canPlayType&&e.canPlayType('audio/ogg; codecs="vorbis"')!==""}else{if(h==="mp3"){i=!!e.canPlayType&&e.canPlayType("audio/mpeg;")!==""}else{if(h==="aac"){i=!!e.canPlayType&&e.canPlayType('audio/mp4; codecs="mp4a.40.2"')!==""}}}}return i};return e};FM.parameters={FPS:60,libFolder:"lib",debug:false,COLLIDER_MINIMUM_SIZE:16,STATIC:"static",KINEMATIC:"kinematic",DYNAMIC:"dynamic",PIXELS_TO_METERS:30,IMAGE:"image",AUDIO:"audio",FILE:"file",LEFT:"left",RIGHT:"right",UP:"up",DOWN:"down",backgroundColor:"rgb(0,0,0)"};FM.circle=function(b,a,d){var c={};c.x=b;c.y=a;c.radius=d;c.destroy=function(){c=null};return c};FM.fileAsset=function(a,g){var f=new XMLHttpRequest(),d=a,h=g,e=null,c=false,b=function(){c=true;e=f.responseText;FM.assetManager.assetLoaded()};f.load=function(){f.addEventListener("load",b,false);f.open("GET",h,false);f.send()};f.isLoaded=function(){return c};f.destroy=function(){d=null;h=null;e=null;f=null};f.getName=function(){return d};f.getPath=function(){return h};f.getContent=function(){return e};return f};FM.game=(function(){var m={},G="",z=0,C=0,F=null,e="",d=null,j=null,a=null,E=0,u=0,v=1/FM.parameters.FPS,A=FM.parameters.FPS,b=FM.parameters.FPS,B=(new Date()).getTime()/1000,h=0,p=[],c=[],s=false,l=false,y=false,o=0,n=0,k=false,q=function(){d.clearRect(0,0,z,C);d.fillStyle=FM.parameters.backgroundColor;d.fillRect(0,0,z,C);var I=(new Date()).getTime()/1000,H=I-B,J=0;if(H>0.25){H=0.25}B=I;h+=H;if(!k){u+=H;while(h>=v){h-=v;F.updatePhysics(v)}J=h/v;F.update(H)}else{u+=v}E++;if(u>=1){b=E/u;E=0;u=0}A=Math.round(b);F.draw(a,J);if(k){a.fillStyle="rgba(99,99,99,0.5)";a.fillRect(0,0,z,C);a.fillStyle="rgba(255,255,255,1)";a.beginPath();a.moveTo(z/2+60,C/2);a.lineTo(z/2-60,C/2-60);a.lineTo(z/2-60,C/2+60);a.lineTo(z/2+60,C/2);a.fill();a.closePath()}if(FM.parameters.debug){a.fillStyle="#fcd116";a.font="30px sans-serif";a.textBaseline="middle";a.fillText(A,10,20)}d.drawImage(j,0,0);s=false;c=[];requestAnimationFrame(q)},r=function(H){p[H.keyCode]=1},w=function(I){var H=I.keyCode;c[H]=1;delete p[H]},t=function(H){o=H.clientX-H.target.offsetLeft;n=H.clientY-H.target.offsetTop},i=function(H){s=true},x=function(H){l=true;y=false},g=function(H){y=true;l=false},f=function(H){k=false},D=function(H){k=true};m.run=function(I,K,H,M,J,L){G=K;z=H;C=M;e=document.getElementById(I);if(L){F=L(J)}else{F=FM.preloader(J)}if(e&&e.getContext){d=e.getContext("2d");if(d){e.width=z;e.height=C;j=document.createElement("canvas");j.width=z;j.height=C;a=j.getContext("2d");a.xOffset=0;a.yOffset=0}}if(d&&a){e.onkeydown=function(N){r(N)};e.onkeyup=function(N){w(N)};e.onclick=function(N){i(N)};e.onmousedown=function(N){x(N)};e.onmouseup=function(N){g(N)};e.onmousemove=function(N){t(N)};e.onfocus=function(N){f(N)};e.onblur=function(N){D(N)};e.focus();F.init(m);requestAnimationFrame(q)}};(function(){var H,I=0,J=["ms","moz","webkit","o"];for(H=0;H<J.length&&!window.requestAnimationFrame;++H){window.requestAnimationFrame=window[J[H]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[J[H]+"CancelAnimationFrame"]||window[J[H]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(O,L){var K=new Date().getTime(),M=Math.max(0,16-(K-I)),N=window.setTimeout(function(){O(K+M)},M);I=K+M;return N}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(K){clearTimeout(K)}}}());m.switchState=function(H){F.destroy();F=H;F.init(m)};m.isKeyPressed=function(H){if(p[H]){return true}else{return false}};m.isKeyReleased=function(H){if(c[H]){return true}else{return false}};m.isMouseClicked=function(){return s};m.isMousePressed=function(){return l};m.isMouseReleased=function(){return y};m.getName=function(){return G};m.getMouseX=function(){return o+F.camera.x};m.getMouseY=function(){return n+F.camera.y};m.getMouseScreenX=function(){return o};m.getMouseScreenY=function(){return n};m.getScreenWidth=function(){return z};m.getScreenHeight=function(){return C};m.getCurrentState=function(){return F};return m}());FM.gameObject=function(e){var d={},g=0,a="",c=true,f=true,b=[];d.scrollFactor=FM.vector(1,1);d.components={};d.zIndex=e;d.addType=function(h){b.push(h)};d.removeType=function(h){b.splice(b.indexOf(h),1)};d.hasType=function(h){return b.indexOf(h)!==-1};d.addComponent=function(i){var h=i.name;if(!d.components[h]){d.components[h]=i}};d.getComponent=function(h){return d.components[h]};d.destroy=function(){a=null;d.scrollFactor=null;var h;for(h=0;h<d.components.length;h=h+1){d.components[h].destroy()}d.components=null;d=null};d.kill=function(){c=false};d.hide=function(){f=false};d.revive=function(){c=true};d.show=function(){f=true};d.getName=function(){return a};d.setName=function(h){a=h};d.getId=function(){return g};d.setId=function(h){g=h};d.isAlive=function(){return c};d.isVisible=function(){return f};return d};FM.imageAsset=function(a,f){var e=new Image(),d=a,g=f,c=false,b=function(){c=true;FM.assetManager.assetLoaded()};e.load=function(){e.src=g;e.addEventListener("load",b,false)};e.isLoaded=function(){return c};e.destroy=function(){d=null;g=null;e=null};e.getName=function(){return d};e.getPath=function(){return g};return e};FM.keyboard={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS:20,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DEL:46,ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,lLEFT_SPECIAL:91,RIGHT_SPECIAL:92,SELECT:93,NUM_ZERO:96,NUM_ONE:97,NUM_TWO:98,NUM_THREE:99,NUM_FOUR:100,NUM_FIVE:101,NUM_SIX:102,NUM_SEVEN:103,NUM_EIGHT:104,NUM_NINE:105,MULTIPLY:106,ADD:107,SUBSTRACT:109,DECIMAL_POINT:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,SEMICOLON:186,EQUAL_SIGN:187,COMMA:188,DASH:189,PERIOD:190,FORWARD_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,SINGLE_QUOTE:222};FM.math={addVectors:function(b,a){return FM.vector(b.x+a.x,b.y+a.y)},substractVectors:function(b,a){return FM.vector(b.x-a.x,b.y-a.y)},multiplyVectors:function(b,a){return FM.vector(b.x*a.x,b.y*a.y)},clamp:function(c,b,a){return Math.min(a,Math.max(b,c))},};FM.objectType=function(a){var e={},b=a,d=true,g=true,h=1,f=FM.vector(1,1),c=[];e.overlapsWithType=function(n){var l=FM.game.getCurrentState(),s=l.members,q,w=l.getQuad(),p,o,m,t,k,v,x,r,u=null;for(p=0;p<s.length;p=p+1){k=s[p];x=k.components[FM.componentTypes.PHYSIC];m=k.hasType(e);t=k.hasType(n);if(x&&m||t){q=w.retrieve(k);for(o=0;o<q.length;o=o+1){v=q[o];r=v.components[FM.componentTypes.PHYSIC];if(r&&k.getId()!==v.getId()&&((m&&v.hasType(n))||(t&&v.hasType(e)))){return u=x.overlapsWithObject(r)}}}}return null};e.overlapsWithObject=function(n){var j=FM.game.getCurrentState().getQuad(),o=j.retrieve(n),m,k,q,l,p=null;for(m=0;m<o.length;m=m+1){k=o[m];q=n.components[FM.componentTypes.PHYSIC];l=k.components[FM.componentTypes.PHYSIC];if(q&&l&&n.getId()!==k.getId()&&k.hasType(e)){return p=q.overlapsWithObject(l)}}return null};e.addTypeToCollideWith=function(k){c.push(k);var m=FM.game.getCurrentState().members,l,j,n;for(l=0;l<m.length;l=l+1){j=m[l];n=j.components[FM.componentTypes.PHYSIC];if(n&&j.hasType(e)){n.addTypeToCollideWith(k)}}};e.removeTypeToCollideWith=function(k){c.splice(c.indexOf(k),1);var m=FM.game.getCurrentState().members,l,j,n;for(l=0;l<m.length;l=l+1){j=m[l];n=j.components[FM.componentTypes.PHYSIC];if(n&&j.hasType(e)){n.removeTypeToCollideWith(k)}}};e.setZIndex=function(m){h=m;var l=FM.game.getCurrentState().members,k,j;for(k=0;k<l.length;k=k+1){j=l[k];if(j.hasType(e)){j.zIndex=h}}};e.setScrollFactor=function(l){f=l;var m=FM.game.getCurrentState().members,k,j;for(k=0;k<m.length;k=k+1){j=m[k];if(j.hasType(e)){j.scrollFactor=f}}};e.kill=function(){d=false};e.hide=function(){g=false};e.revive=function(){d=true};e.show=function(){g=true};e.isAlive=function(){return d};e.isVisible=function(){return g};e.destroy=function(){b=null;f=null;c=null;e=null};e.getName=function(){return b};return e};FM.rectangle=function(c,b,a,e){var d={};d.x=c;d.y=b;d.width=a;d.height=e;d.destroy=function(){d=null};return d};FM.state=function(){var d={},f=0,h=0,a=null,g=null,b=null,e=null,c=function(j,i){return(j.zIndex-i.zIndex)};d.members=[];FM.state.lastId=0;d.camera=FM.rectangle(0,0,0,0);d.init=function(j,i){f=FM.game.getScreenWidth();h=FM.game.getScreenHeight();e=FM.world(j||f,i||h);b=FM.quadTree(0,FM.rectangle(0,0,j||f,i||h));d.camera.width=f;d.camera.height=h;if(FM.parameters.debug){console.log("INIT: The state has been created.")}};d.add=function(i){if(i.components){d.members.push(i);i.setId(FM.state.lastId);FM.state.lastId+=1;if(i.components[FM.componentTypes.PHYSIC]){b.insert(i)}}else{if(FM.parameters.debug){console.log("ERROR: you're trying to add something elsethan a game object to the state. This is not allowed.")}}};d.remove=function(i){d.members.splice(d.members.indexOf(i),1);i.destroy()};d.sortByZIndex=function(){d.members.sort(c)};d.updatePhysics=function(k){var l,j,n,m,o;b.clear();for(l=0;l<d.members.length;l=l+1){j=d.members[l];if(j.isAlive()){n=j.components;o=j.components[FM.componentTypes.PHYSIC];if(o){b.insert(j)}}}for(l=0;l<d.members.length;l=l+1){j=d.members[l];if(j.isAlive()){n=j.components;m=n[FM.componentTypes.SPATIAL];o=n[FM.componentTypes.PHYSIC];if(o){m.previous=m.position;o.update(k)}}}};d.update=function(n){var p,l,s,t,w,x,k;for(p=0;p<d.members.length;p=p+1){l=d.members[p];if(l.isAlive()){s=l.components;t=s[FM.componentTypes.SPATIAL];w=s[FM.componentTypes.PHYSIC];x=s[FM.componentTypes.PATHFINDING];k=s[FM.componentTypes.FX];if(x){x.update(n)}if(k){k.update(n)}if(l.update){l.update(n)}if(w){if(a===l){var r,v=g.width,o=g.height,m=t.position.x+w.offset.x,q=t.position.y+w.offset.y,u=m+w.width,j=q+w.height;if(m<=g.x){r=d.camera.x-(g.x-m);if(r>=0){d.camera.x=r;g.x=m}}if(q<=g.y){r=d.camera.y-(g.y-q);if(r>=0){d.camera.y=r;g.y=q}}if(u>=g.x+v){r=d.camera.x+(u-(g.x+v));if(r+d.camera.width<=e.width){d.camera.x=r;g.x=u-v}}if(j>=g.y+o){r=d.camera.y+(j-(g.y+o));if(r+d.camera.height<=e.height){d.camera.y=r;g.y=j-o}}}}else{if(FM.parameters.debug&&a===l){console.log("ERROR: The scrolling object must have a physic component.")}}}}};d.draw=function(k,n){k.clearRect(0,0,f,h);k.xOffset=d.camera.x;k.yOffset=d.camera.y;var r,l,o,t,w,v;for(r=0;r<d.members.length;r=r+1){l=d.members[r];if(l.isVisible()||(FM.parameters.debug&&l.isAlive())){t=l.components[FM.componentTypes.SPATIAL];if(t){v=l.components[FM.componentTypes.RENDERER];o=FM.vector(t.position.x*n+t.previous.x*(1-n),t.position.y*n+t.previous.y*(1-n));if(v&&l.isVisible()){var m=o.x,s=o.y,u=m+v.getWidth(),j=s+v.getHeight(),q=0,p=0;q=(d.camera.x+(f-d.camera.width)/2)*l.scrollFactor.x;p=(d.camera.y+(h-d.camera.height)/2)*l.scrollFactor.y;if(u>=q&&j>=p&&m<=q+d.camera.width&&s<=p+d.camera.height){v.draw(k,o)}}if(FM.parameters.debug&&l.isAlive()){w=l.components[FM.componentTypes.PHYSIC];if(w){w.drawDebug(k,o)}}}}}if(FM.parameters.debug){k.strokeStyle="#f0f";k.strokeRect(0-d.camera.x,0-d.camera.y,e.width,e.height);k.strokeStyle="#8fc";k.strokeRect((f-d.camera.width)/2,(h-d.camera.height)/2,d.camera.width,d.camera.height);if(g){k.strokeStyle="#f4f";k.strokeRect(g.x-d.camera.x,g.y-d.camera.y,g.width,g.height)}}};d.centerCameraOn=function(i){var k=i.components[FM.componentTypes.SPATIAL],j=k.position.x-d.camera.width/2;if(j>e.x&&j<e.width){d.camera.x=j}j=k.position.y-d.camera.height/2;if(j>e.y&&j<e.height){d.camera.y=j}};d.centerCameraAt=function(k,j){var i=k-d.camera.width/2;if(i>e.x&&i<e.width){d.camera.x=i}i=j-d.camera.height/2;if(i>e.y&&i<e.height){d.camera.y=i}};d.follow=function(j,k,i){a=j;g=FM.rectangle((f-k)/2+d.camera.x,(h-i)/2+d.camera.y,k,i)};d.unFollow=function(){g=null;a=null};d.destroy=function(){var j;for(j=0;j<d.members.length;j=j+1){d.members[j].destroy()}d.members=null;a=null;if(g){g.destroy()}g=null;d.camera.destroy();d.camera=null;e.destroy();e=null;b.clear();b=null;d=null};d.getGameObjectById=function(l){var j,k;for(k=0;k<d.members.length;k=k+1){j=d.members[k];if(j.getId()===l){return j}}return null};d.getScroller=function(){return a};d.getWorld=function(){return e};d.getQuad=function(){return b};return d};FM.tileMap=function(p,e,n,b,a,j,k,d){var i={},g=[],f=p,c=e,o=n,m=b,h=a,l=k,q=d;i.load=function(r){var G=r.split("\n"),F=null,E=null,v=null,y=null,B=null,s=FM.game.getCurrentState(),z,C,D,A,u,x,w,t;for(x=0;x<G.length;x=x+1){F=G[x];if(F){E=[];v=F.split(",",c);for(w=0;w<v.length;w=w+1){y=v[w];if(y>0){B=FM.gameObject(l);for(t=0;t<j.length;t=t+1){B.addType(j[t])}z=FM.spatialComponent(w*m,x*h,B);B.addComponent(z);C=FM.spriteRendererComponent(f,m,h,B);A=y*m;u=Math.floor(A/f.width)*h;if(A>=f.width){u=Math.floor(A/f.width)*h;A=(A%f.width)}C.setXOffset(A);C.setYOffset(u);B.addComponent(C);if(q){D=FM.aabbComponent(m,h,B);Object.getPrototypeOf(D).mass=0;B.addComponent(D)}s.add(B)}E.push(y)}g.push(E)}}};i.destroy=function(){g=null;f=null;i=null};i.getData=function(){return g};i.getTileSet=function(){return f};i.getTileId=function(r,s){return g[Math.floor(s/h)][Math.floor(r/m)]};i.getWidth=function(){return c};i.getHeight=function(){return o};i.getTileWidth=function(){return m};i.getTileHeight=function(){return h};i.getZIndex=function(){return l};return i};FM.vector=function(b,a){var c={};c.x=typeof b==="undefined"?0:b;c.y=typeof a==="undefined"?0:a;c.add=function(d){c.x+=d.x;c.y+=d.y;return c};c.substract=function(d){c.x-=d.x;c.y-=d.y;return c};c.multiply=function(d){c.x*=d.x;c.y*=d.y;return c};c.dotProduct=function(d){return(c.x*d.x+c.y*d.y)};c.crossProd=function(d){return c.x*d.y-c.y*d.x};c.reset=function(e,d){c.x=typeof e==="undefined"?0:e;c.y=typeof d==="undefined"?0:d;return c};c.getLength=function(){return Math.sqrt((c.x*c.x)+(c.y*c.y))};c.getLengthSquared=function(){return(c.x*c.x)+(c.y*c.y)};c.normalize=function(){var d=c.getLength();c.x=c.x/d;c.y=c.y/d};c.copy=function(d){c.x=d.x;c.y=d.y;return c};c.clone=function(){return new FM.vector(c.x,c.y)};c.isEquals=function(d){return(c.x===d.x&&c.y===d.y)};c.destroy=function(){c=null};return c};FM.world=function(b,e){var c=FM.rectangle(0,0,b,e),d=FM.game.getCurrentState(),a;c.addCollisionTileMap=function(f){a=f};c.getCollisionTileMap=function(){return a};c.destroy=function(){d=null;c=null};return c};FM.collision=function(){var a={};a.a=null;a.b=null;a.penetration=0;a.normal=null;a.destroy=function(){a.normal=null;a=null};return a};FM.component=function(c,a){var b={};if(a.components!==undefined){b.name=c;b.owner=a}else{if(FM.parameters.debug){console.log("ERROR: the owner of the "+c+" component must be a gameObject.")}}b.destroy=function(){b.name=null;b.owner=null;b=null};return b};FM.componentTypes={SPATIAL:"spatial",PATHFINDING:"pathfinding",RENDERER:"renderer",PHYSIC:"physic",SOUND:"sound",FX:"fx"};FM.preloader=function(a){var b=Object.create(FM.state()),c,d;b.init=function(){Object.getPrototypeOf(b).init();c=FM.game.getScreenWidth();d=FM.game.getScreenHeight()};b.update=function(f){Object.getPrototypeOf(b).update(f);var e=FM.assetManager;if(e.assets.length===0||e.areAllAssetsLoaded()){FM.game.switchState(a())}};b.draw=function(e,f){Object.getPrototypeOf(b).draw(e,f);e.fillStyle="#fff";e.font="30px sans-serif";e.textBaseline="middle";e.fillText(Math.ceil(FM.assetManager.loadingProgress)+"%",c/2,d/2)};return b};FM.quadTree=function(f,k){var g={},j=10,e=5,c=f,i=[],a=k,b=[],d=function(l){var m=-1,p=l.components[FM.componentTypes.SPATIAL],s=l.components[FM.componentTypes.PHYSIC],o=a.x+(a.width/2),q=a.y+(a.height/2),n=(p.position.y<q&&p.position.y+s.height<q),r=(p.position.y>q);if(p.position.x<o&&p.position.x+s.width<o){if(n){m=1}else{if(r){m=2}}}else{if(p.position.x>o){if(n){m=0}else{if(r){m=3}}}}return m},h=function(){var m=a.width/2,n=a.height/2,l=a.x,o=a.y;b.push(FM.quadTree(c+1,FM.rectangle(l+m,o,m,n)));b.push(FM.quadTree(c+1,FM.rectangle(l,o,m,n)));b.push(FM.quadTree(c+1,FM.rectangle(l,o+n,m,n)));b.push(FM.quadTree(c+1,FM.rectangle(l+m,o+n,m,n)))};g.insert=function(l){if(b.length>0){var m=d(l);if(m!==-1){b[m].insert(l);return}}i.push(l);if(i.length>j&&c<e){if(b.length===0){h()}var n=0,m;while(n<i.length){m=d(i[n]);if(m!==-1){b[m].insert(i.splice(n,1)[0])}else{n=n+1}}}};g.retrieve=function(l){var o=[];var m=d(l);if(m!==-1&&b.length>0){o=b[m].retrieve(l)}var n;for(n=0;n<i.length;n=n+1){o.push(i[n])}return o};g.clear=function(){i=[];var l;for(l=0;l<b.length;l=l+1){if(b[l]){b[l].clear();b[l]=null}}b=[]};return g};if(typeof Object.create!=="function"){Object.create=function(b){function a(){}a.prototype=b;return new a()}}if(typeof Object.getPrototypeOf!=="function"){if(typeof"test".__proto__==="object"){Object.getPrototypeOf=function(a){return a.__proto__}}else{Object.getPrototypeOf=function(a){return a.constructor.prototype}}}FM.includeJsFile=function(b){var c=document.getElementsByTagName("head")[0],a=document.createElement("script");a=document.createElement("script");a.src=b;a.type="text/javascript";c.appendChild(a)};var tmxLayer=function(){var a={};a.map;a.name;a.x;a.y;a.width;a.height;a.opacity;a.visible;a.tileGids=[];a.properties=null;a.load=function(j,l){a.map=l;a.name=j.getAttribute("name");a.x=parseInt(j.getAttribute("x"));a.y=parseInt(j.getAttribute("y"));a.width=parseInt(j.getAttribute("width"));a.height=parseInt(j.getAttribute("height"));a.visible=!j.getAttribute("visible")||(j.getAttribute("visible")!==0);a.opacity=parseInt(j.getAttribute("opacity"));var h=j.getElementsByTagName("properties")[0],c=j.getElementsByTagName("data")[0],n=c.getElementsByTagName("tile"),m,g,d;if(h){for(d=0;d<h.childNodes.length;d++){if(h.hasChildNodes()===true){m=h.childNodes[d];if(m.nodeType===1){if(a.properties){a.properties.add(m)}else{a.properties=tmxPropertySet();a.properties.add(m)}}}}}if(c){var k="",f=a.width,b=-1,e;if(!c.getAttribute("encoding")||(c.getAttribute("encoding")&&c.getAttribute("encoding").length===0)){for(d=0;d<n.length;d=d+1){g=n[d];if(++f>=a.width){a.tileGids[++b]=[];f=0}e=g.getAttribute("gid");a.tileGids[b].push(e)}}else{if(c.getAttribute("encoding")==="csv"){k=c.childNodes[0].nodeValue;a.tileGids=a.csvToArray(k,a.width)}else{if(c.getAttribute("encoding")==="base64"){console.log("ERROR: TmxLoader, use XML or CSV export.")}}}}};a.toCsv=function(c){var g=16777215,e=0,l="",k=null,h="",b=0,f,d;if(c){e=c.firstGID;g=c.numTiles-1}for(f=0;f<a.tileGids.length;f=f+1){k=a.tileGids[f];h="";b=0;for(d=0;d<k.length;d=d+1){b=k[d];b-=e;if(b<0||b>g){b=0}l+=h;h=b+","}l+=b+"\n"}return l};a.csvToArray=function(f,e){var l=[],k=f.split("\n"),h=null,g=null,d=null,c,b;for(c=0;c<k.length;c=c+1){h=k[c];if(h){g=[];d=h.split(",",e);for(b=0;b<d.length;b=b+1){g.push(d[b])}l.push(g)}}return l};return a};var tmxMap=function(){var a={},b=null;a.version="unknown";a.orientation="orthogonal";a.width=0;a.height=0;a.tileWidth=0;a.tileHeight=0;a.properties=null;a.layers=[];a.tileSets=[];a.objectGroups=[];a.load=function(c){var o,d;if(window.DOMParser){d=new DOMParser();o=d.parseFromString(c,"text/xml")}else{o=new ActiveXObject("Microsoft.XMLDOM");o.async=false;o.loadXML(c)}b=o.getElementsByTagName("map")[0];a.version=b.getAttribute("version")||"unknown";a.orientation=b.getAttribute("orientation")||"orthogonal";a.width=parseInt(b.getAttribute("width"));a.height=parseInt(b.getAttribute("height"));a.tileWidth=parseInt(b.getAttribute("tilewidth"));a.tileHeight=parseInt(b.getAttribute("tileheight"));var l=b.getElementsByTagName("properties")[0],k=b.getElementsByTagName("tileset"),g=b.getElementsByTagName("layer"),h=b.getElementsByTagName("objectgroup"),m,e,j,n,f;if(l){for(f=0;f<l.childNodes.length;f++){if(l.hasChildNodes()===true){m=l.childNodes[f];if(m.nodeType===1){if(a.properties){a.properties.add(m)}else{a.properties=tmxPropertySet();a.properties.add(m)}}}}}if(k){for(f=0;f<k.length;f++){e=k[f];a.tileSets[e.getAttribute("name")]=tmxTileSet();a.tileSets[e.getAttribute("name")].load(e,a)}}if(g){for(f=0;f<g.length;f++){j=g[f];a.layers[j.getAttribute("name")]=tmxLayer();a.layers[j.getAttribute("name")].load(j,a)}}if(h){for(f=0;f<h.length;f++){n=h[f];a.objectGroups[n.getAttribute("name")]=tmxObjectGroup();a.objectGroups[n.getAttribute("name")].load(n,a)}}};a.getTileSet=function(c){return a.tileSets[c]};a.getLayer=function(c){return a.layers[c]};a.getObjectGroup=function(c){return a.objectGroups[c]};a.getGidOwner=function(d){var e=null;for(var c in a.tileSets){if(c.hasGid(d)){return c}}return null};return a};var tmxObject=function(a,e){var f={};f.group=e;f.name=a.getAttribute("name");f.type=a.getAttribute("type");f.x=parseInt(a.getAttribute("x"));f.y=parseInt(a.getAttribute("y"));f.width=parseInt(a.getAttribute("width"));f.height=parseInt(a.getAttribute("height"));f.shared=null;f.gid=-1;if(a.getAttribute("gid")&&a.getAttribute("gid").length!==0){f.gid=parseInt(a.getAttribute("gid"));var h=f.group.map.tileSets,d,c;if(h){for(c=0;c<h.length;c=c+1){d=h[c];f.shared=d.getPropertiesByGid(f.gid);if(f.shared){break}}}}var b=a.getElementsByTagName("properties")[0],g,c;if(b){for(c=0;c<b.childNodes.length;c=c+1){if(b.hasChildNodes()===true){g=b.childNodes[c];if(g.nodeType===1){if(f.custom){f.custom.add(g)}else{f.custom=tmxPropertySet();f.custom.add(g)}}}}}return f};var tmxObjectGroup=function(){var a={};a.map;a.name;a.x;a.y;a.width;a.height;a.opacity;a.visible;a.properties=null;a.objects=[];a.load=function(h,e){a.map=e;a.name=h.getAttribute("name");a.x=parseInt(h.getAttribute("x"));a.y=parseInt(h.getAttribute("y"));a.width=parseInt(h.getAttribute("width"));a.height=parseInt(h.getAttribute("height"));a.visible=!h.getAttribute("visible")||(h.getAttribute("visible")!==0);a.opacity=parseInt(h.getAttribute("opacity"));var d=h.getElementsByTagName("properties")[0],g=h.getElementsByTagName("object"),f,b,c;if(d){for(c=0;c<d.childNodes.length;c=c+1){if(d.hasChildNodes()===true){f=d.childNodes[c];if(f.nodeType===1){if(a.properties){a.properties.add(f)}else{a.properties=tmxPropertySet();a.properties.add(f)}}}}}if(g){for(c=0;c<g.length;c=c+1){b=g[c];a.objects.push(tmxObject(b,a))}}};return a};var tmxPropertySet=function(){var a=[];a.add=function(c){var b=c.getAttribute("name"),d=c.getAttribute("value");a[b]=d};return a};var tmxTileSet=function(){var b={},a=[],c=null;b.firstGID=0;b.map;b.name;b.tileWidth;b.tileHeight;b.spacing;b.margin;b.imageSource;b.numTiles=16777215;b.numRows=1;b.numCols=1;b.load=function(m,h){b.map=h;b.firstGID=parseInt(m.getAttribute("firstgid"));b.imageSource=m.getElementsByTagName("image")[0].getAttribute("source");b.name=m.getAttribute("name");b.tileWidth=parseInt(m.getAttribute("tilewidth"));b.tileHeight=parseInt(m.getAttribute("tileheight"));b.spacing=parseInt(m.getAttribute("spacing"));b.margin=parseInt(m.getAttribute("margin"));var d=m.getElementsByTagName("tile"),k,g,l,f,e;if(d){for(f=0;f<d.length;f++){k=d[f];g=k.getElementsByTagName("properties")[0];if(g){for(e=0;e<g.childNodes.length;e++){if(g.hasChildNodes()===true){l=g.childNodes[e];if(l.nodeType===1){a[k.getAttribute("id")]=tmxPropertySet();a[k.getAttribute("id")].add(l)}}}}}}};b.getImage=function(){return c};b.setImage=function(d){c=d;b.numCols=Math.floor(c.width/b.tileWidth);b.numRows=Math.floor(c.height/b.tileHeight);b.numTiles=b.numRows*b.numCols};b.hasGid=function(d){return(d>=b.firstGID)&&(d<b.firstGID+b.numTiles)};b.fromGid=function(d){return d-b.firstGID};b.toGid=function(d){return b.firstGID+d};b.getPropertiesByGid=function(d){return a[d-b.firstGID]};b.getProperties=function(d){return a[d]};b.getRect=function(d){return new FM.rectangle(0,0,(d%b.numCols)*b.tileWidth,(d/b.numCols)*b.tileHeight)};return b};FM.emitterComponent=function(h,d){var l=FM.component(FM.componentTypes.FX,d),q=[],i=h,m=[FM.parameters.LEFT,FM.parameters.RIGHT,FM.parameters.UP,FM.parameters.DOWN],j=0,n=0.1,g=0,f=1,o=FM.vector(-100,-100),b=FM.vector(100,100),p=-100,a=100,e=false,c=0,k=d.components[FM.componentTypes.SPATIAL];l.add=function(r){q.push(r);return r};l.createParticles=function(u,t,s,C,w,A){var v,y,x,z,B,r=FM.game.getCurrentState();f=w;for(v=0;v<u;v=v+1){y=FM.gameObject(A);x=FM.spatialComponent(x.position.x+i.x,x.position.y+i.y,y);y.addComponent(x);z=FM.spriteRendererComponent(t,s,C,y);z.setAlpha(f);y.addComponent(z);B=FM.aabbComponent(s,C,y);y.addComponent(B);y.age=0;y.lifeSpan=0;y.hide();y.kill();r.add(y);q.push(y)}};l.emit=function(t,r,u){e=true;c=0;n=r;g=u;var s;for(s=0;s<q.length;s=s+1){q[s].lifeSpan=t}};l.update=function(s){if(e){var v,u,x,w,r,z,y,t;for(v=0;v<q.length;v=v+1){w=q[v];if(w.isAlive()){if(w.age>=w.lifeSpan){w.hide();w.kill()}else{y=w.getComponent(FM.componentTypes.RENDERER);if(y.getAlpha()>=1-(w.age/w.lifeSpan)){y.setAlpha(1-(w.age/w.lifeSpan))}w.age+=s}}}c+=s;if(n===0||c>=n){c=0;x=0;u=0;while(x<g&&u<q.length){w=q[u];if(w&&!w.isAlive()){r=w.getComponent(FM.componentTypes.SPATIAL);z=w.components[FM.componentTypes.PHYSIC];w.components[FM.componentTypes.RENDERER].setAlpha(f);r.position.x=k.position.x+i.x;r.position.y=k.position.y+i.y;w.age=0;t=Math.random()*(b.x-o.x)+o.x;if(m.indexOf(FM.parameters.LEFT)!==-1){if(Math.random()>0.5){t=-t}}z.velocity.x=t;t=Math.random()*(b.y-o.y)+o.y;if(m.indexOf(FM.parameters.UP)!==-1){if(Math.random()>0.5){t=-t}}z.velocity.y=t;t=Math.random()*(a-p)+p;z.angularVelocity=t;w.show();w.revive();x=x+1}u=u+1}}}};l.setDirections=function(r){m=r};l.setAlpha=function(r){f=r;var s;for(s=0;s<q.length;s=s+1){q[s].components[FM.componentTypes.RENDERER].setAlpha(f)}};l.setXVelocity=function(s,r){o.x=s;b.x=r};l.setYVelocity=function(s,r){o.y=s;b.y=r};l.setAngularVelocity=function(s,r){p=s;a=r};l.getAlpha=function(){return f};l.destroy=function(){q=null;l=null};return l};FM.simplePathComponent=function(b){var e=FM.component(FM.componentTypes.PATHFINDING,b),k=[],g=0,m=FM.vector(0,0),a=FM.vector(0,0),c=false,l=false,f=false,j=FM.vector(0,0),i=1,d=b.components[FM.componentTypes.SPATIAL],h=b.components[FM.componentTypes.RENDERER],n=b.components[FM.componentTypes.PHYSIC];e.startFollowingPath=function(q,o){if(k.length>0){c=true;g=o||0;l=false;f=false;m=q;var s=Math.abs((d.position.x+n.offset.x+n.width/2)-k[g].x),r=Math.abs((d.position.y+n.offset.y+n.height/2)-k[g].y),p;if(s<r){p=s/r;a.x=m*p;a.y=m}else{if(s>r){p=r/s;a.x=m;a.y=m*p}else{a.x=m;a.y=m}}}else{if(FM.parameters.debug){console.log("WARNING: path with no waypoints defined.")}}if(!n){console.log("WARNING: path added to a game object with no physic component.")}};e.resumeFollowingPath=function(){if(k.length>0){c=true;if(j.x!==d.position.x||j.y!==d.position.y){l=false;f=false;var q=Math.abs((d.position.x+n.offset.x+n.width/2)-k[g].x),p=Math.abs((d.position.y+n.offset.y+n.height/2)-k[g].y),o;if(q<p){o=q/p;a.x=m*o;a.y=m}else{if(q>p){o=p/q;a.x=m;a.y=m*o}else{a.x=m;a.y=m}}}}else{if(FM.parameters.debug){console.log("WARNING: path with no waypoints defined.")}}if(!n){console.log("WARNING: path added to a game object with no physic component.")}};e.stopFollowingPath=function(){c=false;n.velocity.x=0;n.velocity.y=0;j=FM.vector(d.position.x,d.position.y)};e.clearPath=function(){k=[]};e.update=function(r){if(c&&n){var s=d.position.x+n.offset.x+n.width/2,q=d.position.y+n.offset.y+n.height/2,t,p,o;if(s<k[g].x){if(k[g].x-s<a.x*r){n.velocity.x=k[g].x-s;l=true}else{n.velocity.x=a.x}}else{if(s>k[g].x){if(s-k[g].x<a.x*r){n.velocity.x=s-k[g].x;l=true}else{n.velocity.x=-a.x}}else{l=true;n.velocity.x=0}}if(q<k[g].y){if(k[g].y-q<a.y*r){n.velocity.y=k[g].y-q;f=true}else{n.velocity.y=a.y}}else{if(q>k[g].y){if(q-k[g].y<a.y*r){n.velocity.y=q-k[g].y;f=true}else{n.velocity.y=-a.y}}else{f=true;n.velocity.y=0}}if(l&&f){if(k.length>g+1){l=false;f=false;g=g+1;t=Math.abs(s-k[g].x);p=Math.abs(q-k[g].y);if(t<p){o=t/p;a.x=m*o;a.y=m}else{if(t>p){o=p/t;a.x=m;a.y=m*o}else{a.x=m;a.y=m}}}else{c=false;a=FM.vector(0,0);if(n){n.velocity=FM.vector(0,0)}}}}};e.add=function(q,o,p){if(p===undefined){k.push({x:q,y:o})}else{k[p]={x:q,y:o}}};e.remove=function(o){k.splice(o,1)};e.getWaypoints=function(){return k};e.getCurrentIndex=function(){return g};e.getCurrentWaypoint=function(){return k[g]};e.getLength=function(){return k.length};e.isLastWaypointReached=function(){return g===k.length-1&&!c};e.isActive=function(){return c};e.destroy=function(){k=null;d=null;h=null;n=null;e.destroy();e=null};return e};FM.aabbComponent=function(a,e,d){var c=Object.create(FM.physicComponent(a,e,d)),b=d.components[FM.componentTypes.SPATIAL];c.update=function(f){Object.getPrototypeOf(c).update(f)};c.overlapsWithObject=function(f){var g=f.overlapsWithAabb(c);if(g){return g}return null};c.overlapsWithAabb=function(j){var s=j.owner.components[FM.componentTypes.SPATIAL],i=FM.vector(b.position.x+c.offset.x,b.position.y+c.offset.y),q=FM.vector(s.position.x+j.offset.x,s.position.y+j.offset.y),n=FM.vector(i.x+c.width,i.y+c.height),g=FM.vector(q.x+j.width,q.y+j.height),f=FM.vector(i.x+c.width/2,i.y+c.height/2),h=FM.vector(q.x+j.width/2,q.y+j.height/2),l=FM.math.substractVectors(h,f),r=(n.x-i.x)/2,k=(g.x-q.x)/2,p=r+k-Math.abs(l.x),m,o=null;if(n.x<q.x||i.x>g.x){return null}if(n.y<q.y||i.y>g.y){return null}if(p>0){r=(n.y-i.y)/2;k=(g.y-q.y)/2;m=r+k-Math.abs(l.y);if(m>0){o=FM.collision();o.a=c;o.b=j;if(p<m){if(l.x<0){o.normal=l.reset(-1,0)}else{o.normal=l.reset(1,0)}o.penetration=p}else{if(l.y<0){o.normal=l.reset(0,-1)}else{o.normal=l.reset(0,1)}o.penetration=m}return o}}return null};c.overlapsWithCircle=function(h){var t=h.owner.components[FM.componentTypes.SPATIAL],m=FM.vector(b.position.x+c.offset.x,b.position.y+c.offset.y),s=FM.vector(t.position.x+h.offset.x,t.position.y+h.offset.y),q=FM.vector(m.x+c.width,m.y+c.height),f=FM.vector(m.x+c.width/2,m.y+c.height/2),l=FM.vector(s.x+h.radius,s.y+h.radius),p=FM.math.substractVectors(l,f),g,n,i=p.clone(),j=(q.x-m.x)/2,o=(q.y-m.y)/2,k=false,r=null;i.x=FM.math.clamp(i.x,-j,j);i.y=FM.math.clamp(i.y,-o,o);if(p.isEquals(i)){k=true;if(Math.abs(p.x)>Math.abs(p.y)){if(i.x>0){i.x=j}else{i.x=-j}}else{if(i.y>0){i.y=o}else{i.y=-o}}}r=FM.collision();r.a=c;r.b=h;r.normal=FM.math.substractVectors(p,i);g=r.normal.getLengthSquared();n=h.radius;if(g>n*n&&!k){return null}g=Math.sqrt(g);r.penetration=n-g;if(k){r.normal.reset(-r.normal.x,-r.normal.y)}r.normal.normalize();return r};c.drawDebug=function(f,g){Object.getPrototypeOf(c).drawDebug(f);f.strokeStyle="#f4f";f.strokeRect(g.x+c.offset.x-f.xOffset,g.y+c.offset.y-f.yOffset,c.width,c.height)};c.destroy=function(){b=null;Object.getPrototypeOf(c).destroy();c=null};return c};FM.circleComponent=function(d,c){var b=Object.create(FM.physicComponent(d*2,d*2,c)),a=c.components[FM.componentTypes.SPATIAL];b.radius=d;b.update=function(e){Object.getPrototypeOf(b).update(e)};b.overlapsWithObject=function(e){var f=e.overlapsWithCircle(b);if(f){return f}return null};b.overlapsWithAabb=function(m){var s=m.owner.components[FM.componentTypes.SPATIAL],l=FM.vector(a.position.x+b.offset.x,a.position.y+b.offset.y),r=FM.vector(s.position.x+m.offset.x,s.position.y+m.offset.y),i=FM.vector(r.x+m.width,r.y+m.height),e=FM.vector(l.x+b.radius,l.y+b.radius),k=FM.vector(r.x+m.width/2,r.y+m.height/2),p=FM.math.substractVectors(k,e),f,n,g=p.clone(),h=(i.x-r.x)/2,o=(i.y-r.y)/2,j=false,q=null;g.x=FM.math.clamp(g.x,-h,h);g.y=FM.math.clamp(g.y,-o,o);if(p.isEquals(g)){j=true;if(Math.abs(p.x)>Math.abs(p.y)){if(g.x>0){g.x=h}else{g.x=-h}}else{if(g.y>0){g.y=o}else{g.y=-o}}}q=FM.collision();q.a=b;q.b=m;q.normal=FM.math.substractVectors(p,g);f=q.normal.getLengthSquared();n=b.radius;if(f>(n*n)&&!j){return null}f=Math.sqrt(f);q.penetration=n-f;if(j){q.normal.reset(-q.normal.x,-q.normal.y)}q.normal.normalize();return q};b.overlapsWithCircle=function(g){var n=g.owner.components[FM.componentTypes.SPATIAL],i=FM.vector(a.position.x+b.offset.x,a.position.y+b.offset.y),m=FM.vector(n.position.x+g.offset.x,n.position.y+g.offset.y),e=FM.vector(i.x+b.width/2,i.y+b.height/2),h=FM.vector(m.x+g.width/2,m.y+g.height/2),j=b.radius+g.radius,j=j*j,k=FM.math.substractVectors(h,e),f=k.getLength(),l=null;if(k.getLengthSquared()>j){return null}else{l=FM.collision();l.a=b;l.b=g;if(f!==0){l.penetration=j-f;l.normal=k.reset(k.x/f,k.y/f)}else{l.penetration=b.radius;l.normal=k.reset(1,0)}return l}return null};b.drawDebug=function(f,g){Object.getPrototypeOf(b).drawDebug(f);var e=FM.vector(g.x+b.radius,g.y+b.radius);f.beginPath();f.strokeStyle="#f4f";f.arc((e.x+b.offset.x)-f.xOffset,(e.y+b.offset.y)-f.yOffset,b.radius,0,2*Math.PI,false);f.stroke()};b.destroy=function(){a=null;Object.getPrototypeOf(b).destroy();b=null};return b};FM.physicComponent=function(d,k,c){var h=FM.component(FM.componentTypes.PHYSIC,c),g=FM.game.getCurrentState().getWorld(),l=FM.game.getCurrentState().getQuad(),j=0,i=[],f=c.components[FM.componentTypes.SPATIAL],e=function(t){var q=FM.vector(t.penetration*t.normal.x,t.penetration*t.normal.y),r=t.a.owner.components[FM.componentTypes.SPATIAL],o=t.b.owner.components[FM.componentTypes.SPATIAL],s=t.a.owner.components[FM.componentTypes.PHYSIC],m=t.b.owner.components[FM.componentTypes.PHYSIC],p=0,n=0,u=0;if(t.a.mass===0){n=0}else{n=1/t.a.mass}if(t.b.mass===0){u=0}else{u=1/t.b.mass}p=n+u;r.position.x-=q.x*(n/p);r.position.y-=q.y*(n/p);o.position.x+=q.x*(u/p);o.position.y+=q.y*(u/p)},a=function(n,q,m){var p=f.position.x+h.offset.x+q,o=f.position.y+h.offset.y+m;if(!h.checkCollisions(n,p,o)){f.position.x=p;f.position.y=o;return true}return false},b=function(o,q,n){if(Math.abs(q)>=o.getTileWidth()||Math.abs(n)>=o.getTileHeight()){b(o,q/2,n/2);b(o,q-q/2,n-n/2);return}var t=a(o,q,0),m=a(o,0,n);if(t&&m){return}if(!t){h.velocity.x=0;var p;var s=Math.abs(q);for(p=0;p<s;p++){var r;if(q===0){r=0}else{if(q>0){r=1}else{r=-1}}if(!a(o,r,0)){break}else{h.velocity.x+=r}}}if(!m){h.velocity.y=0;s=Math.abs(n);for(p=0;p<s;p++){var r;if(n===0){r=0}if(n>0){r=1}else{r=-1}if(!a(o,0,r)){break}else{h.velocity.y+=r}}}};h.offset=FM.vector(0,0);h.width=d;h.height=k;h.collidesWith=[];h.velocity=FM.vector(0,0);h.acceleration=FM.vector(0,0);h.angularVelocity=0;h.mass=1;h.maxVelocity=FM.vector(1000,1000);h.maxAngularVelocity=10000;h.elasticity=0;h.update=function(m){i=[];var n=1/h.mass,p,o;if(h.mass===0){n=0}p=h.velocity.x+(n*h.acceleration.x)*m;o=h.maxVelocity.x+(n*h.acceleration.x)*m;if(Math.abs(p)<=o){h.velocity.x=p}else{if(p<0){h.velocity.x=-o}else{if(p>0){h.velocity.x=o}}}p=h.velocity.y+(n*h.acceleration.y)*m;o=h.maxVelocity.y+(n*h.acceleration.y)*m;if(Math.abs(p)<=o){h.velocity.y=p}else{if(p<0){h.velocity.y=-o}else{if(p>0){h.velocity.y=o}}}f.position.x+=h.velocity.x*m;f.position.y+=h.velocity.y*m;h.acceleration.x=0;h.acceleration.y=0;if(g.getCollisionTileMap()){b(g.getCollisionTileMap(),h.velocity.x*m,h.velocity.y*m)}var w,t,r,q,v,s,u=null;if(h.collidesWith.length>0){w=FM.game.getCurrentState().getQuad();t=w.retrieve(c);for(r=0;r<t.length;r=r+1){v=t[r];s=v.components[FM.componentTypes.PHYSIC];if(v.isAlive()&&c.getId()!==v.getId()&&!s.isCollidingWith(c)&&!h.isCollidingWith(v)){for(q=0;q<h.collidesWith.length;q=q+1){if(v.hasType(h.collidesWith[q])){u=c.components[FM.componentTypes.PHYSIC].overlapsWithObject(s);if(u!==null){h.addCollision(u);s.addCollision(u);h.resolveCollision(s,u);s.resolveCollision(h,u);e(u)}}}}}}};h.checkTileCollisions=function(u,r,m){var t,s,o,w,n,v,q,p;if(u.length>0){t=u.getTileWidth();s=u.getTileHeight();o=Math.floor(m/s);w=Math.floor(r/t);n=Math.floor((m+h.height)/s);v=Math.floor((r+h.width)/t);for(q=o;q<=n;q=q+1){for(p=w;p<=v;p=p+1){if(u[q]&&u[q][p]===1){if(p===w||p===v||q===o||q===n){return true}}}}}return false};h.resolveCollision=function(q,t){var n=FM.math.substractVectors(q.velocity,h.velocity),s=n.dotProduct(t.normal),r=Math.min(h.elasticity,q.elasticity),p=0,o=0,u=0,m=FM.vector(0,0);if(s>0){return}if(h.mass===0){o=0}else{o=1/h.mass}if(q.mass===0){u=0}else{u=1/q.mass}p=-(1+r)*s;p/=o+u;m.reset(p*t.normal.x,p*t.normal.y);h.velocity.x-=o*m.x;h.velocity.y-=o*m.y;q.velocity.x+=u*m.x;q.velocity.y+=u*m.y};h.addTypeToCollideWith=function(m){h.collidesWith.push(m)};h.removeTypeToCollideWith=function(m){h.collidesWith.splice(h.collidesWith.indexOf(m),1)};h.addCollision=function(m){i.push(m)};h.drawDebug=function(m,n){};h.getLinearVelocity=function(){return h.velocity};h.isCollidingWithType=function(n){var m,o;for(m=0;m<i.length;m=m+1){o=i[m];if((o.b&&o.b.owner.hasType(n))||(o.a&&o.a.owner.hasType(n))){return true}}return false};h.isCollidingWith=function(n){var m,o;for(m=0;m<i.length;m=m+1){o=i[m];if((o.b&&o.b.owner.getId()===n.getId())||(o.a&&o.a.owner.getId()===n.getId())){return true}}return false};return h};FM.animatedSpriteRendererComponent=function(m,o,f,a){var h=FM.component(FM.componentTypes.RENDERER,a),n=m,k=n.width,t=n.height,q=o,j=f,d=1,b="",g=false,v=0,i=0,l=[],e=0,r=0,u=0.1,p=0.1,s=[],c=a.components[FM.componentTypes.SPATIAL];h.finished=false;h.addAnimation=function(x,y,w,z){e=0;b=x;l[x]=y;u=1/w;p=u;s[x]=z};h.play=function(w){k=n.width;t=n.height;b=w;h.finished=false;e=0;v=l[b][e]*q;i=Math.floor(v/k)*j;if(v>=k){i=Math.floor(v/k)*j;v=(v%k)}};h.stop=function(){h.finished=true};h.draw=function(w,x){var A=x.x,z=x.y,y=(new Date()).getTime()/1000;A-=w.xOffset*a.scrollFactor.x;z-=w.yOffset*a.scrollFactor.y;w.globalAlpha=d;if(c.angle!==0){w.save();w.translate(A,z);w.translate(q/2,j/2);w.rotate(c.angle);w.drawImage(n,v,i,q,j,-q/2,-j/2,q,j);w.restore()}else{w.drawImage(n,v,i,q,j,A,z,q,j)}w.globalAlpha=1;if(!h.finished){if(p<=0){p=u;if(l[b]){if(l[b].length>1){e=e+1;if(l[b]&&(e===l[b].length-1)){if(s[b]){e=0}else{h.finished=true}}}else{h.finished=true}v=l[b][e]*q;i=Math.floor(v/k)*j;if(v>=k){i=Math.floor(v/k)*j;v=(v%k)}}}else{p-=y-r}}r=y};h.destroy=function(){n.destroy();n=null;b=null;l=null;s=null;c=null;h.destroy();h=null};h.getCurrentAnim=function(){return b};h.setWidth=function(w){q=w};h.setHeight=function(w){j=w};h.setAlpha=function(w){d=w};h.getWidth=function(){return q};h.getHeight=function(){return j};h.getAlpha=function(){return d};return h};FM.boxRendererComponent=function(c,i,f,b){var h=FM.component(FM.componentTypes.RENDERER,b),a=c,j=i,e=f,d=1,g=b.components[FM.componentTypes.SPATIAL];h.draw=function(k,l){var n=l.x,m=l.y;n-=k.xOffset*b.scrollFactor.x;m-=k.yOffset*b.scrollFactor.y;k.globalAlpha=d;if(g.angle!==0){k.save();k.translate(n,m);k.translate(a/2,j/2);k.rotate(g.angle);k.beginPath();k.rect(n,m,a,j);k.restore()}else{k.beginPath();k.rect(n,m,a,j)}k.fillStyle=e;k.fill();k.globalAlpha=1};h.destroy=function(){g=null;h.destroy();h=null};h.setWidth=function(k){a=k};h.setHeight=function(k){j=k};h.setColor=function(k){e=k};h.setAlpha=function(k){d=k};h.getWidth=function(){return a};h.getHeight=function(){return j};h.getColor=function(){return e};h.getAlpha=function(){return d};return h};FM.circleRendererComponent=function(f,e,b){var h=FM.component(FM.componentTypes.RENDERER,b),a=f*2,i=f*2,d=e,c=1,g=b.components[FM.componentTypes.SPATIAL];h.draw=function(k,l){var n=l.x-k.xOffset*b.scrollFactor.x,m=l.y-k.yOffset*b.scrollFactor.y,j=FM.vector(n+a/2,m+i/2);k.globalAlpha=c;if(g.angle!==0){k.save();k.translate(n,m);k.translate(a/2,i/2);k.rotate(g.angle);k.beginPath();k.arc(j.x,j.y,a/2,0,2*Math.PI);k.restore()}else{k.beginPath();k.arc(j.x,j.y,a/2,0,2*Math.PI)}k.fillStyle=d;k.fill();k.globalAlpha=1};h.destroy=function(){g=null;h.destroy();h=null};h.setWidth=function(j){a=j;i=j};h.setHeight=function(j){i=j;a=j};h.setRadius=function(j){a=j*2;i=j*2};h.setColor=function(j){d=j};h.setAlpha=function(j){c=j};h.getWidth=function(){return a};h.getHeight=function(){return i};h.getRadius=function(){return a/2};h.getColor=function(){return d};h.getAlpha=function(){return c};return h};FM.lineRendererComponent=function(f,e,b){var i=FM.component(FM.componentTypes.RENDERER,b),j=[],a=0,k=0,g=f,d=e,c=1,h=b.components[FM.componentTypes.SPATIAL];i.draw=function(l,n){var p=n.x,o=n.y,m;p-=l.xOffset*b.scrollFactor.x;o-=l.yOffset*b.scrollFactor.y;l.globalAlpha=c;if(h.angle!==0){l.save();l.translate(p,o);l.translate(a/2,k/2);l.rotate(h.angle);if(j.length>0){l.beginPath();l.moveTo(j[0].x,j[0].y);for(m=1;m<j.length;m=m+1){l.lineTo(j[m].x,j[m].y)}}l.restore()}else{if(j.length>0){l.beginPath();l.moveTo(j[0].x,j[0].y);for(m=1;m<j.length;m=m+1){l.lineTo(j[m].x,j[m].y)}}}l.strokeStyle=d;l.lineWidth=g;l.stroke();l.globalAlpha=1;l.lineWidth=1};i.destroy=function(){h=null;i.destroy();var l;for(l=0;l<j.length;l=l+1){j[l].destroy()}j=null;i=null};i.addPoint=function(o){j.push(o);var p,l,n=0,r=0,m=0,q=0;for(p=0;p<j.length;p=p+1){l=j[p];if(l.x>n){n=l.x}if(l.x<r){r=l.x}if(l.y<m){m=l.y}if(l.y>q){q=l.y}}a=Math.abs(n-r);k=Math.abs(q-m)};i.setLineWidth=function(l){g=l};i.setLineStyle=function(l){d=l};i.setAlpha=function(l){c=l};i.getWidth=function(){return a};i.getHeight=function(){return k};i.getLineWidth=function(){return g};i.getLineStyle=function(){return d};i.getAlpha=function(){return c};return i};FM.spriteRendererComponent=function(g,c,k,b){var i=FM.component(FM.componentTypes.RENDERER,b),e=g,a=c,l=k,f=1,j=0,d=0,h=b.components[FM.componentTypes.SPATIAL];i.draw=function(m,n){var p=n.x,o=n.y;p-=m.xOffset*b.scrollFactor.x;o-=m.yOffset*b.scrollFactor.y;m.globalAlpha=f;if(h.angle!==0){m.save();m.translate(p,o);m.translate(a/2,l/2);m.rotate(h.angle);m.drawImage(e,j,d,a,l,-a/2,-l/2,a,l);m.restore()}else{m.drawImage(e,j,d,a,l,p,o,a,l)}m.globalAlpha=1};i.destroy=function(){e.destroy();e=null;h=null;i.destroy();i=null};i.setImage=function(n,m,o){e=n;a=m;l=o};i.setXOffset=function(m){j=m};i.setYOffset=function(m){d=m};i.setWidth=function(m){a=m};i.setHeight=function(m){l=m};i.setAlpha=function(m){f=m};i.getWidth=function(){return a};i.getHeight=function(){return l};i.getAlpha=function(){return f};return i};FM.textRendererComponent=function(f,e){var d=FM.component(FM.componentTypes.RENDERER,e),c=e.components[FM.componentTypes.SPATIAL],b=50,a=50;d.text=f;d.fillStyle="#fff";d.font="30px sans-serif";d.textBaseline="middle";d.setFormat=function(h,g,i){d.fillStyle=h;d.font=g;d.textBaseline=i};d.draw=function(g,h){var j=h.x,i=h.y;j-=g.xOffset*e.scrollFactor.x;i-=g.yOffset*e.scrollFactor.y;g.fillStyle=d.fillStyle;g.font=d.font;g.textBaseline=d.textBaseline;g.fillText(d.text,j,i)};d.destroy=function(){c=null;d.text=null;d.fillStyle=null;d.font=null;d.textBaseline=null;d.destroy();d=null};d.getWidth=function(){return b};d.getHeight=function(){return a};return d};FM.audioComponent=function(c){var b=FM.component(FM.componentTypes.SOUND,c),a=[];b.play=function(f,h,e){var g,j,d=false;for(g=0;g<a.length;g=g+1){j=a[g];if(j.getName()===f){d=true;j.volume=h;if(e){j.addEventListener("ended",function(){this.currentTime=0;this.play()},false)}j.play()}}if(!d){if(FM.parameters.debug){console.log("WARNING: you're trying to play a sound that does not exist.")}}};b.pause=function(d){var e,f;for(e=0;e<a.length;e=e+1){f=a[e];if(f.getName()===d){f.pause()}}};b.addSound=function(d){a.push(d)};b.destroy=function(){var d;for(d=0;d<a.length;d=d+1){a[d].destroy()}a=null;b.destroy();b=null};b.getSoundByName=function(d){var e,f;for(e=0;e<a.length;e=e+1){f=a[e];if(f.getName()===d){return f}}return null};return b};FM.spatialComponent=function(b,a,d){var c=FM.component(FM.componentTypes.SPATIAL,d);c.position=FM.vector(b,a);c.previous=FM.vector(b,a);c.angle=0;c.destroy=function(){c.position=null;c.previous=null;c.destroy();c=null};return c};