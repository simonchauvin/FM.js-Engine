var FM=FM||{};FM.assetManager={assets:[],loadingProgress:0,addAsset:function(a,c,f){var d=FM.assetManager,g=FM.parameters,b=d.getAssetByName(a),e;if(c===g.IMAGE){if(!b){d.assets.push(FM.imageAsset(a,f))}}else{if(c===g.AUDIO){if(!b){e=FM.audioAsset(a,f);if(e.isSupported()){d.assets.push(e)}else{if(FM.parameters.debug){console.log("ERROR: The "+f.substring(f.lastIndexOf(".")+1)+" audio format is not supported by this browser.");return false}}}}else{if(c===g.FILE){if(!b){d.assets.push(FM.fileAsset(a,f))}}}}return true},loadAssets:function(){var a,b=FM.assetManager;for(a=0;a<b.assets.length;a=a+1){b.assets[a].load()}},assetLoaded:function(){var a=FM.assetManager;a.loadingProgress+=100/a.assets.length},areAllAssetsLoaded:function(){return Math.round(FM.assetManager.loadingProgress)>=100},getAssetByName:function(a){var c=null,b=0,d=FM.assetManager;for(b=0;b<d.assets.length;b=b+1){if(d.assets[b].getName()===a){c=d.assets[b]}}return c}};FM.parameters={FPS:60,libFolder:"lib",debug:false,COLLIDER_MINIMUM_SIZE:16,STATIC:"static",KINEMATIC:"kinematic",DYNAMIC:"dynamic",PIXELS_TO_METERS:30,IMAGE:"image",AUDIO:"audio",FILE:"file",LEFT:"left",RIGHT:"right",UP:"up",DOWN:"down"};FM.componentTypes={SPATIAL:"spatial",PATHFINDING:"pathfinding",RENDERER:"renderer",PHYSIC:"physic",SOUND:"sound",FX:"fx"};FM.circle=function(b,a,d){var c={};c.x=b;c.y=a;c.radius=d;c.destroy=function(){c=null};return c};FM.game=(function(){var o={},I="",A=0,E=0,i="rgb(0,0,0)",H=null,e="",d=null,k=null,a=null,G=0,w=0,n=1/FM.parameters.FPS,C=FM.parameters.FPS,b=FM.parameters.FPS,D=(new Date()).getTime()/1000,h=0,r=[],c=[],u=false,m=false,z=false,q=0,p=0,l=false,B=false,s=function(){d.clearRect(0,0,A,E);d.fillStyle=i;d.fillRect(0,0,A,E);var K=(new Date()).getTime()/1000,J=K-D,L=0;if(J>0.25){J=0.25}D=K;if(!l){h+=J;while(h>=n){h-=n;H.updatePhysics(n);H.update(n)}L=h/n}w+=J;G=G+1;if(w>=1){b=G/w;G=0;w=0}C=Math.round(b);H.draw(a,L);if(l){a.fillStyle="rgba(99,99,99,0.5)";a.fillRect(0,0,A,E);a.fillStyle="rgba(255,255,255,1)";a.beginPath();a.moveTo(A/2+60,E/2);a.lineTo(A/2-60,E/2-60);a.lineTo(A/2-60,E/2+60);a.lineTo(A/2+60,E/2);a.fill();a.closePath()}if(FM.parameters.debug){if(o.isKeyReleased(FM.keyboard.HOME)){if(!B){B=true}else{B=false}}if(B){a.fillStyle="#fcd116";a.font="30px sans-serif";a.textBaseline="middle";a.fillText(C,10,20)}}d.drawImage(k,0,0);u=false;c=[];window.requestAnimationFrame(s)},t=function(J){r[J.keyCode]=1},x=function(K){var J=K.keyCode;c[J]=1;delete r[J]},v=function(J){q=J.clientX-J.target.offsetLeft;p=J.clientY-J.target.offsetTop},j=function(J){u=true},y=function(J){m=true;z=false},g=function(J){z=true;m=false},f=function(J){l=false},F=function(J){l=true};o.run=function(K,M,J,O,L,N){I=M;A=J;E=O;e=document.getElementById(K);if(N){H=N(L)}else{H=FM.preloader(L)}if(e&&e.getContext){d=e.getContext("2d");if(d){e.width=A;e.height=E;k=document.createElement("canvas");k.width=A;k.height=E;a=k.getContext("2d");a.xOffset=0;a.yOffset=0}}if(d&&a){e.onkeydown=function(P){t(P)};e.onkeyup=function(P){x(P)};e.onclick=function(P){j(P)};e.onmousedown=function(P){y(P)};e.onmouseup=function(P){g(P)};e.onmousemove=function(P){v(P)};e.onfocus=function(P){f(P)};e.onblur=function(P){F(P)};e.focus();H.init(o);window.requestAnimationFrame(s)}};(function(){var J,K=0,L=["ms","moz","webkit","o"];for(J=0;J<L.length&&!window.requestAnimationFrame;++J){window.requestAnimationFrame=window[L[J]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[L[J]+"CancelAnimationFrame"]||window[L[J]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(P){var M=new Date().getTime(),N=Math.max(0,16-(M-K)),O=window.setTimeout(function(){P(M+N)},N);K=M+N;return O}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(M){clearTimeout(M)}}}());o.switchState=function(J){H.destroy();H=J;H.init(o)};o.setBackgroundColor=function(J){i=J};o.isKeyPressed=function(J){if(r[J]){return true}else{return false}};o.isKeyReleased=function(J){if(c[J]){return true}else{return false}};o.isMouseClicked=function(){return u};o.isMousePressed=function(){return m};o.isMouseReleased=function(){return z};o.isDebugActivated=function(){return B};o.getName=function(){return I};o.getMouseX=function(){return q+H.camera.x};o.getMouseY=function(){return p+H.camera.y};o.getMouseScreenX=function(){return q};o.getMouseScreenY=function(){return p};o.getScreenWidth=function(){return A};o.getScreenHeight=function(){return E};o.getCurrentState=function(){return H};return o}());FM.gameObject=function(e){var d={},g=0,a="",c=true,f=true,b=[];d.scrollFactor=FM.vector(1,1);d.components={};d.zIndex=e;d.addType=function(h){b.push(h)};d.removeType=function(h){b.splice(b.indexOf(h),1)};d.hasType=function(h){return b.indexOf(h)!==-1};d.addComponent=function(i){var h=i.name;if(!d.components[h]){d.components[h]=i}};d.getComponent=function(h){return d.components[h]};d.destroy=function(){a=null;d.scrollFactor=null;var h;for(h=0;h<d.components.length;h=h+1){d.components[h].destroy()}d.components=null;d=null};d.kill=function(){c=false};d.hide=function(){f=false};d.revive=function(){c=true};d.show=function(){f=true};d.getTypes=function(){return b};d.getName=function(){return a};d.setName=function(h){a=h};d.getId=function(){return g};d.setId=function(h){g=h};d.isAlive=function(){return c};d.isVisible=function(){return f};return d};FM.keyboard={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS:20,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DEL:46,ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,lLEFT_SPECIAL:91,RIGHT_SPECIAL:92,SELECT:93,NUM_ZERO:96,NUM_ONE:97,NUM_TWO:98,NUM_THREE:99,NUM_FOUR:100,NUM_FIVE:101,NUM_SIX:102,NUM_SEVEN:103,NUM_EIGHT:104,NUM_NINE:105,MULTIPLY:106,ADD:107,SUBSTRACT:109,DECIMAL_POINT:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,SEMICOLON:186,EQUAL_SIGN:187,COMMA:188,DASH:189,PERIOD:190,FORWARD_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,SINGLE_QUOTE:222};FM.math={addVectors:function(b,a){return FM.vector(b.x+a.x,b.y+a.y)},substractVectors:function(b,a){return FM.vector(b.x-a.x,b.y-a.y)},multiplyVectors:function(b,a){return FM.vector(b.x*a.x,b.y*a.y)},clamp:function(c,b,a){return Math.min(a,Math.max(b,c))},};FM.objectType=function(a){var e={},b=a,d=true,g=true,h=1,f=FM.vector(1,1),c=[];e.overlapsWithType=function(n){var l=FM.game.getCurrentState(),x=l.getQuad(),s=l.members,q,p,o,m,u,k,w,y,r,v=null,t=null;for(p=0;p<s.length;p=p+1){k=s[p];y=k.components[FM.componentTypes.PHYSIC];m=k.hasType(e);u=k.hasType(n);if(y&&(m||u)){q=x.retrieve(k);for(o=0;o<q.length;o=o+1){w=q[o];r=w.components[FM.componentTypes.PHYSIC];if(r&&k.getId()!==w.getId()&&((m&&w.hasType(n))||(u&&w.hasType(e)))){t=y.overlapsWithObject(r);if(t){v=t}}}}}return v};e.overlapsWithObject=function(n){var o=FM.game.getCurrentState().getQuad().retrieve(n),m,k,q=n.components[FM.componentTypes.PHYSIC],l,p=null,j=null;if(q){for(m=0;m<o.length;m=m+1){k=o[m];l=k.components[FM.componentTypes.PHYSIC];if(l&&n.getId()!==k.getId()&&k.hasType(e)){j=q.overlapsWithObject(l);if(j){p=j}}}}else{if(FM.parameters.debug){console.log("WARNING: you need to specify a game object with a physic component for checking overlaps.")}}return p};e.addTypeToCollideWith=function(k){c.push(k);var m=FM.game.getCurrentState().members,l,j,n;for(l=0;l<m.length;l=l+1){j=m[l];n=j.components[FM.componentTypes.PHYSIC];if(n&&j.hasType(e)){n.addTypeToCollideWith(k)}}};e.removeTypeToCollideWith=function(k){c.splice(c.indexOf(k),1);var m=FM.game.getCurrentState().members,l,j,n;for(l=0;l<m.length;l=l+1){j=m[l];n=j.components[FM.componentTypes.PHYSIC];if(n&&j.hasType(e)){n.removeTypeToCollideWith(k)}}};e.setZIndex=function(m){h=m;var l=FM.game.getCurrentState().members,k,j;for(k=0;k<l.length;k=k+1){j=l[k];if(j.hasType(e)){j.zIndex=h}}};e.setScrollFactor=function(l){f=l;var m=FM.game.getCurrentState().members,k,j;for(k=0;k<m.length;k=k+1){j=m[k];if(j.hasType(e)){j.scrollFactor=f}}};e.kill=function(){d=false};e.hide=function(){g=false};e.revive=function(){d=true};e.show=function(){g=true};e.isAlive=function(){return d};e.isVisible=function(){return g};e.destroy=function(){b=null;f=null;c=null;e=null};e.getName=function(){return b};return e};FM.rectangle=function(c,b,a,e){var d={};d.x=c;d.y=b;d.width=a;d.height=e;d.destroy=function(){d=null};return d};FM.state=function(){var g={},a=0,b=0,e=null,i=null,j=null,f=null,k=false,c=false,l=FM.vector(60,60),d=FM.vector(60,60),h=function(n,m){return(n.zIndex-m.zIndex)};g.members=[];FM.state.lastId=0;g.camera=FM.rectangle(0,0,0,0);g.init=function(n,m){a=FM.game.getScreenWidth();b=FM.game.getScreenHeight();f=FM.world(n||a,m||b);j=FM.quadTree(0,FM.rectangle(0,0,n||a,m||b));g.camera.width=a;g.camera.height=b;if(FM.parameters.debug){console.log("INIT: The state has been created.")}};g.add=function(m){if(m.components){g.members.push(m);m.setId(FM.state.lastId);FM.state.lastId+=1;if(m.components[FM.componentTypes.PHYSIC]){j.insert(m)}}else{if(FM.parameters.debug){console.log("ERROR: you're trying to add something elsethan a game object to the state. This is not allowed.")}}};g.remove=function(m){g.members.splice(g.members.indexOf(m),1);m.destroy()};g.sortByZIndex=function(){g.members.sort(h)};g.updatePhysics=function(n){var o,m,p,q;j.clear();for(o=0;o<g.members.length;o=o+1){m=g.members[o];if(m.isAlive()){p=m.components;q=m.components[FM.componentTypes.PHYSIC];if(q){j.insert(m)}}}for(o=0;o<g.members.length;o=o+1){m=g.members[o];if(m.isAlive()){p=m.components;q=p[FM.componentTypes.PHYSIC];if(q){q.update(n)}}}};g.update=function(q){var s,o,v,w,z,A,n,u,y,r,p,t,x,m;for(s=0;s<g.members.length;s=s+1){o=g.members[s];if(o.isAlive()){v=o.components;w=v[FM.componentTypes.SPATIAL];z=v[FM.componentTypes.PHYSIC];A=v[FM.componentTypes.PATHFINDING];n=v[FM.componentTypes.FX];if(A){A.update(q)}if(n){n.update(q)}if(z){if(e===o){y=i.width;r=i.height;p=w.position.x+z.offset.x;t=w.position.y+z.offset.y;x=p+z.width;m=t+z.height;if(p<=i.x){u=g.camera.x-(i.x-p);if(u>=0){if(k){g.camera.x-=l.x*q;i.x-=l.x*q}else{g.camera.x=u;i.x=p}}}if(t<=i.y){u=g.camera.y-(i.y-t);if(u>=0){if(k){g.camera.y-=l.y*q;i.y-=l.y*q}else{g.camera.y=u;i.y=t}}}if(x>=i.x+y){u=g.camera.x+(x-(i.x+y));if(u+g.camera.width<=f.width){if(k){g.camera.x+=l.x*q;i.x+=l.x*q}else{g.camera.x=u;i.x=x-y}}}if(m>=i.y+r){u=g.camera.y+(m-(i.y+r));if(u+g.camera.height<=f.height){if(k){g.camera.y+=l.y*q;i.y+=l.y*q}else{g.camera.y=u;i.y=m-r}}}if(k&&p>=i.x&&x<=i.x+y&&t>=i.y&&m<=i.y+r){k=false}}}else{if(FM.parameters.debug&&e===o){console.log("ERROR: The scrolling object must have a physic component.")}}if(o.update){o.update(q)}}}};g.draw=function(n,q){n.clearRect(0,0,a,b);n.xOffset=g.camera.x;n.yOffset=g.camera.y;var u,o,r,w,z,y;for(u=0;u<g.members.length;u=u+1){o=g.members[u];if(o.isVisible()||(FM.parameters.debug&&FM.game.isDebugActivated()&&o.isAlive())){w=o.components[FM.componentTypes.SPATIAL];if(w){y=o.components[FM.componentTypes.RENDERER];w.previous.copy(w.position);r=FM.vector(w.position.x*q+w.previous.x*(1-q),w.position.y*q+w.previous.y*(1-q));if(y&&o.isVisible()){var p=r.x,v=r.y,x=p+y.getWidth(),m=v+y.getHeight(),t=0,s=0;t=(g.camera.x+(a-g.camera.width)/2)*o.scrollFactor.x;s=(g.camera.y+(b-g.camera.height)/2)*o.scrollFactor.y;if(x>=t&&m>=s&&p<=t+g.camera.width&&v<=s+g.camera.height){y.draw(n,r)}}if(FM.parameters.debug&&o.isAlive()){if(FM.game.isDebugActivated()){z=o.components[FM.componentTypes.PHYSIC];if(z){z.drawDebug(n,r)}}}}}}if(FM.parameters.debug){if(FM.game.isDebugActivated()){n.strokeStyle="#f0f";n.strokeRect(0-g.camera.x,0-g.camera.y,f.width,f.height);n.strokeStyle="#8fc";n.strokeRect((a-g.camera.width)/2,(b-g.camera.height)/2,g.camera.width,g.camera.height);if(i){n.strokeStyle="#f4f";n.strokeRect(i.x-g.camera.x,i.y-g.camera.y,i.width,i.height)}}}};g.centerCameraOn=function(m){var o=m.components[FM.componentTypes.SPATIAL],n=o.position.x-g.camera.width/2;if(n>f.x&&n<f.width){g.camera.x=n}n=o.position.y-g.camera.height/2;if(n>f.y&&n<f.height){g.camera.y=n}};g.centerCameraAt=function(o,n){var m=o-g.camera.width/2;if(m>f.x&&m<f.width){g.camera.x=m}m=n-g.camera.height/2;if(m>f.y&&m<f.height){g.camera.y=m}};g.follow=function(n,p,m,q,o){e=n;i=FM.rectangle((a-p)/2+g.camera.x,(b-m)/2+g.camera.y,p,m);k=q===undefined?false:q;l=o===undefined?FM.vector(60,60):o};g.unFollow=function(){i=null;e=null};g.destroy=function(){var m;for(m=0;m<g.members.length;m=m+1){g.members[m].destroy()}g.members=null;e=null;if(i){i.destroy()}i=null;g.camera.destroy();g.camera=null;f.destroy();f=null;j.clear();j=null;g=null};g.getGameObjectById=function(o){var m,n;for(n=0;n<g.members.length;n=n+1){m=g.members[n];if(m.getId()===o){return m}}return null};g.getScroller=function(){return e};g.getWorld=function(){return f};g.getQuad=function(){return j};return g};FM.tileMap=function(o,m,b,q,d,i,c,g){var e={},r=[],p=o,n=m,k=b,a=q,f=d,j=i,l=c,h=g;e.load=function(s){var F=s.split("\n"),E=null,D=null,w=null,z=null,B=null,t=FM.game.getCurrentState(),C,A,v,y,x,u;for(y=0;y<F.length;y=y+1){E=F[y];if(E){D=[];w=E.split(",",n);for(x=0;x<w.length;x=x+1){z=parseInt(w[x]);if(z>0){B=FM.gameObject(l);for(u=0;u<i.length;u=u+1){B.addType(i[u])}FM.spatialComponent(x*a,y*f,B);C=FM.spriteRendererComponent(p,a,f,B);A=z*a;v=Math.floor(A/p.width)*f;if(A>=p.width){v=Math.floor(A/p.width)*f;A=(A%p.width)}C.offset.reset(A,v);t.add(B);D.push(B.getId())}else{D.push(-1)}}r.push(D)}}};e.allowCollisions=function(){h=true};e.preventCollisions=function(){h=false};e.destroy=function(){r=null;p=null;e=null};e.canCollide=function(){return h};e.hasType=function(s){return j.indexOf(s)!==-1};e.getData=function(){return r};e.getTileSet=function(){return p};e.getTileId=function(s,t){return r[Math.floor(t/f)][Math.floor(s/a)]};e.getWidth=function(){return n};e.getHeight=function(){return k};e.getTileWidth=function(){return a};e.getTileHeight=function(){return f};e.getZIndex=function(){return l};return e};FM.vector=function(b,a){var c={};c.x=b===undefined?0:b;c.y=a===undefined?0:a;c.add=function(d){c.x+=d.x;c.y+=d.y;return c};c.substract=function(d){c.x-=d.x;c.y-=d.y;return c};c.multiply=function(d){c.x*=d.x;c.y*=d.y;return c};c.dotProduct=function(d){return(c.x*d.x+c.y*d.y)};c.crossProd=function(d){return c.x*d.y-c.y*d.x};c.reset=function(e,d){c.x=typeof e==="undefined"?0:e;c.y=typeof d==="undefined"?0:d;return c};c.getLength=function(){return Math.sqrt((c.x*c.x)+(c.y*c.y))};c.getLengthSquared=function(){return(c.x*c.x)+(c.y*c.y)};c.normalize=function(){var d=c.getLength();c.x=c.x/d;c.y=c.y/d};c.copy=function(d){c.x=d.x;c.y=d.y;return c};c.clone=function(){return new FM.vector(c.x,c.y)};c.isEquals=function(d){return(c.x===d.x&&c.y===d.y)};c.destroy=function(){c=null};return c};FM.world=function(a,d){var c=FM.rectangle(0,0,a,d),b=[];c.loadTileMap=function(e,h,f,g){e.load(h.getLayer(f).toCsv(h.getTileSet(g)));b.push(e)};c.getTileMapFromType=function(f){var g,e;for(g=0;g<b.length;g=g+1){e=b[g];if(e.hasType(f)){return e}}return null};c.hasTileCollisions=function(){var e;for(e=0;e<b.length;e=e+1){if(b[e].canCollide()){return true}}return false};c.destroy=function(){c=null};return c};FM.collision=function(a,c){var b={};b.a=a==="undefined"?null:a;b.b=c==="undefined"?null:c;b.penetration=0;b.normal=null;b.destroy=function(){b.normal=null;b=null};return b};FM.component=function(c,a){var b={};if(a){if(a.components!==undefined){b.name=c;b.owner=a}else{if(FM.parameters.debug){console.log("ERROR: the owner of the "+c+" component must be a gameObject.")}}}else{if(FM.parameters.debug){console.log("ERROR: a owner game object must be specified.")}}b.destroy=function(){b.name=null;b.owner=null;b=null};return b};FM.audioAsset=function(a,f){var e=new Audio(),d=a,g=f,h=g.substring(g.lastIndexOf(".")+1),c=false,b=function(){c=true;FM.assetManager.assetLoaded()};e.load=function(i){e.src=g;c=false;if(i===undefined){e.addEventListener("loadeddata",b,false)}else{e.addEventListener("loadeddata",function(){b(i);i(e)},false)}};e.isLoaded=function(){return c};e.destroy=function(){d=null;g=null;e=null};e.getName=function(){return d};e.getPath=function(){return g};e.isSupported=function(){var i=false;if(h==="wav"){i=!!e.canPlayType&&e.canPlayType('audio/wav; codecs="1"')!==""}else{if(h==="ogg"){i=!!e.canPlayType&&e.canPlayType('audio/ogg; codecs="vorbis"')!==""}else{if(h==="mp3"){i=!!e.canPlayType&&e.canPlayType("audio/mpeg;")!==""}else{if(h==="aac"){i=!!e.canPlayType&&e.canPlayType('audio/mp4; codecs="mp4a.40.2"')!==""}}}}return i};return e};FM.fileAsset=function(a,g){var f=new XMLHttpRequest(),d=a,h=g,e=null,c=false,b=function(){c=true;e=f.responseText;FM.assetManager.assetLoaded()};f.load=function(){f.addEventListener("load",b,false);f.open("GET",h,false);f.send()};f.isLoaded=function(){return c};f.destroy=function(){d=null;h=null;e=null;f=null};f.getName=function(){return d};f.getPath=function(){return h};f.getContent=function(){return e};return f};FM.imageAsset=function(a,f){var e=new Image(),d=a,g=f,c=false,b=function(){c=true;FM.assetManager.assetLoaded()};e.load=function(){e.src=g;e.addEventListener("load",b,false)};e.isLoaded=function(){return c};e.destroy=function(){d=null;g=null;e=null};e.getName=function(){return d};e.getPath=function(){return g};return e};FM.preloader=function(a){var b=Object.create(FM.state()),c,d;b.init=function(){Object.getPrototypeOf(b).init();c=FM.game.getScreenWidth();d=FM.game.getScreenHeight()};b.update=function(f){Object.getPrototypeOf(b).update(f);var e=FM.assetManager;if(e.assets.length===0||e.areAllAssetsLoaded()){FM.game.switchState(a())}};b.draw=function(e,f){Object.getPrototypeOf(b).draw(e,f);e.fillStyle="#fff";e.font="30px sans-serif";e.textBaseline="middle";e.fillText(Math.ceil(FM.assetManager.loadingProgress)+"%",c/2,d/2)};return b};FM.quadTree=function(f,k){var g={},j=10,e=5,c=f,i=[],a=k,b=[],d=function(l){var m=-1,p=l.components[FM.componentTypes.SPATIAL],s=l.components[FM.componentTypes.PHYSIC],o=a.x+(a.width/2),q=a.y+(a.height/2),n=(p.position.y<q&&p.position.y+s.height<q),r=(p.position.y>q);if(p.position.x<o&&p.position.x+s.width<o){if(n){m=1}else{if(r){m=2}}}else{if(p.position.x>o){if(n){m=0}else{if(r){m=3}}}}return m},h=function(){var m=a.width/2,n=a.height/2,l=a.x,o=a.y;b.push(FM.quadTree(c+1,FM.rectangle(l+m,o,m,n)));b.push(FM.quadTree(c+1,FM.rectangle(l,o,m,n)));b.push(FM.quadTree(c+1,FM.rectangle(l,o+n,m,n)));b.push(FM.quadTree(c+1,FM.rectangle(l+m,o+n,m,n)))};g.insert=function(l){if(b.length>0){var m=d(l);if(m!==-1){b[m].insert(l);return}}i.push(l);if(i.length>j&&c<e){if(b.length===0){h()}var n=0,m;while(n<i.length){m=d(i[n]);if(m!==-1){b[m].insert(i.splice(n,1)[0])}else{n=n+1}}}};g.retrieve=function(l){var o=[];var m=d(l);if(m!==-1&&b.length>0){o=b[m].retrieve(l)}var n;for(n=0;n<i.length;n=n+1){o.push(i[n])}return o};g.clear=function(){i=[];var l;for(l=0;l<b.length;l=l+1){if(b[l]){b[l].clear();b[l]=null}}b=[]};return g};if(typeof Object.create!=="function"){Object.create=function(b){function a(){}a.prototype=b;return new a()}}if(typeof Object.getPrototypeOf!=="function"){if(typeof"test".__proto__==="object"){Object.getPrototypeOf=function(a){return a.__proto__}}else{Object.getPrototypeOf=function(a){return a.constructor.prototype}}}FM.includeJsFile=function(b){var c=document.getElementsByTagName("head")[0],a=document.createElement("script");a=document.createElement("script");a.src=b;a.type="text/javascript";c.appendChild(a)};FM.tmxLayer=function(){var a={};a.map;a.name;a.x;a.y;a.width;a.height;a.opacity;a.visible;a.tileGids=[];a.properties=null;a.load=function(j,l){a.map=l;a.name=j.getAttribute("name");a.x=parseInt(j.getAttribute("x"));a.y=parseInt(j.getAttribute("y"));a.width=parseInt(j.getAttribute("width"));a.height=parseInt(j.getAttribute("height"));a.visible=!j.getAttribute("visible")||(j.getAttribute("visible")!==0);a.opacity=parseInt(j.getAttribute("opacity"));var h=j.getElementsByTagName("properties")[0],c=j.getElementsByTagName("data")[0],n=c.getElementsByTagName("tile"),m,g,d;if(h){for(d=0;d<h.childNodes.length;d++){if(h.hasChildNodes()===true){m=h.childNodes[d];if(m.nodeType===1){if(a.properties){a.properties.add(m)}else{a.properties=FM.tmxPropertySet();a.properties.add(m)}}}}}if(c){var k="",f=a.width,b=-1,e;if(!c.getAttribute("encoding")||(c.getAttribute("encoding")&&c.getAttribute("encoding").length===0)){for(d=0;d<n.length;d=d+1){g=n[d];if(++f>=a.width){a.tileGids[++b]=[];f=0}e=g.getAttribute("gid");a.tileGids[b].push(e)}}else{if(c.getAttribute("encoding")==="csv"){k=c.childNodes[0].nodeValue;a.tileGids=a.csvToArray(k,a.width)}else{if(c.getAttribute("encoding")==="base64"){console.log("ERROR: TmxLoader, use XML or CSV export.")}}}}};a.toCsv=function(c){var g=16777215,e=0,l="",k=null,h="",b=0,f,d;if(c){e=c.firstGID;g=c.numTiles-1}for(f=0;f<a.tileGids.length;f=f+1){k=a.tileGids[f];h="";b=0;for(d=0;d<k.length;d=d+1){b=k[d];b-=e;if(b<0||b>g){b=0}l+=h;h=b+","}l+=b+"\n"}return l};a.csvToArray=function(f,e){var l=[],k=f.split("\n"),h=null,g=null,d=null,c,b;for(c=0;c<k.length;c=c+1){h=k[c];if(h){g=[];d=h.split(",",e);for(b=0;b<d.length;b=b+1){g.push(d[b])}l.push(g)}}return l};return a};FM.tmxMap=function(){var a={},b=null;a.version="unknown";a.orientation="orthogonal";a.width=0;a.height=0;a.tileWidth=0;a.tileHeight=0;a.properties=null;a.layers=[];a.tileSets=[];a.objectGroups=[];a.load=function(c){var o,d;if(window.DOMParser){d=new DOMParser();o=d.parseFromString(c,"text/xml")}else{o=new ActiveXObject("Microsoft.XMLDOM");o.async=false;o.loadXML(c)}b=o.getElementsByTagName("map")[0];a.version=b.getAttribute("version")||"unknown";a.orientation=b.getAttribute("orientation")||"orthogonal";a.width=parseInt(b.getAttribute("width"));a.height=parseInt(b.getAttribute("height"));a.tileWidth=parseInt(b.getAttribute("tilewidth"));a.tileHeight=parseInt(b.getAttribute("tileheight"));var l=b.getElementsByTagName("properties")[0],k=b.getElementsByTagName("tileset"),g=b.getElementsByTagName("layer"),h=b.getElementsByTagName("objectgroup"),m,e,j,n,f;if(l){for(f=0;f<l.childNodes.length;f++){if(l.hasChildNodes()===true){m=l.childNodes[f];if(m.nodeType===1){if(a.properties){a.properties.add(m)}else{a.properties=FM.tmxPropertySet();a.properties.add(m)}}}}}if(k){for(f=0;f<k.length;f++){e=k[f];a.tileSets[e.getAttribute("name")]=FM.tmxTileSet();a.tileSets[e.getAttribute("name")].load(e,a)}}if(g){for(f=0;f<g.length;f++){j=g[f];a.layers[j.getAttribute("name")]=FM.tmxLayer();a.layers[j.getAttribute("name")].load(j,a)}}if(h){for(f=0;f<h.length;f++){n=h[f];a.objectGroups[n.getAttribute("name")]=FM.tmxObjectGroup();a.objectGroups[n.getAttribute("name")].load(n,a)}}};a.getTileSet=function(c){return a.tileSets[c]};a.getLayer=function(c){return a.layers[c]};a.getObjectGroup=function(c){return a.objectGroups[c]};a.getGidOwner=function(d){var e=null;for(var c in a.tileSets){if(c.hasGid(d)){return c}}return null};return a};FM.tmxObject=function(a,e){var f={};f.group=e;f.name=a.getAttribute("name");f.type=a.getAttribute("type");f.x=parseInt(a.getAttribute("x"));f.y=parseInt(a.getAttribute("y"));f.width=parseInt(a.getAttribute("width"));f.height=parseInt(a.getAttribute("height"));f.shared=null;f.gid=-1;if(a.getAttribute("gid")&&a.getAttribute("gid").length!==0){f.gid=parseInt(a.getAttribute("gid"));var h=f.group.map.tileSets,d,c;if(h){for(c=0;c<h.length;c=c+1){d=h[c];f.shared=d.getPropertiesByGid(f.gid);if(f.shared){break}}}}var b=a.getElementsByTagName("properties")[0],g,c;if(b){for(c=0;c<b.childNodes.length;c=c+1){if(b.hasChildNodes()===true){g=b.childNodes[c];if(g.nodeType===1){if(f.custom){f.custom.add(g)}else{f.custom=FM.tmxPropertySet();f.custom.add(g)}}}}}return f};FM.tmxObjectGroup=function(){var a={};a.map;a.name;a.x;a.y;a.width;a.height;a.opacity;a.visible;a.properties=null;a.objects=[];a.load=function(h,e){a.map=e;a.name=h.getAttribute("name");a.x=parseInt(h.getAttribute("x"));a.y=parseInt(h.getAttribute("y"));a.width=parseInt(h.getAttribute("width"));a.height=parseInt(h.getAttribute("height"));a.visible=!h.getAttribute("visible")||(h.getAttribute("visible")!==0);a.opacity=parseInt(h.getAttribute("opacity"));var d=h.getElementsByTagName("properties")[0],g=h.getElementsByTagName("object"),f,b,c;if(d){for(c=0;c<d.childNodes.length;c=c+1){if(d.hasChildNodes()===true){f=d.childNodes[c];if(f.nodeType===1){if(a.properties){a.properties.add(f)}else{a.properties=FM.tmxPropertySet();a.properties.add(f)}}}}}if(g){for(c=0;c<g.length;c=c+1){b=g[c];a.objects.push(FM.tmxObject(b,a))}}};return a};FM.tmxPropertySet=function(){var a=[];a.add=function(c){var b=c.getAttribute("name"),d=c.getAttribute("value");a[b]=d};return a};FM.tmxTileSet=function(){var b={},a=[],c=null;b.firstGID=0;b.map;b.name;b.tileWidth;b.tileHeight;b.spacing;b.margin;b.imageSource;b.numTiles=16777215;b.numRows=1;b.numCols=1;b.load=function(m,h){b.map=h;b.firstGID=parseInt(m.getAttribute("firstgid"));b.imageSource=m.getElementsByTagName("image")[0].getAttribute("source");b.name=m.getAttribute("name");b.tileWidth=parseInt(m.getAttribute("tilewidth"));b.tileHeight=parseInt(m.getAttribute("tileheight"));b.spacing=parseInt(m.getAttribute("spacing"));b.margin=parseInt(m.getAttribute("margin"));var d=m.getElementsByTagName("tile"),k,g,l,f,e;if(d){for(f=0;f<d.length;f++){k=d[f];g=k.getElementsByTagName("properties")[0];if(g){for(e=0;e<g.childNodes.length;e++){if(g.hasChildNodes()===true){l=g.childNodes[e];if(l.nodeType===1){a[k.getAttribute("id")]=FM.tmxPropertySet();a[k.getAttribute("id")].add(l)}}}}}}};b.getImage=function(){return c};b.setImage=function(d){c=d;b.numCols=Math.floor(c.width/b.tileWidth);b.numRows=Math.floor(c.height/b.tileHeight);b.numTiles=b.numRows*b.numCols};b.hasGid=function(d){return(d>=b.firstGID)&&(d<b.firstGID+b.numTiles)};b.fromGid=function(d){return d-b.firstGID};b.toGid=function(d){return b.firstGID+d};b.getPropertiesByGid=function(d){return a[d-b.firstGID]};b.getProperties=function(d){return a[d]};b.getRect=function(d){return new FM.rectangle(0,0,(d%b.numCols)*b.tileWidth,(d/b.numCols)*b.tileHeight)};return b};FM.emitterComponent=function(h,d){var l=FM.component(FM.componentTypes.FX,d),q=[],i=h,m=[FM.parameters.LEFT,FM.parameters.RIGHT,FM.parameters.UP,FM.parameters.DOWN],j=0,n=0.1,g=0,f=1,o=FM.vector(-100,-100),b=FM.vector(100,100),p=-100,a=100,e=false,c=0,k=d.components[FM.componentTypes.SPATIAL];if(!k&&FM.parameters.debug){console.log("ERROR: No spatial component was added and you need one for rendering.")}d.addComponent(l);l.add=function(r){q.push(r);return r};l.createParticles=function(u,t,s,C,w,A){var v,y,x,z,B,r=FM.game.getCurrentState();f=w;for(v=0;v<u;v=v+1){y=FM.gameObject(A);x=FM.spatialComponent(x.position.x+i.x,x.position.y+i.y,y);z=FM.spriteRendererComponent(t,s,C,y);z.setAlpha(f);B=FM.aabbComponent(s,C,y);y.age=0;y.lifeSpan=0;y.hide();y.kill();r.add(y);q.push(y)}};l.emit=function(t,r,u){e=true;c=0;n=r;g=u;var s;for(s=0;s<q.length;s=s+1){q[s].lifeSpan=t}};l.update=function(s){if(e){var v,u,x,w,r,z,y,t;for(v=0;v<q.length;v=v+1){w=q[v];if(w.isAlive()){if(w.age>=w.lifeSpan){w.hide();w.kill()}else{y=w.getComponent(FM.componentTypes.RENDERER);if(y.getAlpha()>=1-(w.age/w.lifeSpan)){y.setAlpha(1-(w.age/w.lifeSpan))}w.age+=s}}}c+=s;if(n===0||c>=n){c=0;x=0;u=0;while(x<g&&u<q.length){w=q[u];if(w&&!w.isAlive()){r=w.getComponent(FM.componentTypes.SPATIAL);z=w.components[FM.componentTypes.PHYSIC];w.components[FM.componentTypes.RENDERER].setAlpha(f);r.position.x=k.position.x+i.x;r.position.y=k.position.y+i.y;w.age=0;t=Math.random()*(b.x-o.x)+o.x;if(m.indexOf(FM.parameters.LEFT)!==-1){if(Math.random()>0.5){t=-t}}z.velocity.x=t;t=Math.random()*(b.y-o.y)+o.y;if(m.indexOf(FM.parameters.UP)!==-1){if(Math.random()>0.5){t=-t}}z.velocity.y=t;t=Math.random()*(a-p)+p;z.angularVelocity=t;w.show();w.revive();x=x+1}u=u+1}}}};l.setDirections=function(r){m=r};l.setAlpha=function(r){f=r;var s;for(s=0;s<q.length;s=s+1){q[s].components[FM.componentTypes.RENDERER].setAlpha(f)}};l.setXVelocity=function(s,r){o.x=s;b.x=r};l.setYVelocity=function(s,r){o.y=s;b.y=r};l.setAngularVelocity=function(s,r){p=s;a=r};l.getAlpha=function(){return f};l.destroy=function(){q=null;l=null};return l};FM.simplePathComponent=function(b){var e=FM.component(FM.componentTypes.PATHFINDING,b),i=[],g=0,k=FM.vector(0,0),a=FM.vector(0,0),c=false,j=false,f=false,h=FM.vector(0,0),d=b.components[FM.componentTypes.SPATIAL],l=b.components[FM.componentTypes.PHYSIC];if(FM.parameters.debug){if(!d){console.log("ERROR: No spatial component was added and you need one for using the path component.")}if(!l){console.log("ERROR: No physic component was added and you need one for using the path component.")}}b.addComponent(e);e.startFollowingPath=function(o,m){if(i.length>0){c=true;g=m||0;j=false;f=false;k=o;var q=Math.abs((d.position.x+l.offset.x+l.width/2)-i[g].x),p=Math.abs((d.position.y+l.offset.y+l.height/2)-i[g].y),n;if(q<p){n=q/p;a.x=k*n;a.y=k}else{if(q>p){n=p/q;a.x=k;a.y=k*n}else{a.x=k;a.y=k}}}else{if(FM.parameters.debug){console.log("WARNING: path with no waypoints defined.")}}if(!l){console.log("WARNING: path added to a game object with no physic component.")}};e.resumeFollowingPath=function(){if(i.length>0){c=true;if(h.x!==d.position.x||h.y!==d.position.y){j=false;f=false;var o=Math.abs((d.position.x+l.offset.x+l.width/2)-i[g].x),n=Math.abs((d.position.y+l.offset.y+l.height/2)-i[g].y),m;if(o<n){m=o/n;a.x=k*m;a.y=k}else{if(o>n){m=n/o;a.x=k;a.y=k*m}else{a.x=k;a.y=k}}}}else{if(FM.parameters.debug){console.log("WARNING: path with no waypoints defined.")}}if(!l){console.log("WARNING: path added to a game object with no physic component.")}};e.stopFollowingPath=function(){c=false;l.velocity.x=0;l.velocity.y=0;h=FM.vector(d.position.x,d.position.y)};e.clearPath=function(){i=[]};e.update=function(p){if(c&&l){var q=d.position.x+l.offset.x+l.width/2,o=d.position.y+l.offset.y+l.height/2,r,n,m;if(q<i[g].x){if(i[g].x-q<a.x*p){l.velocity.x=i[g].x-q;j=true}else{l.velocity.x=a.x}}else{if(q>i[g].x){if(q-i[g].x<a.x*p){l.velocity.x=q-i[g].x;j=true}else{l.velocity.x=-a.x}}else{j=true;l.velocity.x=0}}if(o<i[g].y){if(i[g].y-o<a.y*p){l.velocity.y=i[g].y-o;f=true}else{l.velocity.y=a.y}}else{if(o>i[g].y){if(o-i[g].y<a.y*p){l.velocity.y=o-i[g].y;f=true}else{l.velocity.y=-a.y}}else{f=true;l.velocity.y=0}}if(j&&f){if(i.length>g+1){j=false;f=false;g=g+1;r=Math.abs(q-i[g].x);n=Math.abs(o-i[g].y);if(r<n){m=r/n;a.x=k*m;a.y=k}else{if(r>n){m=n/r;a.x=k;a.y=k*m}else{a.x=k;a.y=k}}}else{c=false;a=FM.vector(0,0);k=0;l.velocity=FM.vector(0,0)}}}};e.add=function(o,m,n){if(n===undefined){i.push({x:o,y:m})}else{i[n]={x:o,y:m}}};e.remove=function(m){i.splice(m,1)};e.getWaypoints=function(){return i};e.getCurrentIndex=function(){return g};e.getCurrentWaypoint=function(){return i[g]};e.getLength=function(){return i.length};e.isLastWaypointReached=function(){return g===i.length-1&&!c};e.isActive=function(){return c};e.destroy=function(){i=null;d=null;l=null;e.destroy();e=null};return e};FM.aabbComponent=function(a,e,d){var c=FM.physicComponent(a,e,d),b=d.components[FM.componentTypes.SPATIAL];if(FM.parameters.debug){if(!b){console.log("ERROR: No spatial component was added and you need one for physics.")}}d.addComponent(c);c.overlapsWithType=function(f){return null};c.overlapsWithObject=function(f){var g=f.overlapsWithAabb(c);if(g){return g}return null};c.overlapsWithAabb=function(j){var s=j.owner.components[FM.componentTypes.SPATIAL],i=FM.vector(b.position.x+c.offset.x,b.position.y+c.offset.y),q=FM.vector(s.position.x+j.offset.x,s.position.y+j.offset.y),n=FM.vector(i.x+c.width,i.y+c.height),g=FM.vector(q.x+j.width,q.y+j.height),f=FM.vector(i.x+c.width/2,i.y+c.height/2),h=FM.vector(q.x+j.width/2,q.y+j.height/2),l=FM.math.substractVectors(h,f),r=(n.x-i.x)/2,k=(g.x-q.x)/2,p=r+k-Math.abs(l.x),m,o=null;if(n.x<q.x||i.x>g.x){return null}if(n.y<q.y||i.y>g.y){return null}if(p>0){r=(n.y-i.y)/2;k=(g.y-q.y)/2;m=r+k-Math.abs(l.y);if(m>0){o=FM.collision(c,j);if(p<m){if(l.x<0){o.normal=l.reset(-1,0)}else{o.normal=l.reset(1,0)}o.penetration=p}else{if(l.y<0){o.normal=l.reset(0,-1)}else{o.normal=l.reset(0,1)}o.penetration=m}return o}}return null};c.overlapsWithCircle=function(h){var t=h.owner.components[FM.componentTypes.SPATIAL],m=FM.vector(b.position.x+c.offset.x,b.position.y+c.offset.y),s=FM.vector(t.position.x+h.offset.x,t.position.y+h.offset.y),q=FM.vector(m.x+c.width,m.y+c.height),f=FM.vector(m.x+c.width/2,m.y+c.height/2),l=FM.vector(s.x+h.radius,s.y+h.radius),p=FM.math.substractVectors(l,f),g,n,i=p.clone(),j=(q.x-m.x)/2,o=(q.y-m.y)/2,k=false,r=null;i.x=FM.math.clamp(i.x,-j,j);i.y=FM.math.clamp(i.y,-o,o);if(p.isEquals(i)){k=true;if(Math.abs(p.x)>Math.abs(p.y)){if(i.x>0){i.x=j}else{i.x=-j}}else{if(i.y>0){i.y=o}else{i.y=-o}}}r=FM.collision();r.a=c;r.b=h;r.normal=FM.math.substractVectors(p,i);g=r.normal.getLengthSquared();n=h.radius;if(g>n*n&&!k){return null}g=Math.sqrt(g);r.penetration=n-g;if(k){r.normal.reset(-r.normal.x,-r.normal.y)}r.normal.normalize();return r};c.drawDebug=function(g,i){var f=FM.vector(i.x+c.width/2,i.y+c.height/2),h=FM.vector(Math.cos(b.angle),Math.sin(b.angle));g.strokeStyle="#f4f";g.strokeRect(i.x+c.offset.x-g.xOffset,i.y+c.offset.y-g.yOffset,c.width,c.height);g.beginPath();g.strokeStyle="Blue";g.beginPath();g.moveTo(f.x+c.offset.x-g.xOffset,f.y+c.offset.y-g.yOffset);g.lineTo((f.x+c.offset.x+h.x*50)-g.xOffset,(f.y+c.offset.y+h.y*50)-g.yOffset);g.stroke()};c.destroy=function(){b=null;Object.getPrototypeOf(c).destroy();c=null};return c};FM.circleComponent=function(d,c){var b=FM.physicComponent(d*2,d*2,c),a=c.components[FM.componentTypes.SPATIAL];if(FM.parameters.debug){if(!a){console.log("ERROR: No spatial component was added and you need one for physics.")}}c.addComponent(b);b.radius=d;b.overlapsWithType=function(e){return null};b.overlapsWithObject=function(e){var f=e.overlapsWithCircle(b);if(f){return f}return null};b.overlapsWithAabb=function(m){var s=m.owner.components[FM.componentTypes.SPATIAL],l=FM.vector(a.position.x+b.offset.x,a.position.y+b.offset.y),r=FM.vector(s.position.x+m.offset.x,s.position.y+m.offset.y),i=FM.vector(r.x+m.width,r.y+m.height),e=FM.vector(l.x+b.radius,l.y+b.radius),k=FM.vector(r.x+m.width/2,r.y+m.height/2),p=FM.math.substractVectors(k,e),f,n,g=p.clone(),h=(i.x-r.x)/2,o=(i.y-r.y)/2,j=false,q=null;g.x=FM.math.clamp(g.x,-h,h);g.y=FM.math.clamp(g.y,-o,o);if(p.isEquals(g)){j=true;if(Math.abs(p.x)>Math.abs(p.y)){if(g.x>0){g.x=h}else{g.x=-h}}else{if(g.y>0){g.y=o}else{g.y=-o}}}q=FM.collision();q.a=b;q.b=m;q.normal=FM.math.substractVectors(p,g);f=q.normal.getLengthSquared();n=b.radius;if(f>(n*n)&&!j){return null}f=Math.sqrt(f);q.penetration=n-f;if(j){q.normal.reset(-q.normal.x,-q.normal.y)}q.normal.normalize();return q};b.overlapsWithCircle=function(g){var n=g.owner.components[FM.componentTypes.SPATIAL],i=FM.vector(a.position.x+b.offset.x,a.position.y+b.offset.y),m=FM.vector(n.position.x+g.offset.x,n.position.y+g.offset.y),e=FM.vector(i.x+b.width/2,i.y+b.height/2),h=FM.vector(m.x+g.width/2,m.y+g.height/2),j=b.radius+g.radius,j=j*j,k=FM.math.substractVectors(h,e),f=k.getLength(),l=null;if(k.getLengthSquared()>j){return null}else{l=FM.collision();l.a=b;l.b=g;if(f!==0){l.penetration=j-f;l.normal=k.reset(k.x/f,k.y/f)}else{l.penetration=b.radius;l.normal=k.reset(1,0)}return l}return null};b.drawDebug=function(f,h){var e=FM.vector(h.x+b.radius,h.y+b.radius),g=FM.vector(Math.cos(a.angle),Math.sin(a.angle));f.beginPath();f.strokeStyle="#f4f";f.arc((e.x+b.offset.x)-f.xOffset,(e.y+b.offset.y)-f.yOffset,b.radius,0,2*Math.PI,false);f.stroke();f.beginPath();f.strokeStyle="Blue";f.beginPath();f.moveTo(e.x+b.offset.x-f.xOffset,e.y+b.offset.y-f.yOffset);f.lineTo((e.x+b.offset.x+g.x*50)-f.xOffset,(e.y+b.offset.y+g.y*50)-f.yOffset);f.stroke()};b.destroy=function(){a=null;Object.getPrototypeOf(b).destroy();b=null};return b};FM.physicComponent=function(d,o,c){var l=FM.component(FM.componentTypes.PHYSIC,c),k=FM.game.getCurrentState().getWorld(),p=FM.game.getCurrentState().getQuad(),n=1,g=1/n,h=[],m=[],j=[],i=c.components[FM.componentTypes.SPATIAL],f=function(w){var s=FM.vector(w.penetration*w.normal.x,w.penetration*w.normal.y),v=w.a.owner.components[FM.componentTypes.SPATIAL],u=w.b.owner.components[FM.componentTypes.SPATIAL],t=0,r=w.a.getInvMass(),q=w.b.getInvMass();t=r+q;v.position.x-=s.x*(r/t);v.position.y-=s.y*(r/t);u.position.x+=s.x*(q/t);u.position.y+=s.y*(q/t)},e=function(y,x,w,v,q){var s=Math.floor(q/w),A=Math.floor(v/x),r=Math.floor((q+l.height)/w),z=Math.floor((v+l.width)/x),u,t;for(u=s;u<=r;u=u+1){for(t=A;t<=z;t=t+1){if(y[u]!==0&&y[u][t]!==-1){if(t===A||t===z||u===s||u===r){return true}}}}return false},a=function(s,w,r,v,q){var u=i.position.x+v,t=i.position.y+q;if(!e(s,w,r,u+l.offset.x,t+l.offset.y)){i.position.x=u;i.position.y=t;return true}return false},b=function(w,v,s){var A=w.getData(),y=w.getTileWidth(),x=w.getTileHeight(),r=false;if(Math.abs(v)>=y||Math.abs(s)>=x){b(w,v/2,s/2);b(w,v-v/2,s-s/2);return}var q=a(A,y,x,v,0),u=a(A,y,x,0,s),t,B,z;if(q&&u){return}if(!q){l.velocity.x=0;B=Math.abs(v);for(t=0;t<B;t=t+1){if(v===0){z=0}else{if(v>0){z=1}else{z=-1}}if(!a(A,y,x,z,0)){r=true;break}else{l.velocity.x+=z}}}if(!u){l.velocity.y=0;B=Math.abs(s);for(t=0;t<B;t=t+1){if(s===0){z=0}else{if(s>0){z=1}else{z=-1}}if(!a(A,y,x,0,z)){r=true;break}else{l.velocity.y+=z}}}return r};l.offset=FM.vector(0,0);l.width=d;l.height=o;l.velocity=FM.vector(0,0);l.acceleration=FM.vector(0,0);l.drag=FM.vector(0,0);l.angularVelocity=0;l.angularDrag=FM.vector(0,0);l.maxVelocity=FM.vector(1000,1000);l.maxAngularVelocity=10000;l.elasticity=0;if(!i&&FM.parameters.debug){console.log("ERROR: No spatial component was added and you need one for physics.")}l.update=function(q){m=[];j=[];var u=l.velocity.x+(g*l.acceleration.x)*q,s=l.maxVelocity.x+(g*l.acceleration.x)*q,y=true,r=false,z,x,v,t,B,w,A=null;if(Math.abs(u)<=s){l.velocity.x=u}else{if(u<0){l.velocity.x=-s}else{if(u>0){l.velocity.x=s}}}u=l.velocity.y+(g*l.acceleration.y)*q;s=l.maxVelocity.y+(g*l.acceleration.y)*q;if(Math.abs(u)<=s){l.velocity.y=u}else{if(u<0){l.velocity.y=-s}else{if(u>0){l.velocity.y=s}}}if(l.acceleration.x===0){if(l.velocity.x>0){l.velocity.x-=l.drag.x;if(l.velocity.x<0){l.velocity.x=0}}else{if(l.velocity.x<0){l.velocity.x+=l.drag.x;if(l.velocity.x>0){l.velocity.x=0}}}}if(l.acceleration.y===0){if(l.velocity.y>0){l.velocity.y-=l.drag.y;if(l.velocity.y<0){l.velocity.y=0}}else{if(l.velocity.y<0){l.velocity.y+=l.drag.y;if(l.velocity.y>0){l.velocity.y=0}}}}if(h.length>0){if(k.hasTileCollisions()){for(v=0;v<h.length;v=v+1){z=k.getTileMapFromType(h[v]);if(z&&z.canCollide()){r=b(z,l.velocity.x*q,l.velocity.y*q);if(r){j.push({a:l.owner,b:z})}y=false}}}}if(y){i.position.x+=l.velocity.x*q;i.position.y+=l.velocity.y*q}if(h.length>0){p=FM.game.getCurrentState().getQuad();x=p.retrieve(c);for(v=0;v<x.length;v=v+1){B=x[v];w=B.components[FM.componentTypes.PHYSIC];if(B.isAlive()&&c.getId()!==B.getId()&&!w.isCollidingWith(c)&&!l.isCollidingWith(B)){for(t=0;t<h.length;t=t+1){if(B.hasType(h[t])){A=c.components[FM.componentTypes.PHYSIC].overlapsWithObject(w);if(A!==null){l.addCollision(A);w.addCollision(A);l.resolveCollision(w,A);w.resolveCollision(l,A);f(A)}}}}}}};l.resolveCollision=function(r,x){var w=FM.math.substractVectors(r.velocity,l.velocity),s=w.dotProduct(x.normal),v=Math.min(l.elasticity,r.elasticity),q=0,t=r.getInvMass(),u=FM.vector(0,0);if(s>0){return}q=-(1+v)*s;q/=g+t;u.reset(q*x.normal.x,q*x.normal.y);l.velocity.x-=g*u.x;l.velocity.y-=g*u.y;r.velocity.x+=t*u.x;r.velocity.y+=t*u.y};l.addTypeToCollideWith=function(q){h.push(q)};l.removeTypeToCollideWith=function(q){h.splice(h.indexOf(q),1)};l.addCollision=function(q){m.push(q)};l.getLinearVelocity=function(){return l.velocity};l.isCollidingWithType=function(r){var q,s;for(q=0;q<m.length;q=q+1){s=m[q];if((s.b&&s.b.owner.hasType(r))||(s.a&&s.a.owner.hasType(r))){return true}}for(q=0;q<j.length;q=q+1){s=j[q];if((s.b&&s.b.hasType(r))||(s.a&&s.a.hasType(r))){return true}}return false};l.isCollidingWith=function(r){var q,s;for(q=0;q<m.length;q=q+1){s=m[q];if((s.b&&s.b.owner.getId()===r.getId())||(s.a&&s.a.owner.getId()===r.getId())){return true}}return false};l.setMass=function(q){n=q;if(n===0){g=0}else{g=1/n}};l.getMass=function(){return n};l.getInvMass=function(){return g};return l};FM.animatedSpriteRendererComponent=function(o,q,h,a){var j=FM.component(FM.componentTypes.RENDERER,a),p=o,m=p.width,v=p.height,s=q,l=h,b=q,c=h,f=1,d="",i=false,x=0,k=0,n=[],g=0,t=0,w=0.1,r=0.1,u=[],e=a.components[FM.componentTypes.SPATIAL];if(!e&&FM.parameters.debug){console.log("ERROR: No spatial component was added and you need one for rendering.")}if(!p&&FM.parameters.debug){console.log("ERROR: No image was provided and you need one for rendering an animated sprite.")}a.addComponent(j);j.finished=false;j.addAnimation=function(z,A,y,B){g=0;d=z;n[z]=A;w=1/y;r=w;u[z]=B};j.play=function(y){d=y;j.finished=false;g=0;x=n[d][g]*s;k=Math.floor(x/m)*l;if(x>=m){k=Math.floor(x/m)*l;x=(x%m);x=Math.round(x);k=Math.round(k)}};j.stop=function(){j.finished=true};j.draw=function(y,z){var C=z.x,B=z.y,A=(new Date()).getTime()/1000;C-=y.xOffset*a.scrollFactor.x;B-=y.yOffset*a.scrollFactor.y;C=Math.round(C);B=Math.round(B);y.globalAlpha=f;if(e.angle!==0){y.save();y.translate(Math.round(C),Math.round(B));y.translate(Math.round(s/2),Math.round(l/2));y.rotate(e.angle);y.drawImage(p,Math.round(x),Math.round(k),s,l,Math.round(-b/2),Math.round(-c/2),b,c);y.restore()}else{y.drawImage(p,Math.round(x),Math.round(k),s,l,Math.round(C),Math.round(B),b,c)}y.globalAlpha=1;if(!j.finished){if(r<=0){r=w;if(n[d]){if(n[d].length>1){g=g+1;if(n[d]&&(g===n[d].length-1)){if(u[d]){g=0}else{j.finished=true}}}else{j.finished=true}x=n[d][g]*s;k=Math.floor(x/m)*l;if(x>=m){k=Math.floor(x/m)*l;x=(x%m);x=Math.round(x);k=Math.round(k)}}}else{r-=A-t}}t=A};j.destroy=function(){p.destroy();p=null;d=null;n=null;u=null;e=null;j.destroy();j=null};j.getCurrentAnim=function(){return d};j.changeSize=function(y){b=y*s;c=y*l};j.setWidth=function(y){b=y};j.setHeight=function(y){c=y};j.setAlpha=function(y){f=y};j.getWidth=function(){return b};j.getHeight=function(){return c};j.getOriginalWidth=function(){return s};j.getOriginalHeight=function(){return l};j.getAlpha=function(){return f};return j};FM.boxRendererComponent=function(c,i,f,b){var h=FM.component(FM.componentTypes.RENDERER,b),a=c,j=i,e=f,d=1,g=b.components[FM.componentTypes.SPATIAL];if(!g&&FM.parameters.debug){console.log("ERROR: No spatial component was added and you need one for rendering.")}b.addComponent(h);h.draw=function(k,l){var n=l.x,m=l.y;n-=k.xOffset*b.scrollFactor.x;m-=k.yOffset*b.scrollFactor.y;n=Math.round(n);m=Math.round(m);k.globalAlpha=d;if(g.angle!==0){k.save();k.translate(n,m);k.translate(Math.round(a/2),Math.round(j/2));k.rotate(g.angle);k.beginPath();k.rect(n,m,a,j);k.restore()}else{k.beginPath();k.rect(n,m,a,j)}k.fillStyle=e;k.fill();k.globalAlpha=1};h.destroy=function(){g=null;h.destroy();h=null};h.setWidth=function(k){a=k};h.setHeight=function(k){j=k};h.setColor=function(k){e=k};h.setAlpha=function(k){d=k};h.getWidth=function(){return a};h.getHeight=function(){return j};h.getColor=function(){return e};h.getAlpha=function(){return d};return h};FM.circleRendererComponent=function(f,e,b){var h=FM.component(FM.componentTypes.RENDERER,b),a=f*2,i=f*2,d=e,c=1,g=b.components[FM.componentTypes.SPATIAL];if(!g&&FM.parameters.debug){console.log("ERROR: No spatial component was added and you need one for rendering.")}b.addComponent(h);h.draw=function(k,l){var n=l.x-k.xOffset*b.scrollFactor.x,m=l.y-k.yOffset*b.scrollFactor.y,j=FM.vector(n+a/2,m+i/2);k.globalAlpha=c;if(g.angle!==0){k.save();k.translate(Math.round(n),Math.round(m));k.translate(Math.round(a/2),Math.round(i/2));k.rotate(g.angle);k.beginPath();k.arc(Math.round(j.x),Math.round(j.y),Math.round(a/2),0,2*Math.PI);k.restore()}else{k.beginPath();k.arc(Math.round(j.x),Math.round(j.y),Math.round(a/2),0,2*Math.PI)}k.fillStyle=d;k.fill();k.globalAlpha=1};h.destroy=function(){g=null;h.destroy();h=null};h.setWidth=function(j){a=j;i=j};h.setHeight=function(j){i=j;a=j};h.setRadius=function(j){a=j*2;i=j*2};h.setColor=function(j){d=j};h.setAlpha=function(j){c=j};h.getWidth=function(){return a};h.getHeight=function(){return i};h.getRadius=function(){return a/2};h.getColor=function(){return d};h.getAlpha=function(){return c};return h};FM.lineRendererComponent=function(f,e,b){var i=FM.component(FM.componentTypes.RENDERER,b),j=[],a=0,k=0,g=f,d=e,c=1,h=b.components[FM.componentTypes.SPATIAL];if(!h&&FM.parameters.debug){console.log("ERROR: No spatial component was added and you need one for rendering.")}b.addComponent(i);i.draw=function(l,n){var p=n.x,o=n.y,m;p-=l.xOffset*b.scrollFactor.x;o-=l.yOffset*b.scrollFactor.y;l.globalAlpha=c;if(h.angle!==0){l.save();l.translate(Math.round(p),Math.round(o));l.translate(Math.round(a/2),Math.round(k/2));l.rotate(h.angle);if(j.length>0){l.beginPath();l.moveTo(Math.round(j[0].x),Math.round(j[0].y));for(m=1;m<j.length;m=m+1){l.lineTo(Math.round(j[m].x),Math.round(j[m].y))}}l.restore()}else{if(j.length>0){l.beginPath();l.moveTo(Math.round(j[0].x),Math.round(j[0].y));for(m=1;m<j.length;m=m+1){l.lineTo(Math.round(j[m].x),Math.round(j[m].y))}}}l.strokeStyle=d;l.lineWidth=g;l.stroke();l.globalAlpha=1;l.lineWidth=1};i.destroy=function(){h=null;i.destroy();var l;for(l=0;l<j.length;l=l+1){j[l].destroy()}j=null;i=null};i.addPoint=function(o){j.push(o);var p,l,n=0,r=0,m=0,q=0;for(p=0;p<j.length;p=p+1){l=j[p];if(l.x>n){n=l.x}if(l.x<r){r=l.x}if(l.y<m){m=l.y}if(l.y>q){q=l.y}}a=Math.abs(n-r);k=Math.abs(q-m)};i.setLineWidth=function(l){g=l};i.setLineStyle=function(l){d=l};i.setAlpha=function(l){c=l};i.getWidth=function(){return a};i.getHeight=function(){return k};i.getLineWidth=function(){return g};i.getLineStyle=function(){return d};i.getAlpha=function(){return c};return i};FM.spriteRendererComponent=function(f,c,k,b){var i=FM.component(FM.componentTypes.RENDERER,b),d=f,a=c,l=k,j=c,g=k,e=1,h=b.components[FM.componentTypes.SPATIAL];if(!h&&FM.parameters.debug){console.log("ERROR: No spatial component was added and you need one for rendering.")}if(!d&&FM.parameters.debug){console.log("ERROR: No image was provided and you need one for rendering a sprite.")}b.addComponent(i);i.offset=FM.vector(0,0);i.draw=function(m,n){var p=n.x,o=n.y,q=FM.vector(Math.round(i.offset.x),Math.round(i.offset.y));p-=m.xOffset*b.scrollFactor.x;o-=m.yOffset*b.scrollFactor.y;m.globalAlpha=e;if(h.angle!==0){m.save();m.translate(Math.round(p),Math.round(o));m.translate(Math.round(a/2),Math.round(l/2));m.rotate(h.angle);m.drawImage(d,q.x,q.y,a,l,Math.round(-j/2),Math.round(-g/2),j,g);m.restore()}else{m.drawImage(d,q.x,q.y,a,l,Math.round(p),Math.round(o),j,g)}m.globalAlpha=1};i.destroy=function(){i.offset.destroy();i.offset=null;d.destroy();d=null;h=null;i.destroy();i=null};i.changeSize=function(m){j=m*a;g=m*l};i.setWidth=function(m){j=m};i.setHeight=function(m){g=m};i.setImage=function(n,m,o){d=n;a=m;l=o};i.setAlpha=function(m){e=m};i.getWidth=function(){return j};i.getHeight=function(){return g};i.getOriginalWidth=function(){return a};i.getOriginalHeight=function(){return l};i.getAlpha=function(){return e};return i};FM.textRendererComponent=function(f,e){var d=FM.component(FM.componentTypes.RENDERER,e),c=e.components[FM.componentTypes.SPATIAL],b=50,a=50;if(!c&&FM.parameters.debug){console.log("ERROR: No spatial component was added and you need one for rendering.")}e.addComponent(d);d.text=f;d.fillStyle="#fff";d.font="30px sans-serif";d.textBaseline="middle";d.setFormat=function(h,g,i){d.fillStyle=h;d.font=g;d.textBaseline=i};d.draw=function(g,h){var j=h.x,i=h.y;j-=g.xOffset*e.scrollFactor.x;i-=g.yOffset*e.scrollFactor.y;g.fillStyle=d.fillStyle;g.font=d.font;g.textBaseline=d.textBaseline;g.fillText(d.text,Math.round(j),Math.round(i))};d.destroy=function(){c=null;d.text=null;d.fillStyle=null;d.font=null;d.textBaseline=null;d.destroy();d=null};d.getWidth=function(){return b};d.getHeight=function(){return a};return d};FM.audioComponent=function(c){var b=FM.component(FM.componentTypes.SOUND,c),a=[],d=function(e){e.currentTime=0;e.play()};c.addComponent(b);b.play=function(g,j,f){var h,k,e=false;for(h=0;h<a.length;h=h+1){k=a[h];if(k.getName()===g){e=true;k.volume=j;if(f){k.addEventListener("ended",function(){if(window.chrome){this.load(d)}else{this.currentTime=0;this.play()}},false)}if(window.chrome){k.load(d)}else{k.play()}}}if(!e){if(FM.parameters.debug){console.log("WARNING: you're trying to play a sound that does not exist.")}}};b.pause=function(e){var f,g;for(f=0;f<a.length;f=f+1){g=a[f];if(g.getName()===e){g.pause()}}};b.addSound=function(e){a.push(e)};b.destroy=function(){var e;for(e=0;e<a.length;e=e+1){a[e].destroy()}a=null;b.destroy();b=null};b.isPlaying=function(e){var f,g;for(f=0;f<a.length;f=f+1){g=a[f];if(g.getName()===e){return !g.paused}}};b.getSoundByName=function(e){var f,g;for(f=0;f<a.length;f=f+1){g=a[f];if(g.getName()===e){return g}}return null};return b};FM.spatialComponent=function(b,a,d){var c=FM.component(FM.componentTypes.SPATIAL,d);c.position=FM.vector(b,a);c.previous=FM.vector(b,a);c.angle=0;d.addComponent(c);c.destroy=function(){c.position=null;c.previous=null;c.destroy();c=null};return c};